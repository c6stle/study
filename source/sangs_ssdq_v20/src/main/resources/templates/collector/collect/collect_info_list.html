<!--
	Description : 수집목록관리 리스트

	Modification Information
	수정일				수정자			수정내용
	-------		-----------------------------------
	2016.01.22		조남훈

-->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/mainLayout">
<head>
	<th:block th:replace="fragments/head_inc :: head_inc" />

<style>
	.guide_box {
		margin-bottom: 15px;
	    padding: 12px;
	    border: 1px solid #d6d5c9;
	    background-color: #fefbde;
	}
</style>

<script type="text/javascript">

$(document).ready(function(){

	// form에서 엔터로 검색시 1페이지로 셋팅하게 한다.
	$('#apiNm').keydown(function(e) {
		if(e.keyCode == 13) {
			fnSearch();
		}
	});

	// 수집정보그룹
	new CodeBinder()
	.setSqlCode("ct_collect_info.selectMetaGroupListForCombo", "apiGroupCd", "select")
	.load();
	// 공통 > 데이터구분
	new CodeBinder()
	.setCommonCode("APIDATATY", "apiDataTyCd", "select")
	.load();
	// 공통 > 서비스구분
	new CodeBinder()
	.setCommonCode("APISVCTY", "apiSvcTyCd", "select")
	.load();
	// 공통 > 수집구분
	new CodeBinder()
	.setCommonCode("APICOLCTTY", "apiColctTyCd", "select")
	.load();

	fnSearch();

});

//조회
function fnSearch(pageNum) {
	if(!pageNum) {
		pageNum = 1;
	}

	$('#listType').val("LIST");

	$.ajax({
		url: "/json/collectInfo/getMetaList"
		, method : "POST"
		, contentType: 'application/json'
		, data: JSON.stringify({
			pageNum: pageNum
			, apiGroupCd: $("#apiGroupCd").val()
			, apiNm: fnUnderbarChgVar($("#apiNm").val())
			, apiDataTyCd: $("#apiDataTyCd").val()
			, apiSvcTyCd: $("#apiSvcTyCd").val()
			, rcptnYn: $("#rcptnYn").val()
			, addrYn: $("#addrYn").val()
			, rcptnYn: $("#rcptnYn").val()
			, apiTrsmrcvStrtYn : $("#apiTrsmrcvStrtYn").val()
			, apiColctTyCd: $("#apiColctTyCd").val()
		})
		, success: function(data){
			var list = data.resultList;
			if (list) {
				fnBindTableValue("metaListTable", list, data.pagingInfo);

				fnSetPaging("dv_paging", data.pagingInfo);
			}
		}
	});
}

// 수집관리 페이지 이동
function popMetaMng(apiCd, tabIdx, params) {
	var tIdx = "tab01";
	if (tabIdx != "") tIdx = tabIdx;

	if (apiCd != "") {
		var tUrl = "";
		if (tIdx == "tab01") {tUrl = "/collector/collect/collect_info_form";}
		else if (tIdx == "tab02") {tUrl = "/collector/collect/collect_rcptn_list";}
		else if (tIdx == "tab03") {tUrl = "/collector/collect/collect_address_list";}
		else if (tIdx == "tab04") {tUrl = "/collector/collect/collect_setting_form";}
		else if (tIdx == "tab05") {
			if (params != "") {tUrl = "/collector/collect/collect_log_data_list";}
			else {tUrl = "/collector/collect/collect_log_list";}
		}
		else if (tIdx == "tab06") {tUrl = "/collector/collect/collect_data_list";}
		else if (tIdx == "tab07") {tUrl = "/mngr/metaMng/metaMngImportForm";}

		tUrl += "?tIdx=" + tIdx + "&apiCd=" + apiCd + "&" + params;
	} else  {
		tUrl = "/collector/collect/collect_info_form";
	}

	/*
	var w = screen.availWidth;
	var h = screen.availHeight;
	console.log("availHeight : " + h);
	var popMetaMngWin = window.open(tUrl, "popMetaMngWin", "toolbar=no, location=no, directories=no, status=yes, menubar=no, scrollbars=yes, resizable=yes, width=" + (w * 0.79) + ", height=" + (h * 0.75) + ", top=-1, left=-1");
	console.log(popMetaMngWin.top);
	popMetaMngWin.focus();
	*/

	location.href = tUrl;
}

/* 수집데이터 등록에 필요한 함수 */


function fnShowModalAndCodeBind(popId) {
	// 수집그룹
	if( !($("#reg_apiGroupCd").find("option").length > 1) ) {
		new CodeBinder().getSelectForLoadedCode("ct_collect_info.selectMetaGroupListForCombo", "reg_apiGroupCd");
	}
	// 공통 > 데이터구분
	if( !($("#reg_cmmnApiDataTyCd").find("option").length > 1) ) {
		new CodeBinder().getSelectForLoadedCode("APIDATATY", "reg_cmmnApiDataTyCd");
	}
	// 공통 > 서비스구분
	if( !($("#reg_cmmnApiSrvcTyCd").find("option").length > 1) ) {
		new CodeBinder().getSelectForLoadedCode("APISVCTY", "reg_cmmnApiSrvcTyCd");
	}
	fnShowModal(popId);
}

//등록 실행
function doRegSave() {

	var frm = document.frm;

	//유효성 체크 시작
	//수집코드
	if (!fnCheckValid("#reg_apiCd", "수집코드")) {
		return false;
	}
	//중복체크

	var pmode = $("#reg_pmode").val();
	if( pmode == 'INS') {
		if($('#reg_duplCheckFlag').val() == '') {
			alert("수집코드 중복 체크는 필수입니다.");
			$("#reg_apiCd").focus();
			return;
		}

		if($('#reg_duplCheckFlag').val() == 'N') {
			alert("중복된 수집코드 입니다.");
			$("#reg_apiCd").focus();
			return;
		}
	}
	//수집그룹
	if (!fnCheckValid("#reg_apiGroupCd", "수집그룹")) {
		return false;
	}
	//수집명
	if (!fnCheckValid("#reg_apiNm", "수집명")) {
		return false;
	}
	//데이터구분
	if (!fnCheckValid("#reg_cmmnApiDataTyCd", "데이터구분")) {
		return false;
	}
	//사용여부
	if (!fnCheckValid("#reg_useYn", "사용여부")) {
		return false;
	}
	if(confirm("입력한 정보를 저장하겠습니까?")){
		var _frm = document.frm;
		//_frm.submit();
		var _frmArr = $(_frm).serializeArray();

		console.log($(_frm).serialize());
		console.log($(_frm).serializeArray());

		var jsonObj = fnArrayToJson(_frmArr);
		jsonObj['apiCd'] = jsonObj['apiCd'].toUpperCase();
		jsonObj['pmode'] = 'INS';

		$.ajax({
			url: "/json/collectInfo/saveMetaMngInfoInfo"
			, contentType: "application/json"
			, method: "POST"
			, data: JSON.stringify(jsonObj)
			, success: function(data) {
				var resultCd = data.resultCd;
				if (resultCd == "OK") {
					alert("처리가 완료되었습니다.");
					fnCloseModal('metamng_info_form_modal');
					fnSearch(1);
				}
			}
		})

	}
}
// 배열(form.serializeArray)을 JSON 으로 변경
function fnArrayToJson(array) {
	var jsonObj = {};

	$.each(array, function(idx, value){
		jsonObj[value.name] = value.value;
	}); // end each

	return jsonObj;
}

//콘텐츠 코드 중복 체크
function fnCheckDuplCode() {
	$('#reg_apiCd').val($.trim($('#reg_apiCd').val())); // 공백제거
	if (!fnCheckValid("#reg_apiCd", "수집코드")) {
		return false;
	}

	// ajax call
	$.get("/json/collectInfo/checkDuplApiCode?apiCd=" + $('#reg_apiCd').val() + "&" + $('#mCode').val() , fnCheckDuplCodeCallback);

}
function fnCheckDuplCodeCallback(data) {

	var resultCd = data.resultCd;
	if(resultCd == 'OK') {
		alert("사용가능한 코드입니다.");
		$('#reg_duplCheckFlag').val("Y");
	} else if(resultCd == 'DUPL') {
		alert("이미 사용중인 코드입니다.");
		$('#reg_duplCheckFlag').val("N");
		$('#reg_apiCd').focus();
	} else {
		$('#reg_duplCheckFlag').val("N");
		$('#reg_apiCd').focus();
	}
}
//수집코드가 바뀔때 중복체크 초기화
function cntntsCodeChange(){
	$('#reg_duplCheckFlag').val('');
}
//서비스 프로그램명 호출
function fnMatchCode(code) {
	// ajax call
	//$.get("/mngr/metaMng/metaMngInfoAjax?cmmnCode=" + code, fnMatchCodeCallback);

	//ajaxSubmit("/mngr/metaMng/metaMngInfoAjax", {cmmnCode : code}, "json", eval("fnMatchCodeCallback"));

	$.ajax({
		url: "/json/collectInfo/selectCmmnCodeDetailInfo"
		, method : "POST"
		, contentType: 'application/json'
		, data: JSON.stringify({
			code: code
		})
		, success: function(data){
			var cdDc = data.cdDc;

			//fnMatchCodeCallback(cdDc);
			$("#apiProgrmExcNm").val(cdDc);
		}
	})

}

//속성정보 onoff
function toggleInfoFunc(code) {
	if (code == "") {
		$("#apiProgrmExcNm").val("");
		return false;
	}

	if(code=="SS01" || code=="SS03") { // API, SNS 일 때,
		$("#tab").show();
		$("#tab").find("input").each(function() {
			$(this).attr("disabled", false);
		});
	}else {
		$("#tab").hide();
		$("#tab").find("input").each(function() {
			$(this).attr("disabled", true);
		});
		$("#apiProgrmExcNm").val("");
	}
	if(code=="SS04") { //크롤러 일 때,
		$(".fade_row").attr("rowspan", "2");
		$("#apiProgrmCallNm_td").show();
	}else {
		$(".fade_row").attr("rowspan", "1");
		$("#apiProgrmCallNm_td").hide();
	}
	if(code=="SS05"){ //File
		$("#gu").show();
		$("#columnSptrt").val("|");
		$("#headerSptrt").val("1");
	}else{
		$("#gu").hide();
		$("#columnSptrt").val("");
		$("#headerSptrt").val("");
	}

	fnMatchCode(code);
}
</script>
</head>
<body>
<div id="wrap">
	<div class="container">
		<div id="content">
			<div class="page_info_area">
				<div class="left">
					<div class="title_area">
						<p>수집목록관리</p>
						<a href="#" class="reload_btn" title="새로고침">새로고침</a>
					</div>
				</div>
				<div class="right">
					<div class="button_area">
						<button class="btn" onclick="fnShowModalAndCodeBind('metamng_info_form_modal')" title="신규등록">신규등록</button>
						<button class="btn" title="조회" onclick="fnSearch();">조회</button>
						<!-- <a href="/collector/collect/collect_info_form"> -->
						<!-- </a> -->
					</div>
				</div>
			</div><!-- page_info_area -->

			<div class="content_area">
				<div class="division20">
					<input type="hidden" name="listType" id="listType" value="" />
					<!-- 검색 영역 -->
					<div class="search_wrap card">
						<table class="search fixed">
							<colgroup>
								<col style="width: 10%;" />
								<col style="width: 40%;" />
								<col style="width: 10%;" />
								<col style="width: 40%;" />
							</colgroup>
							<tbody>
								<tr>
									<th scope="row"><label for="apiGroupCd">수집그룹</label></th>
									<td>
										<select class="in_w95" name="apiGroupCd" id="apiGroupCd">
											<option value="">전체</option>
	                           			</select>
									</td>
									<th scope="row"><label for="apiNm">수집명</label></th>
									<td>
										<input class="in_w100" type="text" name="apiNm" id="apiNm" title="수집명" />
									</td>
								</tr>
								<tr>
									<th scope="row"><label for="apiDataTyCd">데이터구분</label></th>
									<td>
										<select class="in_w95" name="apiDataTyCd" id="apiDataTyCd">
											<option value="">전체</option>
	                           			</select>
									</td>
									<th scope="row"><label for="apiSvcTyCd">서비스구분</label></th>
									<td>
										<select name="apiSvcTyCd" id="apiSvcTyCd">
											<option value="">전체</option>
	                           			</select>
									</td>
								</tr>
								<tr>
									<th scope="row"><label for="rcptnYn">전문여부</label></th>
									<td>
										<select class="in_w95" name="rcptnYn" id="rcptnYn">
											<option value="" th:selected="${rcptnYn eq ''}" >전체</option>
											<option value="Y" th:selected="${rcptnYn eq 'Y'}" >Y</option>
											<option value="N" th:selected="${rcptnYn eq 'N'}" >N</option>
	                           			</select>
									</td>
									<th scope="row"><label for="addrYn">주소여부</label></th>
									<td>
										<select name="addrYn" id="addrYn">
											<option value="" th:selected="${addrYn eq ''}" >전체</option>
											<option value="Y" th:selected="${addrYn eq 'Y'}" >Y</option>
											<option value="N" th:selected="${addrYn eq 'N'}" >N</option>
	                           			</select>
									</td>
								</tr>
								<tr>
									<th scope="row"><label for="apiTrsmrcvStrtYn">수집여부</label></th>
									<td>
										<select class="in_w95" name="apiTrsmrcvStrtYn" id="apiTrsmrcvStrtYn">
											<option value="" th:selected="${apiTrsmrcvStrtYn eq ''}" >전체</option>
											<option value="Y" th:selected="${apiTrsmrcvStrtYn eq 'Y'}" >Y</option>
											<option value="N" th:selected="${apiTrsmrcvStrtYn eq 'N'}" >N</option>
	                           			</select>
									</td>
									<th scope="row"><label for="apiColctTyCd">수집구분</label></th>
									<td>
										<select name="apiColctTyCd" id="apiColctTyCd">
											<option value="">전체</option>
	                           			</select>
									</td>
								</tr>
							</tbody>
						</table>
					</div><!-- search_wrap -->
					<!-- //검색 영역 -->
				</div><!-- division20 -->

				<div class="division20">
					<div class="card">
						<table class="list fixed" id="metaListTable">
							<caption>조회된 테이블</caption>
							<colgroup>
								<col style="width: 10%;" />
		                        <col style="width: 10%;" />
		                        <col style="width: 10%;" />
		                        <col style="width: 10%;" />
		                        <col style="width: 10%;" />
		                        <col style="width: 10%;" />
		                        <col style="width: 10%;" />
		                        <col style="width: 10%;" />
		                        <col style="width: 10%;" />
		                        <col style="width: 10%;" />
							</colgroup>
							<thead>
								<tr>
									 <th scope="col">수집코드</th>
		                             <th scope="col">수집그룹</th>
		                             <th scope="col">수집명</th>
		                             <th scope="col">데이터구분</th>
		                             <th scope="col">서비스구분</th>
		                             <th scope="col">전문여부</th>
		                             <th scope="col">주소건수</th>
		                             <th scope="col">수집여부</th>
		                             <th scope="col">수집구분</th>
		                             <th scope="col"></th>
								</tr>
							</thead>
							<tbody>
								<tr class="fwk_templete_row">
									 <td>#{apiCd}</td>
		                             <td>#{apiGroupNm}</td>
		                             <td>#{apiNm}</td>
		                             <td>#{cmmnApiDataTyNm}</td>
		                             <td>#{cmmnApiSrvcTyNm}</td>
		                             <td>#{rcptnYn}</td>
		                             <td>#{addrCnt}</td>
		                             <td>#{apiTrsmrcvStrtYn}</td>
		                             <td>#fn{fnGetNullChk('#{cmmnApiClctTyNm}')}</td>
		                             <td>
		                             <th:block th:if="${params.DETAIL_TYPE} eq 'INFO'">
		                             	<a href="#" onclick="popMetaMng('#{apiCd}', 'tab01', '');" class="btn sm" style="color:black">상세정보</a>
		                             </th:block>
		                             <th:block th:unless="${params.DETAIL_TYPE} eq 'INFO'">
		                             	<a href="#" onclick="popMetaMng('#{apiCd}', 'tab06', '');" class="btn sm" style="color:black">상세정보</a>
		                             </th:block>
		                             </td>
								</tr>
							</tbody>
						</table>

						<div class="marginb25"></div>
						<!-- pagination_area -->
						<div class="pagination_area marginb25" id="dv_paging"></div>
						<!--// pagination_area -->
					</div> <!-- //card -->
				</div><!-- division20 -->
			</div> <!-- //content_area -->
		</div>
	</div>
</div>

<div class="popup layer" id="metamng_info_form_modal" style="width:1300px; height:870px;">
	<div class="pop_header">
		<p class="title">데이터 수집등록</p>
		<button class="btn_ic btn_pop_close" onclick="fnCloseModal('metamng_info_form_modal'); return false;">닫기</button>
	</div>
	<div class="pop_content">
		<div class="tbl_top right">
			<div class="btn_wrap">
				<button type="button" class="btn sm" onclick="doRegSave();">저장</button>
			</div>
		</div>
		<form name="frm" id="frm"  method="post">
			<input type="hidden" name="pmode" id="reg_pmode" value="INS" />
			<!-- <input type="hidden" name="tIdx" id="tIdx" th:value="${params.tIdx}"/> -->
			<input type="hidden" name="duplCheckFlag" id="reg_duplCheckFlag" value="" />

			<div class="view_wrap" style="min-height:200px;">
				<div class="tbl_top">
					<p class="tit v2">기본정보</p>
				</div>
				<div class="guide_box">
					<p class="guide_txt">
						<b>&#183;</b> ‘수집코드’ : 수집목록을 신규로 생성할 때 자동 생성되며, 각 API를 구분하는 코드이다.<br>
						<b>&#183;</b> ‘수집그룹’ : 수집그룹관리에서 관리되는 그룹목록을 나타내며 등록하고자 하는 데이터를 제공하는 그룹을 선택한다.<br>
						<b>&#183;</b> ‘수집명’ : 수집할 데이터명을 작성한다.<br>
						<b>&#183;</b> ‘서비스구분’ : 데이터 수집에 이용할 서비스를 선택하면 그에 따른 수집 프로그램명이 자동 생성된다.<br>
						<b>&#183;</b> ‘데이터구분’ : 선택하여 수집할 데이터의 유형을 결정한다.<br>
					</p>
				</div>
				<table class="view" id="reg_metaInfoTable">
					<caption>테이블</caption>
					<colgroup>
						<col style="width: 13%;" />
						<col style="width: 37%;" />
						<col style="width: 13%;" />
						<col style="width: 37%;" />
					</colgroup>
					<tbody>
						<tr>
							<th scope="row"><span class="star">*</span> 수집코드</th>
							<td>
								<input type="text" id="reg_apiCd" name="apiCd" title="수집코드" maxlength="15" placeholder="15자 이내로 입력해주세요" onkeyup="inputCheck(this)" onchange="cntntsCodeChange();" style="width:80%; text-transform: uppercase;"/>
								<button class="btn sm" onclick="fnCheckDuplCode(); return false;">중복체크</a>
							</td>
							<th scope="row"><span class="star">*</span> 수집그룹</th>
							<td>
								<select name="apiGroupCd" id="reg_apiGroupCd">
									<option value="">--선택--</option>
                        		</select>
							</td>
						</tr>
						<tr>
							<th scope="row"><span class="star">*</span> 수집명</th>
							<td>
								<input type="text" name="apiNm" id="reg_apiNm" title="수집명" value="" style="width:80%;" maxlength="100" placeholder="100자 이내로 입력해주세요" />
							</td>
							<th scope="row">저장소아이디</th>
							<td>
								<input type="text" name="apiStrgTblNm" id="apiStrgTblNm" title="저장소아이디" style="width:50%;" readOnly="true" />
								* 신규등록시 자동생성
							</td>
						</tr>
						<tr>
							<th scope="row">설명</th>
							<td colspan="3">
								<textarea name="apiCn" id="apiCn" rows="5" style="width:100%; height:50px;" maxlength="500" placeholder="500자 이내로 입력해주세요"></textarea>
							</td>
						</tr>
						<tr>
							<th scope="row" class="fade_row">서비스구분</th>
							<td class="fade_row">
								<select name="cmmnApiSrvcTyCd" id="reg_cmmnApiSrvcTyCd" onchange="toggleInfoFunc(this.value);">
									<option value="">--선택--</option>
	                         	</select>
							</td>
							<th scope="row">수집프로그램명</th>
							<td>
								<input type="text" name="apiProgrmExcNm" id="apiProgrmExcNm" title="프로그램명" readonly="readonly"/>
							</td>
						</tr>
						<tr id="apiProgrmCallNm_td" style="display:none;">
							<th scope="row">스크립트명</th>
							<td>
								<p>※ 호출 shell 스크립트명 기재</p>
								<textarea name="apiProgrmCallNm" id="apiProgrmCallNm" style="width:90%; margin-top:5px;" rows="3"></textarea>
							</td>
						</tr>
						<tr>
							<th scope="row"><span class="star">*</span> 데이터구분</th>
							<td>
								<select name="cmmnApiDataTyCd" id="reg_cmmnApiDataTyCd">
									<option value="">--선택--</option>
								</select>
							</td>
							<th scope="row"><span class="star">*</span> 사용여부</th>
							<td>
								<select name="useYn" id="reg_useYn">
									<option value="">--선택--</option>
									<option value="Y">Y</option>
									<option value="N">N</option>
	                         	</select>
							</td>
						</tr>
						<tr id="gu" style="display: none;">
							<th scope="row"><span class="star">*</span> 컬럼구분자</th>
							<td>
								<input type="text" name="columnSptrt" id="columnSptrt" title="컬럼구분" style="width:200px;" />
							</td>
							<th scope="row"><span class="star">*</span> 행구분자</th>
							<td>
								<input type="text" name="headerSptrt" id="headerSptrt" title="헤더구분" style="width:200px;" />
							</td>
						</tr>
					</tbody>
				</table>
			</div> <!-- //table_wrap -->

			<div id="tab" th:style="${resultMap != null && resultMap.cmmnApiSrvcTyCd != 'SS01' && resultMap.cmmnApiSrvcTyCd != 'SS03' ? style='display:none;' : ''}">
				<div class="view_wrap" style="min-height:150px;">
					<div class="tbl_top">
						<p class="tit v2">속성정보</p>
					</div>
					<div class="guide_box">
						<p>
							<b>&#183;</b> ‘인증키’ : 오픈데이터(API, SNS)를 수집할 경우 데이터를 제공하는 포털에서 데이터를 수집하기 위한 인증키명과 인증키값을 생성하여 입력한다.<br>
							<b>&#183;</b> 나머지 속성정보 : 제공받은 API 내에 설정되어 있는 헤더값이나 코드명을 입력한다.<br>
						</p>
					</div>
					<table class="view" id="reg_metaInfoDetailTable">
						<caption>테이블</caption>
						<colgroup>
							<col style="width: 13%;" />
							<col style="width: 37%;" />
							<col style="width: 13%;" />
							<col style="width: 37%;" />
						</colgroup>
						<tbody>
							<tr>
								<th scope="row">인증키명</th>
								<td>
									<input type="text" name="apiCertNm" id="apiCertNm" title="인증키명" maxlength="200" />
								</td>
								<th scope="row">인증키값</th>
								<td>
									<input type="text" name="apiCertValue" id="apiCertValue" title="인증키값" maxlength="200"/>
								</td>
							</tr>
							<tr>
								<th scope="row">수집 HEADER 명</th>
								<td>
									<input type="text" name="apiMetaInfoNm" id="apiMetaInfoNm" title="수집 HEADER 명" maxlength="200" />
								</td>
								<th scope="row">수집 데이터 명</th>
								<td>
									<input type="text" name="apiMetaDataNm" id="apiMetaDataNm" title="수집 데이터 명" maxlength="200" />
								</td>
							</tr>
							<tr>
								<th scope="row">수집 결과코드 명</th>
								<td>
									<input type="text" name="apiTrsmrcvResultCdNm" id="apiTrsmrcvResultCdNm" title="수집 결과코드 명" maxlength="200" />
								</td>
								<th scope="row">수집 결과내용 명</th>
								<td>
									<input type="text" name="apiTrsmrcvResultCnNm" id="apiTrsmrcvResultCnNm" title="수집 결과내용 명" maxlength="200" />
								</td>
							</tr>
						</tbody>
					</table>
				</div> <!-- //table_wrap -->
			</div>
		</form>
	</div>
</div>

</body>
</html>
