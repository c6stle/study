<!--
	Description : 수집통합관리 > 수집정보 등록 양식

	Modification Information
	수정일				수정자			수정내용
	-------		-----------------------------------
	2016.01.25		송호현

-->

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/mainLayout">
<head>
	<th:block th:replace="fragments/head_inc :: head_inc" />

<style>
	.guide_box {
		margin-bottom: 15px;
	    padding: 12px;
	    border: 1px solid #d6d5c9;
	    background-color: #fefbde;
	}
</style>
</head>
<body>
	<div id="wrap">
		<div class="container">
			<div id="content">
				<div class="page_info_area">
					<div class="left">
						<div class="title_area">
							<p>수집통합관리</p>
							<a href="#" class="reload_btn" title="새로고침">새로고침</a>
						</div>
					</div>
					<div class="right">
						<div class="btn_wrap">
							<button type="button" class="btn" onclick="fnGoMetaList();">목록</button>
						</div>
					</div>
				</div><!-- page_info_area -->

				<div class="content_area">
					<th:block th:replace="collector/inc/metamng_tab_inc :: metamng_tab_inc" />
					<div class="division20">
						<form name="frm" id="frm"  method="post">
							<input type="hidden" name="pmode" id="pmode" th:value="${pmode}" />
							<input type="hidden" name="tIdx" id="tIdx" th:value="${params.tIdx}"/>
							<input type="hidden" name="duplCheckFlag" id="duplCheckFlag" value="" />
							<div class="tbl_top">
								<p class="tit v2">기본정보</p>
							</div>
							<div class="guide_box">
								<p class="guide_txt">
									<b>&#183;</b> ‘수집코드’ : 수집목록을 신규로 생성할 때 자동 생성되며, 각 API를 구분하는 코드이다.<br>
									<b>&#183;</b> ‘수집그룹’ : 수집그룹관리에서 관리되는 그룹목록을 나타내며 등록하고자 하는 데이터를 제공하는 그룹을 선택한다.<br>
									<b>&#183;</b> ‘수집명’ : 수집할 데이터명을 작성한다.<br>
									<b>&#183;</b> ‘서비스구분’ : 데이터 수집에 이용할 서비스를 선택하면 그에 따른 수집 프로그램명이 자동 생성된다.<br>
									<b>&#183;</b> ‘데이터구분’ : 선택하여 수집할 데이터의 유형을 결정한다.<br>
								</p>
							</div>
							<div class="view_wrap" style="min-height:200px;">
								<table class="view" id="metaInfoTable">
									<caption>테이블</caption>
									<colgroup>
										<col style="width: 10%;" />
										<col style="width: 40%;" />
										<col style="width: 10%;" />
										<col style="width: 40%;" />
									</colgroup>
									<tbody>
										<tr>
											<th scope="row"><span class="star">*</span> 수집코드</th>
											<td>
												<th:block th:if="${pmode == 'UPD'}">
													<input type="hidden" name="apiCd" id="apiCd" th:value="${resultMap.apiCd}" onkeyup="inputCheck(this)"/>
													[[${resultMap.apiCd}]]
												</th:block>
												<th:block th:unless="${pmode == 'UPD'}">
													<input type="text" id="apiCd" name="apiCd" title="수집코드" maxlength="20" th:value="${params.metaCd}" onkeyup="inputCheck(this)" onchange="javascript:cntntsCodeChange()" style="width:80%"/>
													<!--<a href="#" onclick="javascript:fnCheckDuplCode();" class="btn sky">중복체크</a>-->
													<button class="btn sm" onclick="javascript:fnCheckDuplCode(); return false;">중복체크</a>
												</th:block>
											</td>
											<th scope="row"><span class="star">*</span> 수집그룹</th>
											<td>
												<select name="apiGroupCd" id="apiGroupCd">
													<option value="">--선택--</option>
				                         		</select>
											</td>
										</tr>
										<tr>
											<th scope="row"><span class="star">*</span> 수집명</th>
											<td>
												<input type="text" name="apiNm" id="apiNm" title="수집명" th:value="${resultMap != null ? resultMap.apiNm : ''}" style="width:80%;"/>
											</td>
											<th scope="row">저장소아이디</th>
											<td>
												<th:if="${params.apiCd != '' && params.apiCd != null}">
													<input type="text" name="apiStrgTblNm" id="apiStrgTblNm" title="저장소아이디" th:value="${resultMap != null ? resultMap.apiStrgTblNm : ''}" style="width:50%;" readOnly="true" />
												</th:if>
												<th:unless="${params.apiCd != '' && params.apiCd != null}">
													<th:text="* 신규등록시 자동생성"/>
												</th:unless>
											</td>
										</tr>
										<tr>
											<th scope="row">설명</th>
											<td colspan="3">
												<textarea name="apiCn" id="apiCn" rows="5" style="width:100%;">[[${resultMap != null ? resultMap.apiCn : ''}]]</textarea>
											</td>
										</tr>
										<tr>
											<th scope="row" class="fade_row">서비스구분</th>
											<td class="fade_row">
												<select name="cmmnApiSrvcTyCd" id="cmmnApiSrvcTyCd" onchange="toggleInfoFunc(this.value);">
													<option value="">--선택--</option>
				                          		</select>
											</td>
											<th scope="row">수집프로그램명</th>
											<td>
												<input type="text" name="apiProgrmExcNm" id="apiProgrmExcNm" title="프로그램명" th:value="${resultMap != null ? resultMap.apiProgrmExcNm : ''}" style="width:400px;" readonly="readonly"/>
											</td>
										</tr>
										<tr id="apiProgrmCallNm_td" style="display:none;">
											<th scope="row">스크립트명</th>
											<td>
												<p>※ 호출 shell 스크립트명 기재</p>
												<textarea name="apiProgrmCallNm" id="apiProgrmCallNm" style="width:90%; margin-top:5px;" rows="3">[[${resultMap != null ? resultMap.apiProgrmCallNm : ''}]]</textarea>
											</td>
										</tr>
										<tr>
											<th scope="row"><span class="star">*</span> 데이터구분</th>
											<td>
												<select name="cmmnApiDataTyCd" id="cmmnApiDataTyCd">
													<option value="">--선택--</option>
												</select>
											</td>
											<th scope="row"><span class="star">*</span> 사용여부</th>
											<td>
												<select name="useYn" id="useYn">
													<option value="" th:selected="${resultMap != null && resultMap.useYn == ''}">--선택--</option>
													<option value="Y" th:selected="${resultMap != null && resultMap.useYn == 'Y'}">Y</option>
													<option value="N" th:selected="${resultMap != null && resultMap.useYn == 'N'}">N</option>
				                          		</select>
											</td>
										</tr>
										<tr id="gu" style="display: none;">
											<th scope="row"><span class="star">*</span> 컬럼구분자</th>
											<td>
												<input type="text" name="columnSptrt" id="columnSptrt" title="컬럼구분" <!--/*th:value="${resultMap.columnSptrt}"*/--> style="width:200px;" />
											</td>
											<th scope="row"><span class="star">*</span> 행구분자</th>
											<td>
												<input type="text" name="headerSptrt" id="headerSptrt" title="헤더구분" <!--/*th:value="${resultMap.headerSptrt}"*/--> style="width:200px;" />
											</td>
										</tr>
									</tbody>
								</table>
							</div> <!-- //table_wrap -->

							<div id="tab" th:style="${resultMap?.cmmnApiSrvcTyCd != 'SS01' && resultMap?.cmmnApiSrvcTyCd != 'SS03' ? 'display:none' : '' }">
								<div class="tbl_top">
									<p class="tit v2">속성정보</p>
								</div>
								<div class="guide_box">
									<p>
										<b>&#183;</b> ‘인증키’ : 오픈데이터(API, SNS)를 수집할 경우 데이터를 제공하는 포털에서 데이터를 수집하기 위한 인증키명과 인증키값을 생성하여 입력한다.<br>
										<b>&#183;</b> 나머지 속성정보 : 제공받은 API 내에 설정되어 있는 헤더값이나 코드명을 입력한다.<br>
									</p>
								</div>

								<div class="view_wrap" style="min-height:150px;">
									<table class="view" id="metaInfoDetailTable">
										<caption>테이블</caption>
										<colgroup>
											<col style="width: 10%;" />
											<col style="width: 40%;" />
											<col style="width: 10%;" />
											<col style="width: 40%;" />
										</colgroup>
										<tbody>
											<tr>
												<th scope="row">인증키명</th>
												<td>
													<input type="text" name="apiCertNm" id="apiCertNm" title="인증키명" th:value="${resultMap != null ? resultMap.apiCertNm : ''}" style="width:200px;"/>
												</td>
												<th scope="row">인증키값</th>
												<td>
													<input type="text" name="apiCertValue" id="apiCertValue" title="인증키값" th:value="${resultMap != null ? resultMap.apiCertValue : ''}" style="width:400px;"/>
												</td>
											</tr>
											<tr>
												<th scope="row">수집 HEADER 명</th>
												<td>
													<input type="text" name="apiMetaInfoNm" id="apiMetaInfoNm" title="수집 HEADER 명" th:value="${resultMap != null ? resultMap.apiMetaInfoNm : ''}" style="width:200px;"/>
												</td>
												<th scope="row">수집 데이터 명</th>
												<td>
													<input type="text" name="apiMetaDataNm" id="apiMetaDataNm" title="수집 데이터 명" th:value="${resultMap != null ? resultMap.apiMetaDataNm : ''}" style="width:200px;"/>
												</td>
											</tr>
											<tr>
												<th scope="row">수집 결과코드 명</th>
												<td>
													<input type="text" name="apiTrsmrcvResultCdNm" id="apiTrsmrcvResultCdNm" title="수집 결과코드 명" th:value="${resultMap != null ? resultMap.apiTrsmrcvResultCdNm : ''}" style="width:200px;"/>
												</td>
												<th scope="row">수집 결과내용 명</th>
												<td>
													<input type="text" name="apiTrsmrcvResultCnNm" id="apiTrsmrcvResultCnNm" title="수집 결과내용 명" th:value="${resultMap != null ? resultMap.apiTrsmrcvResultCnNm : ''}" style="width:200px;"/>
												</td>
											</tr>
										</tbody>
									</table>
								</div> <!-- //table_wrap -->
							</div>

							<div class="btn_wrap">
								<div class="left">

								</div>
								<div class="right">
									<button type="button" class="btn" onclick="doSave();">저장</button>
								</div>
							</div>
						</form>
					</div><!-- //division20 -->
				</div> <!-- //content_area -->
			</div> <!-- //content -->
		</div> <!-- //container -->
	</div> <!-- //wrap -->

<script type="text/javascript" th:inline="javascript">
$(document).ready(function() {

	// 수집그룹
	new CodeBinder()
	.setSqlCode("ct_collect_info.selectMetaGroupListForCombo", "apiGroupCd", "select", /*[[${resultMap?.apiGroupCd}]]*/"")
	.load();
	// 공통 > 데이터구분
	new CodeBinder()
	.setCommonCode("APIDATATY", "cmmnApiDataTyCd", "select", /*[[${resultMap?.cmmnApiDataTyCd}]]*/"")
	.load();
	// 공통 > 서비스구분
	new CodeBinder()
	.setCommonCode("APISVCTY", "cmmnApiSrvcTyCd", "select", /*[[${resultMap?.cmmnApiSrvcTyCd}]]*/"")
	.load();
	var cmmnApiSrvcTyCd = /*[[ ${resultMap?.cmmnApiSrvcTyCd} ]]*/"";

	if (cmmnApiSrvcTyCd == 'SS04') {
		$(".fade_row").attr("rowspan", "2");
		$("#apiProgrmCallNm_td").show();
	}

});
//등록 실행
function doSave() {	var frm = document.frm;
	// 유효성 체크 시작
	//수집코드
	if (!fnCheckValid("#apiCd", "수집코드")) {
		return false;
	}
	//중복체크
	var pmode = /*[[ ${pmode} ]]*/'';
	if( pmode == 'INS') {
		if($('#duplCheckFlag').val() == '') {
			alert("수집코드 중복 체크는 필수입니다.");
			$("#apiCd").focus();
			return;
		}

		if($('#duplCheckFlag').val() == 'N') {
			alert("중복된 수집코드 입니다.");
			$("#apiCd").focus();
			return;
		}
	}
	//수집그룹
	if (!fnCheckValid("#apiGroupCd", "수집그룹")) {
		return false;
	}
	//수집명
	if (!fnCheckValid("#apiNm", "수집명")) {
		return false;
	}
	//데이터구분
	if (!fnCheckValid("#cmmnApiDataTyCd", "데이터구분")) {
		return false;
	}
	//사용여부
	if (!fnCheckValid("#useYn", "사용여부")) {
		return false;
	}
	if(confirm("입력한 정보를 저장하겠습니까?")){		var _frm = document.frm;
		//_frm.submit();
		var _frmArr = $(_frm).serializeArray();

		console.log($(_frm).serialize());
		console.log($(_frm).serializeArray());

		var jsonObj = fnArrayToJson(_frmArr);

		$.ajax({
			url: "/json/collectInfo/saveMetaMngInfoInfo"
			, contentType: "application/json"
			, method: "POST"
			, data: JSON.stringify(jsonObj)
			, success: function(data) {
				var resultCd = data.resultCd;
				if (resultCd == "OK") {
					alert("처리가 완료되었습니다.");
					location.href="/collector/collect/collect_info_form?apiCd="+$("#apiCd").val()+"&tIdx="+$("#tIdx").val();
				}
			}
		})
	}}
// 배열(form.serializeArray)을 JSON 으로 변경
function fnArrayToJson(array) {
	var jsonObj = {};

	$.each(array, function(idx, value){
		jsonObj[value.name] = value.value;
	}); // end each

	return jsonObj;
}

//콘텐츠 코드 중복 체크
function fnCheckDuplCode() {
	$('#apiCd').val($.trim($('#apiCd').val())); // 공백제거
	if (!fnCheckValid("#apiCd", "수집코드")) {
		return false;
	}

	// ajax call	$.get("/json/collectInfo/checkDuplApiCode?apiCd=" + $('#apiCd').val() + "&" + $('#mCode').val() , fnCheckDuplCodeCallback);
}
function fnCheckDuplCodeCallback(data) {
	var resultCd = data.resultCd;
	if(resultCd == 'OK') {		alert("사용가능한 코드입니다.");		$('#duplCheckFlag').val("Y");	} else if(resultCd == 'DUPL') {		alert("이미 사용중인 코드입니다.");		$('#duplCheckFlag').val("N");
		$('#apiCd').focus();
	} else {
		$('#duplCheckFlag').val("N");		$('#apiCd').focus();	}
}
//mlg_cd가 바뀔때 중복체크 초기화
function cntntsCodeChange(){	$('#duplCheckFlag').val('');}
//서비스 프로그램명 호출function fnMatchCode(code) {	// ajax call	//$.get("/mngr/metaMng/metaMngInfoAjax?cmmnCode=" + code, fnMatchCodeCallback);
	//ajaxSubmit("/mngr/metaMng/metaMngInfoAjax", {cmmnCode : code}, "json", eval("fnMatchCodeCallback"));

	$.ajax({
		url: "/json/collectInfo/selectCmmnCodeDetailInfo"
		, method : "POST"
		, contentType: 'application/json'
		, data: JSON.stringify({
			code: code
		})
		, success: function(data){
			var cdDc = data.cdDc;

			//fnMatchCodeCallback(cdDc);
			$("#apiProgrmExcNm").val(cdDc);
		}
	})

}

//function fnMatchCodeCallback(data) {
//	$("#apiProgrmExcNm").val(data);
//}
//속성정보 onofffunction toggleInfoFunc(code) {
	if (code == "") {
		$("#apiProgrmExcNm").val("");
		return false;
	}	if(code=="SS01" || code=="SS03") { // API, SNS 일 때,		$("#tab").show();		$("#tab").find("input").each(function() {			$(this).attr("disabled", false);		});	}else {		$("#tab").hide();		$("#tab").find("input").each(function() {			$(this).attr("disabled", true);		});		$("#apiProgrmExcNm").val("");	}
	if(code=="SS04") { //크롤러 일 때,		$(".fade_row").attr("rowspan", "2");		$("#apiProgrmCallNm_td").show();	}else {		$(".fade_row").attr("rowspan", "1");		$("#apiProgrmCallNm_td").hide();	}
	if(code=="SS05"){ //File		$("#gu").show();		$("#columnSptrt").val("|");		$("#headerSptrt").val("1");	}else{		$("#gu").hide();		$("#columnSptrt").val("");		$("#headerSptrt").val("");	}
	fnMatchCode(code);
}

function fnGoMetaList() {
	location.href='/collector/collect/collect_info_list';
}

</script>

</body>
</html>
