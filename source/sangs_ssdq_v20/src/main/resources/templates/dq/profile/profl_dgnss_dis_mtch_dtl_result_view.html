<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/mainLayout" style="overflow: auto;">
<head>
	<!-- head inclue -->
	<th:block th:replace="fragments/head_inc :: head_inc" />
	<title>프로파일 진단 불일치 상세 결과</title>	
</head>
<body>
	<div id="wrap">
		<div class="container">
			<div id="content">
				<div class="page_info_area">
					<div class="left">
						<div class="title_area">
							<p>프로파일 진단 불일치 상세 결과</p>
							<a href="#" class="reload_btn" title="새로고침">새로고침</a>
						</div>
					</div>
					<div class="right">
						<div class="button_area">
							<button class="btn" title="엑셀 다운로드" onclick="fnDisMatchDownloadExcel(); return false;">엑셀 다운로드</button>
						</div>
					</div>
				</div><!-- page_info_area -->
				<div class="content_area">
					<input type="hidden" name="excSn" id="excSn" th:value="${paramMap.excSn}" />
					<div class="card">
						<table class="view margint10">
							<colgroup>
								<col width="12%"/>
								<col width="auto"/>
								<col width="12%"/>
								<col width="auto"/>
								<col width="12%"/>
								<col width="auto"/>
							</colgroup>
							<tbody>
								<tr>
									<th>프로파일명</th>
									<td id="proflNm"></td>
								</tr>
								<tr>
									<th>총 데이터 수</th>
									<td id="totalDataCount"></td>
									<th>진단 테이블 수</th>
									<td id="totTblCnt"></td>
									<th>진단 컬럼 수</th>
									<td id="totColCnt"></td>
								</tr>									
								
								<tr>
									<th>진단 데이터 수</th>
									<td id="dgnssTotDataCnt"></td>
									<th>불일치데이터 수</th>
									<td id="dgnssTotMisCnt"></td>
									<th>Rule 오류 수</th>
									<td id="dgnssTotErrRuleCnt"></td>
								</tr>
								<tr>
									<th>수행 시작 일시</th>
									<td id="excBgngDt"></td>
									<th>수행 종료 일시</th>
									<td id="excEndDt"></td>
									<th>수행 상태</th>
									<td id="excSttusCd"></td>
								</tr>
							</tbody>
						</table>
					</div>
					
					<div class="search_wrap">
						<input type="hidden" name="searchTblSn" id="searchTblSn"/>
						<input type="hidden" name="searchRuleSn" id="searchRuleSn" />
						<input type="hidden" name="searchErrRuleYn" id="searchErrRuleYn" />
						<table class="search fixed">
							<colgroup>
								<col width="7%" />
								<col width="auto" />
								<col width="3%" />
								<col width="7%" />
								<col width="auto" />
								<col width="3%" />
								<col width="7%" />
								<col width="auto" />
							</colgroup>
							<tbody>
								<tr>
									<th>테이블 명</th>
									<td>
										<select id="tableSelectBox" name="tableSelectBox">
											<option value="">전체</option>
										</select>
									</td>
									<td></td>
									<th>패턴/규칙 명</th>
									<td>
										<select id="ruleSelectBox" name="ruleSelectBox">
											<option value="">전체</option>
										</select>
									</td>
									<td></td>
									<th>Rule 오류 여부</th>
									<td>
										<select id="ruleErrYnBox" name="ruleErrYnBox">
											<option value="">전체</option>
											<option value="Y">Y</option>
											<option value="N">N</option>
										</select>
									</td>
								</tr>
							</tbody>
						</table>
					</div><!-- search_wrap -->
					<div class="card">
						<p style="font-size: 13px;">※ 데이터 분석 오류인 진단 항목은 진단 건당 최대 1,000건 까지만 목록이 노출됩니다.</p>
						<table class="list fixed" id="tb_result_table">
							<colgroup>
								<col width="5%"/>
								<col width="10%"/>
								<col width="10%"/>
								<col width="5%"/>
								<col width="13%"/>
								<col width="13%"/>
								<col width="8%"/>
								<col width="10%"/>
								<col width="10%"/>
								<col width="10%"/>
								<col width="6%"/>
							</colgroup>
							<thead>
								<tr>
									<th>No</th>
									<th>테이블 명</th>
									<th>컬럼 명</th>
									<th>규칙 순번</th>
									<th>규칙 명</th>
									<th>규칙 표현 값</th>
									<th>긍정 규칙 여부</th>
									<th>규칙 설명</th>
									<th>데이터 값</th>
									<th>기본키 정보 값</th>
									<th>Rule 오류 여부</th>
								</tr>
							</thead>
							<tbody>
								<tr class="fwk_templete_row">
									<td>#{FWK_TR_NO}</td>
									<td>#{tblNm}</td>
									<td>#{colNm}</td>
									<td>#{ruleSn}</td>
									<td>#{ruleNm}</td>
									<td>#{ruleExprsnValue}</td>
									<td>#{rulePostvExprsnYn}</td>
									<td>#{ruleDc}</td>
									<td>#{dataValue}</td>
									<td>#{pkInfoValue}</td>
									<td>#fn{fnRuleErrDetailButtonView('#{errRuleYn}', #{tblSn}, #{colSn}, #{ruleSn})}</td>
								</tr>
							</tbody>
						</table>
						<div class="pagination_area marginb25" id="dv_result_paging"></div>
					</div>
				</div><!-- content_area -->
			</div>
		</div>
	</div>
	
	
	
<div class="popup layer" id="resultruleerrinfo_modal" style="width:700px;">
 	<div class="pop_header">
		<p class="title">프로파일 진단 규칙 오류 상세</p>
		<button class="btn_ic btn_pop_close" id="closeModalBtn" onclick="fnCloseModal('resultruleerrinfo_modal');">닫기</button>
	</div>
	<div class="pop_content">
	    <div class="card">
			<table class="view">
				<colgroup>
					<col width="30%"/>
					<col width="70%"/>
				</colgroup>
				<tbody>
					<tr>
						<th>오류 명</th>
						<td>
							<textarea style="height: 100px; overflow:auto; padding: 10px;" id="dtlview_errnm" name="dtlview_errnm" disabled></textarea>
						</td>
					</tr>
					<tr>
						<th>오류 내용</th>
						<td>
							<textarea style="height: 140px; overflow:auto; padding: 10px;" id="dtlview_errcn" name="dtlview_errcn" disabled></textarea>
						</td>
					</tr>
				</tbody>
			</table>
	    </div>
	</div>
	<div class="pop_footer"></div>
</div>
	
	
</body>




<script type="text/javascript">

$(document).ready(function() {

	fnList();
	fnSelectBox();
	$("#ruleSelectBox").change(function(){
		$("#searchRuleSn").val($(this).val());
		fnList();
	});
	
	$("#tableSelectBox").change(function(){
		$("#searchTblSn").val($(this).val());
		fnList();
	});
	
	
	$("#ruleErrYnBox").change(function(){
		$("#searchErrRuleYn").val($(this).val());
		fnList();
	});
});

// 조회
function fnList(pageNum){
	if (!pageNum)
		var pageNum = 1;
	
	
	var ruleSn = $("#searchRuleSn").val();
	var tblSn = $("#searchTblSn").val();
	var searchErrRuleYn = $("#searchErrRuleYn").val();
	
	if(searchErrRuleYn=="Y"){
		searchErrRuleYn = "E"
	}
	
	$.ajax({
		url: '/json/profileMng/getProflExcResultDisMatchList'
		, method : "POST"
		, contentType : 'application/json'
		, data : JSON.stringify({
			excSn : $("#excSn").val()
			, pageSize : 1000
			, ruleSn : ruleSn
			, tblSn : tblSn
			, ruleExcResultCd : searchErrRuleYn
			, pageNum : pageNum
		})
		, success : function(data) {
			$("#proflNm").text(data.proflNm);
			$("#totalDataCount").text(fnFormatNumber(data.totalDataCount));
			$("#totTblCnt").text(fnFormatNumber(data.totTblCnt));
			$("#totColCnt").text(fnFormatNumber(data.totColCnt));
			$("#dgnssTotDataCnt").text(fnFormatNumber(data.dgnssTotDataCnt));
			$("#dgnssTotMisCnt").text(fnFormatNumber(data.dgnssTotMisCnt));
			$("#dgnssTotErrRuleCnt").text(fnFormatNumber(data.dgnssTotErrRuleCnt));
			$("#excBgngDt").text(data.excBgngDt);
			$("#excEndDt").text(data.excEndDt);
			$("#excSttusCd").text(data.excSttusCdText);
		
			
			fnBindTableValue("tb_result_table", data.list, data.pagingInfo);
			fnSetPaging("dv_result_paging", data.pagingInfo, "fnList");
		}
	});
	
}

// 검색 selectBox 생성
function fnSelectBox(){
	
	$.ajax({
		url: '/json/profileMng/getProflExcResultDisMatchSelectBox'
		, method : "POST"
		, contentType : 'application/json'
		, data : JSON.stringify({
			excSn : $("#excSn").val()
		})
		, success : function(data) {
			
			var tableSelectBoxlist = data.resultDisMatchTableList;
			$.each(tableSelectBoxlist, function(){
				var addObj = "<option value='" + this.tblSn + "'>" + this.tblNm + "</option>";
				$("#tableSelectBox").append(addObj);
			});
			
			var ruleSelectBoxlist = data.resultDisMatchRuleList;
			$.each(ruleSelectBoxlist, function(){
				var addObj = "<option value='" + this.ruleSn + "'>" + this.ruleNm + "</option>";
				$("#ruleSelectBox").append(addObj);
			});
			
		}
	});
	
}


function fnDisMatchDownloadExcel(){
	var searchParamObj = {
		excSn : $("#excSn").val()
		, ruleSn : $("#searchRuleSn").val()
		, tblSn : $("#searchTblSn").val()
	};
	fnCommFileDownByUrl("/exceldown/profileMng/getDisMatchExcelDown","불일치 다운로드_"+$("#excSn").val()+"_", JSON.stringify(searchParamObj));
	
}

// 프로파일 진단 규칙 오류 상세
function fnResultRuleErrDetail(tblSn, colSn, ruleSn){
	
	fnShowModal("resultruleerrinfo_modal");
	
	$.ajax({
		url:'/json/profileMng/getDgnssResultRuleErrInfo'
		, method: 'POST'
		, contentType: 'application/json'
		, data: JSON.stringify({
			excSn : $("#excSn").val()
			, tblSn : tblSn
			, colSn : colSn
			, ruleSn : ruleSn
		})
		, success:function(data) {
			var info = data.info;
			$("#dtlview_errnm").text(info.errNm);
			$("#dtlview_errcn").text(info.errCn);
		}
	});
}

function fnRuleErrDetailButtonView(errRuleYn, tblSn, colSn, ruleSn){
	var button_html = "";
	if (errRuleYn == "Y") {
		button_html = "<button class='btn sm' title='확인' onclick='fnResultRuleErrDetail("+tblSn+", "+colSn+", "+ruleSn+"); return false;'>확인</button>"
	} else {
		button_html = errRuleYn;
	}
	return button_html;
}
</script>
</html>