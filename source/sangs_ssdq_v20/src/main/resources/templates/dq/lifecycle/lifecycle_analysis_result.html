<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/mainLayout">
<head>
<th:block th:replace="fragments/head_inc :: head_inc" />
</head>
<body>
	
	<div id="wrap">
		<div class="container">
			<div id="content">
				<div class="page_info_area">
					<div class="left">
                        <div class="location_area">
                            <a href="#" class="bookmark active" title="즐겨찾기"></a>
                        </div>
                        <div class="title_area">
                            <p>Lifecycle 분석 결과</p>
                            <a href="#" class="reload_btn" title="새로고침">새로고침</a>
                            <a href="#" class="help_btn" title="도움말">도움말</a>
                        </div>
                    </div>
				<form id="frm" name="frm" action="lifecycleResultView" method="get">
					<input type="hidden" id="dbmsCnncSn" name="dbmsCnncSn" value="" />
					<input type="hidden" id="dgnssInfoId" name="dgnssInfoId" value="" />
					<input type="hidden" name="pageNum" value="1" />
				</form>
                </div>
				
				
				<div class="content_area">

					<div class="division20">
						<div class="card">
							<table class="list fixed" id="tb_data_table">
								<colgroup>
									<col style="width: 12%;">
									<col style="width: 50%;">
									<col style="width: 12%;">
									<col style="width: 12%;">
									<col style="width: 12%;">
								</colgroup>
								<thead>
									<tr>
										<th>작업시작</th>
										<th>작업명</th>
										<th>작업상태</th>
										<th>수행시간</th>
										<th>결과보기</th>
									</tr>
								</thead>
								<tbody>
									<tr class="fwk_templete_row">
										<td>#{excBgngDt}
											<input type="hidden" name="excSttusCd" value="#{excSttusCd}"/>
											<input type="hidden" name="dbmsCnncSn" value="#{dbmsCnncSn}"/>
											<input type="hidden" name="dgnssInfoId" value="#{dgnssInfoId}"/>
											<input type="hidden" name="prjctSn" value="#{prjctSn}"/>
										</td>	
										<td class="alignl">#{dgnssNm}</td>
										<td class="excSttusCdTd"></td>
										<td>#{workTime}</td>
										<td class="resultbtnTd"></td>
									</tr>
								</tbody>
							</table>
							<div class="pagination_area marginb25" id="dv_paging"></div>
						</div><!-- card -->
					</div><!-- division20 -->
					
					
				</div><!-- content_area -->
				
			</div><!-- content -->
		</div><!-- container -->
	</div><!-- wrap -->
	
	
	<div class="popup layer" id="resulterrlist_modal" style="width:1500px;">
 	<div class="pop_header">
		<p class="title">Lifecycle 분석 오류 결과 상세</p>
		<button class="btn_ic btn_pop_close" id="closeModalBtn" onclick="fnCloseModal('resulterrlist_modal');">닫기</button>
	</div>
	<div class="pop_content">
		<div class="tbl_wrap" data-height="400">
		    <div class="card">
				<table class="list margint0" id="tb_errdata_table">
					<colgroup>
						<col style="width: 13%;">
						<col style="width: 13%;">
						<col style="width: 14%;">
						<col style="width: 30%;">
						<col style="width: 30%;">
					</colgroup>
					<thead>
						<tr>
							<th>테이블명</th>
							<th>컬럼명</th>
							<th>항목명</th>
							<th>오류명</th>
							<th>오류내용</th>
						</tr>
					</thead>
					<tbody>
						<tr class="fwk_templete_row">
							<td>#{tblNm}</td>
							<td>#{colNm}</td>
							<td>#{fieldNm}</td>
							<td class="alignl">#{errNm}</td>
							<td class="alignl">#{errCn}</td>
						</tr>
					</tbody>
				</table>
		    </div>
	    </div>
	</div>
	<div class="pop_footer"></div>
</div>
	
	
<script type="text/javascript">

$(document).ready(function() {
	
	try {
		// 왼쪽 메뉴 선택 처리 (링크로 해당 페이지 들어온경우 오른쪽 메뉴를 선택 처리 한다. )
		parent.fnSelectLeftMenu(location.pathname);
	} catch(e) {}
	
	
	isMongoDbFileCheck();
	
	
	var chk = isSessionConChk();
	
	if(chk){
		var dbmsNm = fnGetMyDbmsNm();
		var dbmsDatabaseNm = "";
		if(dbmsNm != "VoltDB"){
			dbmsDatabaseNm = fnGetMyDbmsDatabaseNm();
		}
		
		isCsvFileCheck(dbmsNm);
		
		$("#dbmsNm").val(dbmsNm);
		$("#dbmsDatabaseNm").val(dbmsDatabaseNm);
		
		
		fnResultList();
	}
	

});

// 테이블 목록 조회
function fnResultList(pageNum){

	if (!pageNum)
		pageNum = 1;
	
 	$.ajax({
		url : '/dq/lifecycle/getLifecycleDiagnosisResultList'
		, method : "POST"
		, contentType : 'application/json'
		, data : JSON.stringify({
			pageNum : pageNum
		})
		, success : function(data) {
			fnBindTableValue("tb_data_table", data.list, data.pagingInfo);
			fnSetPaging("dv_paging", data.pagingInfo, "fnResultList");
			var resultbtnTd = "" ;
			var exSttusCdTd = ""; 
			$("#tb_data_table tbody tr.fwk_data_row").each(function(index){
				
				var excSttusCd = $(this).find("input[name=excSttusCd]").val();
				var dbmsCnncSn = $(this).find("input[name=dbmsCnncSn]").val();
				var dgnssInfoId = $(this).find("input[name=dgnssInfoId]").val();
				var prjctSn = $(this).find("input[name=prjctSn]").val();
				
				// resultbtn
				if(excSttusCd == "E"){
					resultbtnTd = '<button class="btn sm" name="resultBtn" onclick="fnResultMoveBtn(\''+dbmsCnncSn+'\', \''+dgnssInfoId+'\');" >확인</button>';
					exSttusCdTd = '작업완료'+'<i class="fas fa-check" style="color: green"></i>';
				} else if(excSttusCd == "S"){
					resultbtnTd = '';
					exSttusCdTd = '작업중'+'<i class="fas fa-spinner fa-pulse" style="color: blue"></i>';
				} else {
					resultbtnTd = '<button class="btn sm" name="resultErrBtn" onclick="fnResultErrBtn(\''+dbmsCnncSn+'\', \''+dgnssInfoId+'\', \''+prjctSn+'\');" >오류확인</button>';
					exSttusCdTd = '작업실패'+'<i class="far fa-times-circle" style="color: red"></i>';
				}
				
				$(this).find(".resultbtnTd").append(resultbtnTd);
				$(this).find(".excSttusCdTd").append(exSttusCdTd);
				
			});
			
		}
	});
}
function fnResultMoveBtn(dbmsCnncSn, dgnssInfoId){
	$('#dbmsCnncSn').val(dbmsCnncSn);
	$('#dgnssInfoId').val(dgnssInfoId);
	$('#frm').submit();
}


function fnResultErrBtn(dbmsCnncSn, dgnssInfoId, prjctSn){
	fnShowModal("resulterrlist_modal");
	
	$.ajax({
		url : '/dq/lifecycle/getLifecycleDiagnosisResultErrTableList'
		, method : "POST"
		, contentType : 'application/json'
		, data : JSON.stringify({
			dbmsCnncSn : dbmsCnncSn
			, dgnssInfoId : dgnssInfoId
			, prjctSn : prjctSn
		})
		, success : function(data) {
			fnBindTableValue("tb_errdata_table", data.list);
		}
	});
	
}
</script>
</body>
</html>
