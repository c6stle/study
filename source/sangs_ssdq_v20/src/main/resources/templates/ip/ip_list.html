<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/mainLayout">

<head>
	<th:block th:replace="fragments/head_inc :: head_inc" />
	<style>
		div.dot {
			margin-left:10px;
			margin-right:5px;
			margin-top:auto;;
		}
		div.tilde {
			margin-left:auto;
			margin-right:auto;
		}
	</style>
</head>

<body>
	<div id="wrap">
		<div class="container">
			<div id="content">
			
				<div class="page_info_area">
					<div class="left">
						<div class="title_area">
							<p>IP접속 제어관리</p>
							<a href="#" class="reload_btn" title="새로고침">새로고침</a>
						</div>
					</div>
					<div class="right">
						<div class="button_area">
							<button class="btn" id="btnSearch" onclick="fnSearch(); return false;" >조회</button>
							<button class="btn" id="btnNew" onclick="fnCntnIpInfoNew(); return false;" >등록</button>
						</div>
					</div>
				</div><!--// page_info_area -->
				
				
				<div class="content_area">
					<div class="division20">
						<div class="search_wrap">
							<table class="search fixed">
								<caption>조회 조건</caption>
								<colgroup>
									<col style="width: 10%;" />
									<col style="width: 40%;" />
									<col style="width: 10%;" />
									<col style="width: 40%;" />
								</colgroup>
								<tbody>
									<tr>
										<th scope="row">
											<div class="selectbox in_w95">
												<select id="searchOption" name="searchOption">
													<option value="IP">IP</option>
													<option value="IP_NM">IP명</option>
												</select>
												<label for="searchOption">IP</label>
											</div>
										</th>
										<td>
											<input class="in_w95" type="text" name="searchKeyword" id="searchKeyword" title="검색어" />
										</td>
										<th scope="row">사용여부</th>
										<td>
											<div class="selectbox ">
												<select id="searchUseYn" name="searchUseYn">
													<option value="">전체</option>
													<option value="Y">사용</option>
													<option value="N">미사용</option>
												</select>
												<label for="searchUseYn">전체</label>
											</div>
										</td>
									</tr>
									<tr>
										<th scope="row"><span class="marginl10">기간 만료 여부</span></th>
										<td>
											<input type="checkbox" id="searchExprCntnPermStngYn" title="기간만료여부"/>
										</td>
										<th scope="row">허용 기간</th>
										<td>
											<div class="in_w100">
												<div class="calendar_box">
													<input type="text" id="searchBgnDt" name="searchBgnDt" autocomplete='off' title="접속허용기간시작일"/>
												</div>
												<span class="calendar_td_box_span">~</span>
												<div class="calendar_box">
													<input type="text" id="searchEndDt" name="searchEndDt" autocomplete='off' title="접속허용기간종료일"/>
												</div>
											</div>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div><!--// division20 -->
					
					
					<div class="division20">
						<div class="list_change">
							<div class="in_w30">
								<div class="left" data-width="0">
									<div class="view_wrap">
										<div class="tbl_top">
											<p class="tit v2">
												<span>접속허용 아이피</span>
											</p>
										</div>
										<div class="table_area" style="height:510px;">
											<table class="list" id="cntnIpListTable">
												<caption>접속허용 아이피 정보</caption>
												<colgroup>
													<col style="width: 100%;"/>
												</colgroup>
												<thead style="display:none;">
													<tr>
														<th></th>
													</tr>
												</thead>
												<tbody>
													<tr class="fwk_templete_row">
														<td class="alignl">
															<input type="hidden" name="cntnIpSn" id="cntnIpSn" value="#{cntnIpSn}" />
															<span style="font-size:15px;">#{cntnIpNm}</span><br/>
															<span style="font-size:15px;">#fn{fnCntnIpNo('#{cntnIpNo}', '#{cntnIpBandNo}')}</span><br/>
															<span style="font-size:13px; color:#d0d0d0;">#fn{fnCntnPermPd('#{cntnPermStngYn}', '#{cntnPermBgngDt}', '#{cntnPermEndDt}')}</span><br/>
														</td>
													</tr>
												</tbody>
											</table>
										</div><!--// table_area -->
									</div>
								</div>
							</div><!-- left -->
							
							<div class="marginr20"></div>
							<div class="right" data-width="0">
								<div class="view_wrap">
									<div class="tbl_top">
										<p class="tit v2">
											<span>IP 접속 정보</span>
										</p>
										<div class="btn_wrap">
											<button class="btn sm" id="btnDel" onclick="fnCntnIpInfoSave('D'); return false;" style="display:none;">삭제</button>
											<button class="btn sm" id="btnSave" onclick="fnCntnIpInfoSave('U'); return false;" style="display:none;">저장</button>
										</div>
									</div>
									<form id="cntnIpInfoForm" name="cntnIpInfoForm">
										<div class="table_area marginb25">
											<table class="view" id="cntnIpInfoTable">
												<caption>IP 접속 정보</caption>
												<colgroup>
													<col style="width: 20%;" />
													<col style="width: 80%;" />
												</colgroup>
												<tbody class="fwk_databind_single_tbody">
													<tr>
														<th>* 접속 가능 IP 등록</th>
														<td style="border-right:0px;">
															<div class="ip_wrap" style="display:flex; flex-direction:row;">
																<input type="hidden" name="cntnIpSn" value="#{cntnIpSn}"/>
																<div style="width:15%;">
																	<input title="아이피번호1" type="text" name="cntnIpNo1" id="cntnIpNo1" value="#{cntnIpNo1}" oninput="fnNumberFilterValue(this)" onkeyup="fnNumberLimit(this);" maxlength="3"/>
																</div>
																<div class="dot">
																	<span>.</span>
																</div>
																<div style="width:15%;">
																	<input title="아이피번호2" type="text" name="cntnIpNo2" id="cntnIpNo2" value="#{cntnIpNo2}" oninput="fnNumberFilterValue(this)" onkeyup="fnNumberLimit(this);" maxlength="3"/>
																</div>
																<div class="dot">
																	<span>.</span>
																</div>
																<div style="width:15%;">
																	<input title="아이피번호3" type="text" name="cntnIpNo3" id="cntnIpNo3" value="#{cntnIpNo3}" oninput="fnNumberFilterValue(this)" onkeyup="fnNumberLimit(this);" maxlength="3"/>
																</div>
																<div class="dot">
																	<span>.</span>
																</div>
																<div style="width:15%;">
																	<input title="아이피번호4" type="text" name="cntnIpNo4" id="cntnIpNo4" value="#{cntnIpNo4}" oninput="fnNumberFilterValue(this)" onkeyup="fnNumberLimit(this);" maxlength="3"/>
																</div>
																<div class="tilde">
																	<span>~</span>
																</div>
																<div style="width:15%;">
																	<input title="아이피대역번호" type="text" name="cntnIpBandNo" value="#{cntnIpBandNo}" placeholder="대역" oninput="fnNumberFilterValue(this)" onkeyup="fnNumberLimit(this);" maxlength="3"/>
																</div>
															</div>
														</td>
													</tr>
													<tr>
														<th>* 접속 IP명</th>
														<td>
															<input title="접속아이피명" class="alignl" type="text" name="cntnIpNm" id="cntnIpNm" value="#{cntnIpNm}"/>
														</td>
													</tr>
													<tr>
														<th>사용 여부</th>
														<td>
															<div class="selectbox in_w30">
																<select id="useYn" name="useYn">
																	<option value="Y">사용</option>
																	<option value="N">미사용</option>
																</select>
																<label for="useYn">사용</label>
															</div>
														</td>
													</tr>
													<tr>
														<th>접속 허용 기간 설정</th>
														<td>
															<input title="접속허용기간설정여부" type="checkbox" id="cntnPermStngYn" name="cntnPermStngYn"/>
														</td>
													</tr>
													<tr>
														<th>허용 기간</th>
														<td>
															<div class="calendar_td_box">
																<input type="text" id="cntnPermBgngDt" name="cntnPermBgngDt" value="#{cntnPermBgngDt}" autocomplete='off' title="접속허용시작일"/>
															</div>
															<span class="calendar_td_box_span">~</span>
															<div class="calendar_td_box">
																<input type="text" id="cntnPermEndDt" name="cntnPermEndDt" value="#{cntnPermEndDt}" autocomplete='off' title="접속허용종료일"/>
															</div>
														</td>
													</tr>
												</tbody>
											</table>
										</div><!--// table_area -->
									</form>
								</div>
							</div><!-- right -->
						</div>
					</div><!-- division20 -->
				</div><!-- content_area -->
				
			</div><!-- content -->
		</div><!-- container -->
	</div><!-- wrap -->
	
	<div class="popup layer" id="reg_cntnIp_modal" style="width: 900px;">
		<div class="pop_header">
			<p class="title" id="reg_banner_p_title">접속허용 IP 신규 등록</p>
			<button class="btn_ic btn_pop_close" onclick="fnCloseModal('reg_cntnIp_modal'); return false;">닫기</button>
		</div>
		<div class="pop_content">
			<div class="tbl_top right padt10">
				<div class="btn_wrap">
					<button id="btnRegCntnIpSave" class="btn sm" onclick="fnCntnIpInfoSave('C'); return false;">저장</button>
				</div>
			</div>
			<form id="regCntnIpInfoForm" name="regCntnIpInfoForm">
				<!-- table_area -->
				<div class="table_area marginb25">
					<table class="view" id="regCntnIpInfoTable">
						<caption>접속허용 IP 신규 등록</caption>
						<colgroup>
							<col style="width: 20%;" />
							<col style="width: 80%;" />
						</colgroup>
						<tbody class="fwk_databind_single_tbody">
							<tr>
								<th>* 접속 가능 IP 등록</th>
								<td style="border-right:0px;">
									<div class="ip_wrap" style="display:flex; flex-direction:row;">
										<div style="width:15%;">
											<input title="아이피번호1" type="text" name="cntnIpNo1" id="regCntnIpNo1" oninput="fnNumberFilterValue(this)" onkeyup="fnNumberLimit(this);" maxlength="3"/>
										</div>
										<div class="dot">
											<span>.</span>
										</div>
										<div style="width:15%;">
											<input title="아이피번호2" type="text" name="cntnIpNo2" id="regCntnIpNo2" oninput="fnNumberFilterValue(this)" onkeyup="fnNumberLimit(this);" maxlength="3"/>
										</div>
										<div class="dot">
											<span>.</span>
										</div>
										<div style="width:15%;">
											<input title="아이피번호3" type="text" name="cntnIpNo3" id="regCntnIpNo3" oninput="fnNumberFilterValue(this)" onkeyup="fnNumberLimit(this);" maxlength="3"/>
										</div>
										<div class="dot">
											<span>.</span>
										</div>
										<div style="width:15%;">
											<input title="아이피번호4" type="text" name="cntnIpNo4" id="regCntnIpNo4" oninput="fnNumberFilterValue(this)" onkeyup="fnNumberLimit(this);" maxlength="3"/>
										</div>
										<div class="tilde">
											<span>~</span>
										</div>
										<div style="width:15%;">
											<input title="아이피대역번호" type="text" name="cntnIpBandNo" placeholder="대역" oninput="fnNumberFilterValue(this)" onkeyup="fnNumberLimit(this);" maxlength="3"/>
										</div>
									</div>
								</td>
							</tr>
							<tr>
								<th>* 접속 IP명</th>
								<td>
									<input title="접속아이피명" class="alignl" type="text" name="cntnIpNm" id="regCntnIpNm"/>
								</td>
							</tr>
							<tr>
								<th>사용 여부</th>
								<td>
									<div class="selectbox in_w30">
										<select id="regUseYn" name="useYn">
											<option value="Y">사용</option>
											<option value="N">미사용</option>
										</select>
										<label for="regUseYn">사용</label>
									</div>
								</td>
							</tr>
							<tr>
								<th>접속 허용 기간 설정</th>
								<td>
									<input title="접속허용기간설정여부" type="checkbox" id="regCntnPermStngYn" name="cntnPermStngYn"/>
								</td>
							</tr>
							<tr>
								<th>허용 기간</th>
								<td>
									<div class="calendar_td_box">
										<input type="text" title="접속허용시작일시" id="regCntnPermBgngDt" name="cntnPermBgngDt" autocomplete='off'/>
									</div>
									<span class="calendar_td_box_span">~</span>
									<div class="calendar_td_box">
										<input type="text" title="접속허용종료일시" id="regCntnPermEndDt" name="cntnPermEndDt" autocomplete='off'/>
									</div>
								</td>
							</tr>
						</tbody>
					</table>
				</div><!--// table_area -->
			</form>
		</div>
		<div class="pop_footer"></div>
	</div>

<script>

$(document).ready(function(){

	fnClearSigleBindKey("cntnIpInfoTable");

	$("#searchBgnDt, #searchEndDt").datepicker();

	// 엔터키 처리
	$("#searchKeyword").on("keyup", function(event) {
		if(event.keyCode == 13) {
			fnSearch();
		}
	});

	// 접속 허용 기간 설정 checkbox
	fnCntnPermStngYn("cntnPermStngYn");

	// 접근허용 아이피 조회
	fnSearch();

});

// 접근허용 아이피 조회
function fnSearch(pageNum, tableClickIndex){

	$("#btnDel").css("display", "none");
	$("#btnSave").css("display", "none");

	var searchOption = $("#searchOption").find("option:selected").val();
	var searchKeyword = $("#searchKeyword").val();
	var useYn = $("#searchUseYn").find("option:selected").val();
	var searchExprCntnPermStngYn = $("#searchExprCntnPermStngYn").prop("checked") ? "Y" : "N";
	var searchBgnDt = $("#searchBgnDt").val();
	var searchEndDt = $("#searchEndDt").val();

	$.ajax({
		url: "/json/ipMng/getCntnIpList"
		, method : "POST"
		, contentType:"application/json"
		, data: JSON.stringify({
			pageNum: pageNum
			, searchOption: searchOption
			, searchKeyword: searchKeyword
			, useYn: useYn
			, searchExprCntnPermStngYn: searchExprCntnPermStngYn
			, searchBgnDt: searchBgnDt
			, searchEndDt: searchEndDt
		})
		, success: function(data){

			var cntnIpList = data.cntnIpList;

			// 바인드
			fnBindTableValue("cntnIpListTable", data.cntnIpList, data.pagingInfo);

			// 문항 테이블 공백 라인 생성
			fnSelectTrEvent("#cntnIpListTable tbody tr", function(rtnObj){
				var cntnIpSn = fnSelectTrHiddenValue("cntnIpListTable", "cntnIpSn");
				fnViewDetail(cntnIpSn);
			});

			// 선택된 행의 문항정보 재조회
			if (tableClickIndex != null) {
				fnTableRowClick("cntnIpListTable", tableClickIndex);
			}

			// 리스트 개수로 스크롤 생성
			if (cntnIpList.length > 6) {
				$("#cntnIpListTable").closest(".table_area").css("overflow-y", "scroll");
			} else {
				$("#cntnIpListTable").closest(".table_area").css("overflow-y", "");
			}
		} // end success
	}); // end ajax
}

// 접근허용 아이피 상세조회
function fnViewDetail(cntnIpSn) {

	$("#btnDel").css("display", "");
	$("#btnSave").css("display", "");

	$.ajax({
		url: "/json/ipMng/getCntnIpInfo"
		, method : "POST"
		, contentType:"application/json"
		, data: JSON.stringify({
			cntnIpSn: cntnIpSn
		})
		, success: function(data){
			var cntnIpInfo = data.cntnIpInfo;

			var cntnIpNoArr = [];
			var cntnIpNo = cntnIpInfo.cntnIpNo;

			// 아이피 분리 (input 에 추가하기 위함)
			if (cntnIpNo) {
				cntnIpNoArr = cntnIpNo.split(".");
				cntnIpInfo.cntnIpNo1 = cntnIpNoArr[0];
				cntnIpInfo.cntnIpNo2 = cntnIpNoArr[1];
				cntnIpInfo.cntnIpNo3 = cntnIpNoArr[2];
				cntnIpInfo.cntnIpNo4 = cntnIpNoArr[3];
			}
			// 바인딩
			fnBindTableValueForSingle("cntnIpInfoTable", cntnIpInfo);

			// 사용여부
			var useYn = cntnIpInfo.useYn;
			$("#useYn").val(useYn).prop("selected", true);

			fnApplySelectLabel();

			// 접속허용기간설정 여부
			var cntnPermStngYn = (cntnIpInfo.cntnPermStngYn == 'Y') ? true : false;
			// 접속허용기간설정 checkbox
			fnCntnPermStngYn("cntnPermStngYn", cntnPermStngYn);

			$("#cntnPermBgngDt, #cntnPermEndDt").datepicker();

		}
	});

}
// 접근허용 아이피 신규버튼
function fnCntnIpInfoNew() {

	fnClearSigleBindKey("regCntnIpInfoTable");

	$("#regCntnPermBgngDt, #regCntnPermEndDt").datepicker();

	// 접속 허용 기간 설정 checkbox
	fnCntnPermStngYn("regCntnPermStngYn");

	fnShowModal('reg_cntnIp_modal');
}
// 접근허용 아이피 저장
function fnCntnIpInfoSave(pmode) {

	var pmodeStr = (pmode == 'D') ? "삭제" : "저장";

	var cFlag = (pmode == "C") ? true : false;
	var cntnIpNo1 = (cFlag) ? "regCntnIpNo1" : "cntnIpNo1";
	var cntnIpNo2 = (cFlag) ? "regCntnIpNo2" : "cntnIpNo2";
	var cntnIpNo3 = (cFlag) ? "regCntnIpNo3" : "cntnIpNo3";
	var cntnIpNo4 = (cFlag) ? "regCntnIpNo4" : "cntnIpNo4";
	var cntnIpNm = (cFlag) ? "regCntnIpNm" : "cntnIpNm";
	var cntnPermStngYn = (cFlag) ? "regCntnPermStngYn" : "cntnPermStngYn";
	var cntnPermBgngDt = (cFlag) ? "regCntnPermBgngDt" : "cntnPermBgngDt";
	var cntnPermEndDt = (cFlag) ? "regCntnPermEndDt" : "cntnPermEndDt";

	if (pmode != 'D') {
		// null 체크
		if (!fnCheckValid("#"+cntnIpNo1, "아이피번호1")) {
			return;
		}
		if (!fnCheckValid("#"+cntnIpNo2, "아이피번호2")) {
			return;
		}
		if (!fnCheckValid("#"+cntnIpNo3, "아이피번호3")) {
			return;
		}
		if (!fnCheckValid("#"+cntnIpNo4, "아이피번호4")) {
			return;
		}
		if (!fnCheckValid("#"+cntnIpNm, "접속 IP명")) {
			return;
		}
	}

	// 날짜 조건 체크
	if(!fnSearcDateChk($("#"+cntnPermBgngDt).val(), $("#"+cntnPermEndDt).val())) return;

	// 저장 프로세스
	if (confirm(pmodeStr+"하시겠습니까?")) {

		// 정보를 담을 객체
		var cntnIpInfoJson = {};
		var cntnIpInfoArr = (cFlag) ? $("#regCntnIpInfoForm :input").serializeArray() : $("#cntnIpInfoForm :input").serializeArray();

		var cntnIpNo = "";
		$.each(cntnIpInfoArr, function(idx, value){
			if (value.name.indexOf("cntnIpNo") > -1) {
				cntnIpNo += value.value;
				if (value.name != "cntnIpNo4") {
					cntnIpNo += ".";
				} else {
					cntnIpInfoJson["cntnIpNo"] = cntnIpNo;
				}
			} else {
				cntnIpInfoJson[value.name] = value.value;
			}
		}); // end each

		var cntnPermStngYn = $("#"+cntnPermStngYn).prop("checked") ? 'Y' : 'N';
		cntnIpInfoJson["cntnPermStngYn"] = cntnPermStngYn;

		console.log("pmode : " + pmode);
		console.log("== fnCntnIpInfoSave -> cntnIpInfoJson ==");
		console.log(cntnIpInfoJson);

		$.ajax({
			url: "/json/ipMng/saveCntnIpInfo"
			, method : "POST"
			, contentType:"application/json"
			, data: JSON.stringify({
				cntnIpInfo : cntnIpInfoJson
				, pmode : pmode
			})
			, success : function(data){

				if (data.resultCd == "OK") {
					alert("처리가 완료되었습니다.")

					// 상세보기 재조회 index
					var pageNum = "";
					var tableClickIndex;

					if (pmode == 'U') {
						pageNum = fnCurrentPageNum("dv_paging");
						tableClickIndex = fnTableClickIndex("cntnIpListTable");
					} else if (pmode == 'C') {
						fnCloseModal('reg_cntnIp_modal');
					}
					fnSearch(pageNum, tableClickIndex);
				}
			}
		}); // end ajax
	}// end if
}

// 접속허용기간 (ex : 2000-01-01 ~ 2000-12-31)
function fnCntnPermPd(cntnPermStngYn, cntnPermBgngDt, cntnPermEndDt){
	var rtnCntnPermPd = "";
	if (cntnPermStngYn == 'Y' && cntnPermBgngDt != null && cntnPermEndDt != null) {
		rtnCntnPermPd = cntnPermBgngDt + " ~ " + cntnPermEndDt;
	} else {
		rtnCntnPermPd = "접속 허용 기간 설정 없음";
	}
	return rtnCntnPermPd;
}

// 아이피주소와 대역폭 (ex : 123.123.123.123 ~ 123)
function fnCntnIpNo(cntnIpNo, cntnIpBandNo) {
	var rtnCntnIpNo = "";
	rtnCntnIpNo += cntnIpNo;
	if (cntnIpBandNo) {
		rtnCntnIpNo += " ~ " + cntnIpBandNo;
	}
	return rtnCntnIpNo;
}


//접속 허용 기간 설정 체크박스 이벤트
function fnCntnPermStngYn(id, checkFlag) {

	var flag = id.indexOf("reg") > -1;
	var cntnPermStngYn = (flag) ? "regCntnPermStngYn" : "cntnPermStngYn";
	var cntnPermBgngDt = (flag) ? "regCntnPermBgngDt" : "cntnPermBgngDt";
	var cntnPermEndDt = (flag) ? "regCntnPermEndDt" : "cntnPermEndDt";

	$("#"+cntnPermStngYn).on("change", function() {
		if ($("#"+cntnPermStngYn).prop("checked")) {
			$("#"+cntnPermBgngDt).attr("disabled", false);
			$("#"+cntnPermEndDt).attr("disabled", false);
		} else {
			$("#"+cntnPermBgngDt).val("");
			$("#"+cntnPermEndDt).val("");
			$("#"+cntnPermBgngDt).attr("disabled", true);
			$("#"+cntnPermEndDt).attr("disabled", true);
		}
	});

	if (checkFlag == null) {
		checkFlag = false;
	}

	$("#"+cntnPermStngYn).prop("checked", checkFlag).trigger("change");
}

function fnNumberLimit(obj) {
	if (obj.value > 255) {
		obj.value = 255;
	}

	if (obj.value.length == 3){
		var input = $(obj).closest(".ip_wrap").find("input").not("[type='hidden']");
		var index = input.index(obj);

		if (index+1 < input.length) {
			input[index+1].focus();
		}
	}
}
</script>
<!-- contents end import -->
<th:block th:replace="fragments/footer_inc :: footer_inc" />
</body>
</html>
