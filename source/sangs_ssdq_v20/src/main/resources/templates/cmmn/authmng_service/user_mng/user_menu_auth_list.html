<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/mainLayout">

<th:block th:replace="fragments/head_inc :: head_inc" />

<link rel="stylesheet" th:href="@{/vender/jstree/style.css}" />
<script th:src="@{/vender/jstree/vakata.js}"></script>
<script th:src="@{/vender/jstree/jstree.min.js}"></script>
<script th:src="@{/vender/jstree/jstreegrid.js}"></script>

 
<div id="wrap">
	<div class="container">
		<div id="content">

		<!-- page_info_area -->
		<div class="page_info_area">
		    <div class="left">
		        <div class="location_area">
		            <a href="#" class="bookmark active" title="즐겨찾기"></a>
		            <ul>
		                <li>홈</li>
		                <li>환경설정</li>
		            </ul>
		        </div>
		        <div class="title_area">
		            <p>메뉴권한 관리</p>
		            <a href="#" class="reload_btn" title="새로고침"  onclick="location.reload(true); return false;">새로고침</a>
		            <a href="#" class="help_btn" title="도움말">도움말</a>
		        </div>
		    </div>
		    <div class="right">
		        <div class="button_area">
		        	<!-- 
		            <button class="btn" title="조회">조회</button>
		             -->
		        </div>
		    </div>
		</div>
		<!--// page_info_area -->
		
		<!-- content_area -->
		<div class="content_area">
		<div class="division">
			<div class="view_wrap marginb85">
				<div class="list_change">
			        <div class="in_w30">
  			            <div class="tbl_top fx_none">
							<p class="tit v2 margin0">
								<span>권한그룹 목록</span>
							</p>
							<div class="btn_wrap">
							</div>
						</div>
						<!-- table_area -->
						<div class="table_area marginb25">
						    <table class="list" id="tb_author_table">
						        <colgroup>
						            <col style="width:auto;"/>
						            <col style="width:auto;"/>
						            <col style="width:auto;"/>
						        </colgroup>
						        <thead>
						            <tr>
						                <th scope="col">권한코드</th>
						                <th scope="col">권한코드 명</th>
						                <th scope="col">권한코드 설명</th>
						            </tr>
						        </thead>
						        <tbody>
						            <tr class="fwk_templete_row">
						            	<input type="hidden" name="authrtCd" value="#{authrtCd}" />
						                <td>#{authrtCd}</td>
						                <td>#{authrtNm}</td>
						                <td>#{authrtCn}</td>
						            </tr>
						        </tbody>
						    </table>
						</div>
						<!--// table_area -->

			            <div class="tbl_top fx_none">
							<p class="tit v2 margin0">
								<span>권한그룹 관리자 목록</span>
							</p>
							<div class="btn_wrap">
							</div>
						</div>
						
						<!-- table_area -->
						<div class="table_area marginb25">
						    <table class="list" id="tb_auth_user_table">
						        <colgroup>
						            <col style="width:200px;"/>
						            <col style="width:auto;"/>
						        </colgroup>
						        <thead>
						            <tr>
						                <th scope="col">아이디</th>
						                <th scope="col">사용자 명</th>
						            </tr>
						        </thead>
						        <tbody>
						            <tr class="fwk_templete_row">
						            	<input type="hidden" name="userId" value="#{userId}" />
						                <td>#{userId}</td>
						                <td>#{userNm}</td>
						            </tr>
						        </tbody>
						    </table>
						</div>
						<!--// table_area -->
		            </div> 
			        
			        <div class="marginr20"></div> 
			        
			        <div class="right">
			            <div class="tbl_top fx_none">
							<p class="tit v2 margin0">
								<span>권한그룹 상세목록</span>
							</p>
							<div class="btn_wrap">
								<button class="btn sm" onclick="fnSaveAuthor('menuAuthorTree'); return false;">저장</button>
							</div>
						</div>
			            
		         		<!-- view_wrap -->
		                <div class="jstreetable_view_wrap marginb85">
		                    <div id="menuAuthorTree"></div>
		                </div>
		                <!--// view_wrap -->
			        </div>
			    </div>
			</div>
		</div>
		</div>
		</div>
	</div>
</div>

<script type="text/javascript">
	var codeObj;
	var userId = "";
	
	$(document).ready(function() {
		fnInit();
	});
	
	function fnInit() {
		// 권한 항목 조회
		codeObj = fnSelectMenuAuthorCodeList();
		
		fnSearchAuthList();
	}
	
	//권한 목록 
	function fnSearchAuthList() {
		
		var authrtCd = null;
		
		$.ajax({
			url: "/json/authMngAuth/getAuthorList"
			, method : "POST"
			, contentType: 'application/json'
			, data: JSON.stringify({
				data : "null"
			})
			, success: function(data){
				
				fnBindTableValue("tb_author_table", data.list);
	
				// 초기 로드 시 초기값 선택
				// trId, name 값, 초기선택 비교인자 값
				var trId = $("#tb_author_table tbody tr");
				var authrtCd = fnSelectedTableValue(trId, 'authrtCd', 'ADMIN');
				
				if(authrtCd != null){
					fnSearchAuthorUser(authrtCd);
					// 시스템코드 || 권한코드 || 사용자ID || 데이터 reload 구분(Y/N)
					fnSearchMenuList("ML", authrtCd, '', 'N');	
				}
				
				fnSelectTrEvent("#tb_author_table tbody tr", function(rtnObj) {
					console.log("rtnObj = ", rtnObj);
					
					authrtCd = $(rtnObj).find("input[name=authrtCd]").val();
					fnSearchAuthorUser(authrtCd);
					// 시스템코드 || 권한코드 || 사용자ID || 데이터 reload 구분(Y/N)
					fnSearchMenuList("ML", authrtCd, '', 'Y');
				});
			}
		});
	}
	 
	// 권한 그룹 사용자 목록
	function fnSearchAuthorUser(authrtCd) {
		
		$.ajax({
			url: "/json/authMngAuth/getAuthorUserList"
			, method : "POST"
			, contentType: 'application/json'
			, data: JSON.stringify({
				authrtCd : authrtCd
			})
			, success: function(data){
				fnBindTableValue("tb_auth_user_table", data.list);
				
				fnSelectTrEvent("#tb_auth_user_table tbody tr", function(rtnObj) {
					userId = $(rtnObj).find("input[name=userId]").val();
					
					console.log("userId = ", userId);
					// 시스템코드 || 권한코드 || 사용자ID || 데이터 reload 구분(Y/N)
					fnSearchMenuList("ML", authrtCd, userId, 'Y');
				});
			}
		});
	}
	
	function fnSearchMenuList(sysSeCd, authrtCd, userId, refreshYn) {
		
		$.ajax({
			url: "/json/authMngMenu/getAuthMenuList"
			, method : "POST"
			, contentType: 'application/json'
			, data: JSON.stringify({
				sysSeCd : sysSeCd
				, authrtCd : authrtCd
				, codeObj : codeObj
				, userId : userId == "" ? "NULL" : userId
			})
			, success: function(data){
				
				if(codeObj){
					if(refreshYn == "Y"){
						// 데이터 reload 
						fnBindCore("menuAuthorTree", data.list, codeObj, userId);	
					}else{
						// 초기 jstree 로드 시 
						fnBindJstreeGrid("menuAuthorTree", data.list, codeObj, userId);	
					}
				}
				
			}
		});
	}

</script>
</html>
					 