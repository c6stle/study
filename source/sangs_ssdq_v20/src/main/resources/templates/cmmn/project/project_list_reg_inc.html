<html th:lang="ko" xmlns:th="http://www.thymeleaf.org">


<th:block th:fragment="project_list_reg_inc">

		<script th:src="@{/vender/jwtToken/hmac-sha512.js}"></script>
		<script th:src="@{/vender/jwtToken/enc-base64-min.js}"></script>
		<script th:src="@{/vender/jwtToken/jwt_util.js}"></script>
		
	<div class="pop_header">
		<p class="title">등록</p>
		<button class="btn_ic btn_pop_close" onclick="fnCloseModal('prjctreginfo_modal');">닫기</button>
	</div>
	<div class="pop_content card">
		<div class="tbl_top">
		<p class="tit v2 margin0">프로젝트정보</p>
		<div style="font-size:13px; margin-top:10px">※ 표준세트 및 DBMS 정보를 입력하지 않으면 메타시스템 기능이 제한될 수 있습니다.</div>
			<div class="btn_wrap">
				<input type="hidden" name="regPrjctStdSetSnHide" id="regPrjctStdSetSnHide" />
				<input type="hidden" name="regPrjctDbmsCnncSnHide" id="regPrjctDbmsCnncSnHide" />
				<input type="hidden" name="regPrjctSnHide" id="regPrjctSnHide" />
				<input type="hidden" name="regPrjctPmodeHide" id="regPrjctPmodeHide" />
				<input type="hidden" name="regPrjctUserIdHide" id="regPrjctUserIdHide" />
				<input type="hidden" name="regChangeYnPassword" id="regChangeYnPassword" />
				<input type="hidden" name="regCheckCsv" id="regCheckCsv" />
				<button class="btn sm" onclick="fnRegCnctDbmsTestBtn(); return false;">연결테스트</button>
				<button class="btn sm" onclick="fnRegPrjctSaveBtn(); return false;">저장</button>
			</div>
		</div>
		<div class="table_area">
			<table class="view">
				<colgroup>
					<col width = "15%" />
					<col width = "auto" />
		
				</colgroup>
				<tbody>
					<tr>
						<th>* 프로젝트명</th>
						<td>
							<input type="text" name="regPrjctNm" id="regPrjctNm" maxlength="50" placeholder="50자 이내로 입력해주세요" />
						</td>
					</tr>
					<tr>
						<th>프로젝트사용자</th>
						<td style="padding-right: 3px;">
							<ul style="margin-left: -6px;" id="regPrjctUserNm">
							</ul>
							<div style="display: flex; float: right;">
								<button class="btn sm" onclick="fnUserAddBtn();" >추가</button>
							</div>
						</td>
					</tr>
					<tr id="tr_prjctcn">
						<th>프로젝트설명</th>
						<td>
							<input type="text" name="regPrjctCn" id="regPrjctCn" maxlength="100" placeholder="100자 이내로 입력해주세요" />
						</td>
					</tr>
					<tr id="tr_stdsetnm">
						<th>표준세트</th>
						<td style="padding-right: 3px;">
							<div style="display: flex; align-items: center;">
								<input type="text" name="regPrjctStdSetNm" id="regPrjctStdSetNm" readonly/>
								<button class="btn sm" style="margin-left:4px" onclick="fnRegInitSelectStdSetBtn();" >초기화</button>
								<button class="btn sm" style="margin-left:4px" onclick="fnSearchStdSetNmBtn();" >검색</button>
							</div>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
		
		<div id="dbmsInfoTable">
			<div class="tbl_top padt10">
				<p class="tit v2 margin0">DBMS정보</p>
				<div class="btn_wrap">
					<button class="btn sm" style="display: none;" id="csvFileBackBtn1" onclick="fnCsvFileBackBtn('1'); return false;">이전</button>
					<button class="btn sm" style="display: none;" id="csvFileBackBtn2" onclick="fnCsvFileBackBtn('2'); return false;">이전</button>
					<button class="btn sm" style="display: none;" id="csvFileSaveBtn" onclick="fnCsvFileSaveBtn(); return false;">파일등록</button>
					<button class="btn sm" style="display: none;" id="csvFileNextBtn" onclick="fnCsvFileNextBtn(); return false;">다음</button>
					<button class="btn sm" style="display: none;" id="csvFileUploadBtn" onclick="fnCsvFileUploadBtn(); return false;">파일업로드</button>
					<button class="btn sm" style="display: none;" id="csvFileInitBtn" onclick="fnCsvFileInitBtn(); return false;">초기화</button>
				</div>
			</div>
			<div class="table_area">
				<table class="view">
					<colgroup>
					<col width = "15%" />
					<col width = "auto" />
					<col width = "15%" />
					<col width = "auto" />
					<col width = "15%" />
					<col width = "auto" />
					</colgroup>
					<tbody>
						<tr>
							<th>DBMS</th>
							<td colspan="5">
								<select name="regPrjctDbmsSn" id="regPrjctDbmsSn" >
									<option value="">선택</option>
								</select>
							</td>
						</tr>
					</tbody>
					<tbody id="dbmsInfo">
						<tr>
							<th>운영DB</th>
							<td  colspan="5">
								<div id="regPrjctOperYn">
									<input type="radio" name="prjctOperYn" id="prjctoperyn_y" value="Y"/>
									<label for="prjctoperyn_y" class="req">Y</label>
									<input type="radio" name="prjctOperYn" id="prjctoperyn_n" value="N"/>
									<label for="prjctoperyn_n" class="req">N</label>
								</div>
							</td>
						</tr>
						<tr>
							<th>DB서버IP</th>
							<td colspan="5">
								<input type="text" name="regPrjctDbmsIpAddr" id="regPrjctDbmsIpAddr" maxlength="200" />
							</td>
						</tr>
						<tr>
							<th>DB서버PORT</th>
							<td colspan="5">
								<input type="text" name="regPrjctDbmsPortNo" id="regPrjctDbmsPortNo" maxlength="10" />
							</td>
						</tr>
						<tr>
							<th>접속계정</th>
							<td colspan="5">
								<input type="text" name="regPrjctDbmsId" id="regPrjctDbmsId" maxlength="50" />
							</td>
						</tr>
						<tr>
							<th>비밀번호</th>
							<td colspan="5">
								<input style="text-indent: 0;" type="password" name="regPrjctDbmsPassword" id="regPrjctDbmsPassword" maxlength="50" />
							</td>
						</tr>
						<tbody id="chkPassword">
						<tr>
							<th>비밀번호확인</th>
							<td colspan="5">
								<input style="text-indent: 0;" type="password" name="regChkPrjctDbmsPassword" id="regChkPrjctDbmsPassword" maxlength="50" />
							</td>
						</tr>
						</tbody>	
						
						
						
						<tr id="tr_regdatabase">
							<th>DATABASE명</th>
							<td colspan="5">
								<input type="text" name="regPrjctDbmsDatabaseNm" id="regPrjctDbmsDatabaseNm" maxlength="100" />
							</td>
						</tr>
						<tr style="display: none;" id="tr_regschemanm">
							<th>SCHEMA명</th>
							<td colspan="5">
								<input type="text" name="regPrjctDbmsSchemaNm" id="regPrjctDbmsSchemaNm" maxlength="100" />
							</td>
						</tr>
						<tr style="display: none;" id="tr_regsidnm">
							<th>SID명</th>
							<td colspan="5">
								<input type="text" name="regPrjctDbmsSidNm" id="regPrjctDbmsSidNm" maxlength="100" />
							</td>
						</tr>
					</tbody>
					<tbody id="csvInfo" style="display: none;">
						<tr id="tr_dbsmsdatabasecn" style="display: none;">
							<th>진단데이터베이스명</th>
							<td colspan="5">
								<input type="text" name="regPrjctDbmsDatabaseCn" id="regPrjctDbmsDatabaseCn" disabled/>
							</td>
						</tr>
						<tr id="tr_csvfile" style="display: none;">
							<th>파일</th>
							<td style="padding-right: 3px;" colspan="5">
							 	<form name="viewFrm" id="viewFrm"  method="post" action="#" >
									<input type="hidden" id="csvFileNameHideValue" name="fileName" value="" />
									<input type="hidden" id="csvFilePathHideValue" name="path" value="" />
									<input type="hidden" id="culLineCnt" name="culLineCnt" value="" />
									<input type="hidden" id="delimiter" name="delimiter" value="" />
									<input type="hidden" id="escapeCharYn" name="escapeCharYn" value="" />
									<input type="hidden" id="osKnd" name="osKnd" value="" />
								</form>
								<form id="csvUploadFrm" name="csvUploadFrm" method="post" action="" enctype="multipart/form-data">
									<div style="display: flex; align-items: center;">
	                                    <input type="text" id="csvfileFullPath" name="csvfileFullPath" class="in_w80" value="파일선택" placeholder="파일선택" disabled="disabled">
	                                    <label for="csvFileName" style="margin-left:4px" id="csvFileNameLabel"  class="btn sm">파일 선택</label>
	                                    <input type="file" name="csvFileName" id="csvFileName" style="display: none;"/> 
									</div>
								</form>
							※ CSV 파일만 등록 가능합니다.<br>
							※ 파일명은 30자 이하로 영문/숫자만으로 되어 있어야 등록이 가능합니다.<br>
							※ 파일 내용의 컬럼은 250개 이하로 작성해야 등록이 가능합니다.
							</td>
						</tr>
					</tbody>
					
					<tbody id="csvDtlInfo" style="display: none;">
						<tr>
							<th>업로드 파일명</th>
							<td id="uploadFileNm">
							</td>
						</tr>
						<tr>
							<th>컬럼구분자</th>
							<td>
								<input type="text" id="csvDelimiter" name="delimiter" value=","/>
							</td>
							<th>헤더유무</th>
							<td>
								<select id='csvheaderYn' name='headerYn'>
                                	<option value="1">Y</option>
                                   	<option value="0">N</option>
								</select>
							</td>
							<th>Escape Char</th>
							<td>
                                <select id="csvEscapeCharYn" name="escapeCharYn">
                                    <option value="N" >default</option>
									<option value="Y" >"\""</option>
                                </select> 
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
	
		<div class="tbl_wrap" style="display: none;" id="dv_tb_list_table_div">
			<div class="tbl_wrap" style="height:300px;">
				<div class="card">
					<table id="tb_list_table" class="list margint0">
						<colgroup>
							<col width="5%"/>
							<col width="auto"/>
						</colgroup>
						<thead>
							<tr>
								<th>No</th>
								<th>데이터</th>
							</tr>
						</thead>											
						<tbody>
							<tr class="fwk_templete_row">
								<td>#{FWK_TR_NO}</td>
								<td>#{dataMap}</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		
		<div class="tbl_wrap" style="display: none;" id="dv_tb_resultlist_table_div">
			<div class="tbl_wrap" style="height:300px;">
				<div class="card">
					<table id="tb_resultlist_table" class="list margint0">
						<thead>
							<tr id="thead_tr">
							</tr>
						</thead>
						<tbody id="tbody_dataList">
						</tbody>
					</table>
				</div>
			</div>
		</div>
	
		<div id="dv_userlist_div" style="display: none;">
			<div class="tbl_top padt10">
				<p class="tit v2 margin0"><span>사용자조회</span></p>
				<div class="btn_wrap">
					<button class="btn sm" onclick="fnRegCloseCheckUserListBtn();" >닫기</button>
				</div>
			</div>
			<div class="search_wrap" >
				<table  class="search fixed" >
					<colgroup>
						<col width="10%" />
						<col width="auto" />
						<col width="5%" />
						<col width="10%" />
						<col width="auto" />
					</colgroup>
					<tbody>
						<tr>
							<th>권한그룹</th>
							<td>
								<div class="selectbox">
									<select id="regAuthrtCdSearch" name="regAuthrtCdSearch">
										<option value="">전체</option>
									</select>
								</div>
							</td>
							<td></td>
							<th scope="row"><label for="regUserNmSearch">사용자명</label></th>
							<td>
								<input type="text" class="in_w80" id="regUserNmSearch" name="regUserNmSearch" />
								<button class="btn sm" onclick="fnRegPrjctUserListFilterBtn();" >조회</button>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class="card">
				<div class="tbl_wrap" data-height="290">
					<table id="tb_userlist_table" class="list">
						<colgroup>
							<col style="width: 60px;" />
							<col style="width: auto;" />
							<col style="width: auto;" />
							<col style="width: auto;" />
							<col style="width: 100px;" />
						</colgroup>
						<thead>
							<tr>
								<th>NO</th>
								<th>권한그룹</th>
								<th>사용자아이디</th>
								<th>사용자명</th>
								<th>선택</th>
							</tr>
						</thead>											
						<tbody>
							<tr class="fwk_templete_row">
								<td>#{FWK_TR_NO}</td>
								<td>#{authrtNm}</td>
								<td>#{userId}</td>
								<td>#{userNm}</td>
								<td>
									<input type="checkbox" name="chkUserNm" data-authrtCd="#{authrtCd}" data-userid="#{userId}" data-usernm="#{userNm}" onclick="fnChkUserNm();" />
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
		
		
		
		<div id="dv_stdsetlist_div" style="display: none;">
			<div class="tbl_top padt10">
				<p class="tit v2 margin0"><span>표준세트조회</span></p>
				<div class="btn_wrap">
					<button class="btn sm" onclick="fnRegAddStdSet();" >추가</button>
					<button class="btn sm" onclick="fnRegCloseSelectStdSetListBtn();" >닫기</button>
				</div>
			</div>
			<div class="search_wrap" >
				<table  class="search fixed" >
					<colgroup>
						<col style="width: 100px;" />
						<col style="width: auto;" />
					</colgroup>
					<tbody>
						<tr>
							<th scope="row"><label for="regStdSetNmSearch">표준세트명</label></th>
							<td>
								<div style="display: flex; align-items: center;">
									<input type="text" class="in_w100" id="regStdSetNmSearch" name="regStdSetNmSearch" />
									<button class="btn sm" style="width: 80px; margin-left:4px" onclick="fnRegPrjctStdSetListSearchBtn();" >조회</button>
								</div>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
				<div class="card">
					<div class="tbl_wrap" data-height="235">
					<table id="tb_stdsetlist_table" class="list">
						<colgroup>
							<col style="width: 60px;" />
							<col style="width: auto;" />
							<col style="width: 100px;" />
							<col style="width: 100px;" />
							<col style="width: 100px;" />
							<col style="width: 100px;" />
						</colgroup>
						<thead>
							<tr>
								<th>NO</th>
								<th>표준세트 명</th>
								<th>단어 수</th>
								<th>도메인 수</th>
								<th>용어 수</th>
								<th>선택</th>
							</tr>
						</thead>											
						<tbody>
							<tr class="fwk_templete_row">
								<td>#{FWK_TR_NO}</td>
								<td>#{stdSetNm}</td>
								<td class="alignr">#fn{fnFormatNumber(#{wrdTotalCnt})}</td>
								<td class="alignr">#fn{fnFormatNumber(#{domnTotalCnt})}</td>
								<td class="alignr">#fn{fnFormatNumber(#{wordTotalCnt})}</td>
								<td>
									<button class="btn sm" data-stdsetsn="#{stdSetSn}" data-stdsetnm="#{stdSetNm}" onclick="fnRegSelectStdSetNmBtn(this);" >선택</button>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>

	<div class="pop_footer">
	</div>




<div class="popup layer" id="csv_modal" style="width:600px; height :200px;">
 	<div class="pop_header">
		<p class="title">csv설정</p>
		<button class="btn_ic btn_pop_close" id="closeModalBtn" onclick="fnCloseModal('csv_modal');">닫기</button>
	</div>
	<div class="pop_content">
		<div class="card">
			<table class="view">
				<colgroup>
					<col width="20%" />
					<col width="60%" />
					<col width="20%" />
				</colgroup>
				<tbody>
					<tr>
						<th>* 분석명</th>
						<td>
							<input type="text" name="" id=""  placeholder="20자리 이내로 입력" maxlength="20"/>
						</td>
						<td>
							<button class="btn sm" title="저장" name="saveBtn" onclick="fnSaveBtn(); return false;">저장</button>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	<div class="pop_footer">
	
	</div>
</div>



<script type="text/javascript">

$(document).ready(function() {
	
	fnInitRegPrjctForm();

	// 프로젝트사용자 필터 - 권한그룹
 	$("#regAuthrtCdSearch").change(function(){
 		prjctUserListFilter();
	});
	// 프로젝트사용자 필터 - 사용자명
	$("#regUserNmSearch").on("keyup", function(event) {
 		if (event.keyCode == 13){
 			prjctUserListFilter();
 		}
	});
	
	$("#regStdSetNmSearch").on("keyup", function(event) {
		if (event.keyCode == 13){
			fnRegPrjctStdSetListSearchBtn();
		}
	});
    $("#csvFileName").on("change", function(){
    	if ($(this).val() != "") {
    		
    		var fileName = $(this)[0].files[0].name;
    		$("#csvfileFullPath").val(fileName);
    		$("#csvFileNameHideValue").val(fileName);
    		$("#uploadFileNm").text(fileName);
    	} else {
    		$("#csvfileFullPath").val("");
    		$("#csvFileNameHideValue").val("");
    		$("#csvFilePathHideValue").val("");
    		$("#csvFileName").val("");
    		$("#uploadFileNm").text("");
    	}
    	//$("#csvFileSaveBtn").show();
    });
    
	$("#regPrjctDbmsPassword").change(function(){
		if($("#regPrjctPmodeHide").val() =="M"){
			$("#regChangeYnPassword").val("Y");
			$("#chkPassword").show();
		}
	});
    
});

//패스워드 확인
function fnChkPassword(pmode, chgYnPwd){
	var pwd1 = $("#regPrjctDbmsPassword").val();
	var pwd2 = $("#regChkPrjctDbmsPassword").val();
	
	if(pmode == "R"){
		if(pwd1 == pwd2){
			return true;
		} else {
			alert("비밀번호 확인해주세요.");
			return false;
		}
	} else {
		if(chgYnPwd == "Y"){
			if(pwd1 == pwd2){
				return true;
			} else {
				alert("비밀번호 확인해주세요.");
				return false;
			}	
		} else {
			return true;
		}
	}
}

// 파일등록 버튼
function fnCsvFileData(){
	 var form = $('#csvUploadFrm')[0];
	 var csvFile = new FormData(form);
	 
     $.ajax({
         url: '/dq/csvInfo/readCsvFileData'
         , method : 'POST'
         , enctype: 'multipart/form-data'
         , processData: false
         , contentType: false
         , cache: false
         , timeout: 600000
         , data: csvFile
         , success: function(data){
			var obj = JSON.parse(data);
            var attFileOutputFullPath= obj.attFileOutputFullPath;
            var csvDataList = obj.dataList;
            var osKnd = obj.osKnd;
            
            $("#osKnd").val(osKnd);
			$("#csvFilePathHideValue").val(attFileOutputFullPath);      //form hidden
			$("#dv_tb_list_table_div").show();
			fnBindTableValue("tb_list_table", obj.dataList);
			$("#csvFileBackBtn1").show();
			$("#csvFileNextBtn").show();
			$("#csvFileSaveBtn").hide();
         }
     });
     
}


// 파일 등록 버튼
function fnCsvFileSaveBtn(){
	
	
	var csvFileNameHideValue = $("#csvFileNameHideValue").val();
	
	if(csvFileNameHideValue != ""){
		
		var endLength = csvFileNameHideValue.lastIndexOf('.');
		var extensionName = csvFileNameHideValue.substr(endLength);
		csvFileNameHideValue = csvFileNameHideValue.substr(0, endLength);
		
 		// 30글자
 		if(csvFileNameHideValue.length > 30){
 			alert("파일명은 30자 이하로만 작성해야 가능합니다.");
            return false;
 		}
 		
 		if ((new RegExp(/[^a-z0-9_]/gi)).test(csvFileNameHideValue)) {
 			alert("파일명은 영문자/숫자 조합만 가능합니다.");
            return false;
		}
 		
		if (".csv" != extensionName) {
			alert("확장자 명이 csv 파일만 등록 가능합니다.");
			return false;
		}
			
		$("#csvInfo").hide();
		
		$("#csvDtlInfo").show();
		
	} else {
		alert("업로드할 파일을 선택해주세요.");
		return;
	}

	$("#prjctreginfo_modal").css("height", "830");
	fnCsvFileData();
	
}
// 이전
function fnCsvFileBackBtn(tab){
	
	if(tab == "1"){
		$("#prjctreginfo_modal").css("height", "750");
		$("#csvInfo").show();
		$("#csvDtlInfo").hide();
		$("#dv_tb_list_table_div").hide();
		
		$("#csvFileBackBtn1").hide();
		$("#csvFileSaveBtn").show();
		$("#csvFileNextBtn").hide();
		$("#csvFileUploadBtn").hide();
	} else {
		$("#prjctreginfo_modal").css("height", "830");
		
		$("#csvFileBackBtn1").show();
		$("#csvFileBackBtn2").hide();
		$("#csvFileNextBtn").show();
		$("#csvFileUploadBtn").hide();
		
		
		$("#csvInfo").hide();
		$("#csvDtlInfo").show();
		
		$("#dv_tb_list_table_div").show();
		$("#dv_tb_resultlist_table_div").hide();
	}
	
}
// 다음
function fnCsvFileNextBtn(){
	
	$("#csvFileBackBtn1").hide();
	$("#csvFileBackBtn2").show();
	
	
	$("#prjctreginfo_modal").css("height", "750");
	
	$("#delimiter").val($("#csvDelimiter").val());
	$("#culLineCnt").val($("#csvheaderYn").val());
	$("#escapeCharYn").val($("#csvEscapeCharYn").val());
	
	var csvDetailData = $('#viewFrm').serialize();
	
	
	$.ajax({
        url: '/dq/csvInfo/readCsvFileDataPaser',
        method : 'POST',
        data: csvDetailData,
        success: function(data){
        	var obj = JSON.parse(data);
    		$("#dv_tb_resultlist_table_div").find("#thead_tr th").remove();
    		$("#dv_tb_resultlist_table_div").find("#tbody_dataList tr").remove();
    		$("#csvFileBackBtn").show();
    		$("#csvFileNextBtn").hide();
    		$("#csvInfo").hide();
    		$("#csvDtlInfo").hide();
    		$("#dv_tb_list_table_div").hide();
    		$("#dv_tb_resultlist_table_div").show();
    		var arr = []; 
    		$.each(obj.columnList, function(){
    			var name = this.name;
    			arr.push(name);
				var th = "<th>"+this.header+"</th>";     			
				
    			$("#dv_tb_resultlist_table_div").find("#thead_tr").append(th);
    		});
    		
    		
			var dataList = obj.dataList;
			
			var html = "";
			for(var i = 0; i < dataList.length; i++) {
				var item = dataList[i];
				html += "<tr name="+i+">";
				for(var j = 0 ; j < arr.length ; j++) {
					
					var colNm = arr[j];
					var data = item[colNm];
					
					html += "<td name="+j+">"+data+"</td>";	
				}
				html += "</tr>";
			}
			$("#dv_tb_resultlist_table_div").find("#tbody_dataList").append(html);
			$("#csvFileUploadBtn").show();
        }
    });
}

// 파일업로드
function fnCsvFileUploadBtn(){
	$("#regCheckCsv").val("Y");
	$("#csvInfo").show();
	$("#csvDtlInfo").hide();
	$("#csvFileSaveBtn").hide();
	$("#csvFileBackBtn1").hide();
	$("#csvFileBackBtn2").hide();
	$("#csvFileNextBtn").hide();
	$("#csvFileUploadBtn").hide();
	$("#dv_tb_list_table_div").hide();
	$("#dv_tb_resultlist_table_div").hide();
	$("#csvFileNameLabel").hide();
	
	$("#csvFileInitBtn").show();
}
// 초기화
function fnCsvFileInitBtn(){
	$("#csvfileFullPath").val("");
	$("#csvFileNameHideValue").val("");
	$("#csvFilePathHideValue").val("");
	$("#csvFileName").val("");
	$("#uploadFileNm").text("");
	
	$("#culLineCnt").val("");
	$("#escapeCharYn").val("");
	$("#delimiter").val("");
	$("#regCheckCsv").val("N");
	
	$("#csvFileInitBtn").hide();
	$("#csvFileSaveBtn").show();
	$("#csvFileNameLabel").show();
}


function fnInitRegPrjctForm() {
	new CodeBinder()
		.setSqlCode("cmmn_project.selectDbmsList", "regPrjctDbmsSn", "select")
		.setSqlCode("cmmn_project.selectAuthorList","regAuthrtCdSearch", "select")
		.setLoadCallbackFunc("fnCodeLoadCallbackRegPrjct()")
		.load();
}

function fnCodeLoadCallbackRegPrjct() {

	// 프로젝트사용자 필터 - 권한그룹
 	$("#regAuthrtCdSearch").change(function(){
 		prjctUserListFilter();
	});

	$("#regPrjctDbmsSn").change(function(){
		//var dbmsNm = $("#regPrjctDbmsSn option:selected").data("extval");
		
		$("#regPrjctDbmsSchemaNm").val("");	// SCHEMA명
		$("#regPrjctDbmsSidNm").val("");	// SID명
		
		fnChangeDbmsInfoTr($("#regPrjctDbmsSn option:selected").data("extval"), $("#regPrjctPmodeHide").val());
	});
}


function fnRegPrjctSearch() {
	fnRegCloseSelectStdSetListBtn();
	fnRegCloseCheckUserListBtn();
	
	var prjctSn = $("#regPrjctSnHide").val();
	var stdSetSn = $("#regPrjctStdSetSnHide").val();
	var pmode = $("#regPrjctPmodeHide").val();
	
	$("#regChangeYnPassword").val("N");	
	$("#regPrjctUserNm").empty();
	$("#regChkPrjctDbmsPassword").val("");
	if (pmode == "M") {
		$.ajax({
			url : "/json/project/getProjectInfo"
			, method : "POST"
			, contentType : 'application/json'
			, data : JSON.stringify({
				prjctSn : prjctSn
				, stdSetSn : stdSetSn
				, pmode : pmode
			})
			, success : function(data) {
				
				var prjctInfo = data.prjctInfo;
				var userList = data.userList;
				var userIdHideVal ="";
				
 				$.each(userList, function(){
 					var userNm = $(this).attr("userNm");
 					var userId = $(this).attr("userId");
 					
 					userIdHideVal += userId+",";
 					fnAddUserNmLi(userId, userNm);
				});
				userIdHideVal = userIdHideVal.substr(0, userIdHideVal.length-1);
				
				if(prjctInfo.dbmsPassword == ""){
					$("#chkPassword").show();
				}
				
				$("#regPrjctStdSetSnHide").val(prjctInfo.stdSetSn);		// hidden value 표준세트번호
				$("#regPrjctDbmsCnncSnHide").val(prjctInfo.dbmsCnncSn);	// hidden value DBMS연결순번
				$("#regPrjctSnHide").val(prjctInfo.prjctSn);			// hidden value 프로젝트순번
				$("#regPrjctUserIdHide").val(userIdHideVal); 			// hidden value 프로젝트사용자
				
				$("#regPrjctNm").val(prjctInfo.prjctNm); 			// 프로젝트명
				$("#regPrjctCn").val(prjctInfo.prjctCn); 			// 프로젝트설명
				$("#regPrjctStdSetNm").val(prjctInfo.stdSetNm); 	// 표준세트명
			
				$("#regPrjctDbmsSn").val(prjctInfo.dbmsSn);													// DBMS
				$("input:radio[name=prjctOperYn]:input[value="+prjctInfo.operYn+"]").prop("checked", true);	// 운영DB
				$("#regPrjctDbmsIpAddr").val(prjctInfo.dbmsIpAddr);											// DB서버IP
				$("#regPrjctDbmsPortNo").val(prjctInfo.dbmsPortNo);											// DB서버PORT
				$("#regPrjctDbmsId").val(prjctInfo.dbmsId);													// 접속계정
				$("#regPrjctDbmsPassword").val(prjctInfo.dbmsPassword);										// 비밀번호
				$("#regPrjctDbmsDatabaseNm").val(prjctInfo.dbmsDatabaseNm);									// DATABASE명
				$("#regPrjctDbmsSchemaNm").val(prjctInfo.dbmsSchemaNm);										// SCHEMA명
				$("#regPrjctDbmsSidNm").val(prjctInfo.dbmsSidNm);											// SID명
				$("#regPrjctDbmsDatabaseCn").val(prjctInfo.dbmsDatabaseCn);									
				fnChangeDbmsInfoTr(prjctInfo.dbmsNm , pmode);
			}
		});
	} else {
		$("#regPrjctDbmsSn").attr("disabled", false);
		$("#regPrjctStdSetSnHide").val("");							// hidden value 표준세트번호
		$("#regPrjctDbmsCnncSnHide").val("");						// hidden value DBMS연결순번
		$("#regPrjctSnHide").val("");								// hidden value 프로젝트순번
		$("#regPrjctUserIdHide").val(""); 							// hidden value 프로젝트사용자
		
		$("#regPrjctNm").val("");									// 프로젝트명
		$("#regPrjctCn").val("");									// 프로젝트설명
		$("#regPrjctStdSetNm").val(""); 							// 표준세트명

		$("#regPrjctDbmsSn").val("");								// DBMS
		$("input:radio[name=prjctOperYn]").prop("checked",false);	// 운영DB
		$("#regPrjctDbmsIpAddr").val("");							// DB서버IP
		$("#regPrjctDbmsPortNo").val("");							// DB서버PORT
		$("#regPrjctDbmsId").val("");								// 접속계정
		$("#regPrjctDbmsPassword").val("");							// 비밀번호
		$("#regPrjctDbmsDatabaseNm").val("");						// DATABASE명
		$("#regPrjctDbmsSchemaNm").val("");							// SCHEMA명
		$("#regPrjctDbmsSidNm").val("");							// SID명
		$("#regPrjctDbmsDatabaseCn").val("");
		
		fnChangeDbmsInfoTr("", $("#regPrjctPmodeHide").val());
	}
	fnRegPrjctUserListSearchBtn();
	$("#dbmsInfo").show();
	$("#csvInfo").hide();
}

// 프로젝트 사용자 추가 html
function fnAddUserNmLi(userId, userNm){
	var html = "";
		html +='<li class="li_usernm" value='+userId+'>'+userNm+'';
		html +='<button style="margin:1px;" data-userid ='+userId+' onclick="fnRemoveUserNmBtn(this);"><span class="text_icon">X</span></button>';
		html +='</li>';
		$("#regPrjctUserNm").append(html); 
}

// 프로젝트 사용자 조회
function fnRegPrjctUserListSearchBtn(){
	var userNm = $("#regUserNmSearch").val();
	var authrtCd = $("#regAuthrtCdSearch").val();
	
	$.ajax({
		url : "/json/project/getProjectUserList"
		, method : "POST"
		, contentType : 'application/json'
		, data : JSON.stringify({
			userNm : fnUnderbarChgVar(userNm)
			, authrtCd : authrtCd 
		})
		, success: function(data){
			var list = data.list;
			fnBindTableValue("tb_userlist_table", list);
			
		}
	});
}

function chkUserInfo(){
	var userIdHide = [];
	
	userIdHide = $("#regPrjctUserIdHide").val().split(",");
	
	
	if (userIdHide!="") {
		$.each(userIdHide, function(){
			$("#tb_userlist_table tr.fwk_data_row").each(function(){
				var userId = $(this).find("input:checkbox[name=chkUserNm]").data("userid");
					if (userIdHide.indexOf(userId) != -1) {
					$(this).find("input:checkbox[name=chkUserNm]").prop("checked", true);
				}
			});
		});
	}
}

//프로젝트사용자 권한그룹 필터
function prjctUserListFilter(){
	
	var selectBoxVal = $("#regAuthrtCdSearch").val();
	var textVal = $("#regUserNmSearch").val();
	
	$("#tb_userlist_table tr.fwk_data_row").filter(function(){
		var userNm = $(this).find("input:checkbox[name=chkUserNm]").data("usernm");
		var authrtCd = $(this).find("input:checkbox[name=chkUserNm]").data("authrtcd");
		
		if (selectBoxVal == "") {
			if(textVal == ""){
				$(this).show();	
			} else {
				if (userNm.indexOf(textVal) !== -1) {
					$(this).show();		
				} else {
					$(this).hide();
				}
			}
		} else {
			if (textVal == "") {
				if(selectBoxVal == authrtCd){
					$(this).show();
				} else{
					$(this).hide();
				}
			} else {
				if(selectBoxVal == authrtCd && textVal == userNm){
					$(this).show();
				} else {
					$(this).hide();
				}
			}
		}
		
	});
}

// 프로젝트사용자 필터 조회 버튼
function fnRegPrjctUserListFilterBtn(){
	prjctUserListFilter();
}

// 프로젝트사용자 선택
function fnChkUserNm(){
	var chkUserId = [];

	$("#regPrjctUserNm").find("li").remove();
	
	$("input:checkbox[name=chkUserNm]:checked").each(function(){
		var userNm = $(this).data("usernm");
		var userId = $(this).data("userid");
		fnAddUserNmLi(userId, userNm);
		chkUserId += userId+",";
	});
	if(chkUserId !=""){
		chkUserId = chkUserId.substr(0, chkUserId.length-1)
	}
	$("#regPrjctUserIdHide").val(chkUserId)
	
}
// 프로젝트사용자 제거
function fnRemoveUserNmBtn(obj){
	var userId = $(obj).data("userid");
	
	var regPrjctUserIdHideVal = $("#regPrjctUserIdHide").val();
	var regPrjctUserIdHideArr = [];
	
	regPrjctUserIdHideArr = regPrjctUserIdHideVal.split(",");
	
	for(var i =0; i<regPrjctUserIdHideArr.length;i++){
		var userIdArr = regPrjctUserIdHideArr[i];
		if(userIdArr === userId){
			regPrjctUserIdHideArr.splice(i,1);
			i--;
		}
	}
	
	$("#regPrjctUserIdHide").val(regPrjctUserIdHideArr);
	
	$("input:checkbox[name=chkUserNm]:checked").each(function(){
		var chkdUserId = $(this).data("userid");
		if(userId == chkdUserId){
			$(this).prop("checked",false);
		}
	});
	
	$("#regPrjctUserNm .li_usernm").each(function(){
		if($(this).attr("value") == userId){
			$(this).remove();
		}
	});
}

// 프로젝트 저장 버튼
function fnRegPrjctSaveBtn(){
	
	fnRegCloseSelectStdSetListBtn();
	fnRegCloseCheckUserListBtn();
	
	if(!fnCheckValid("#regPrjctNm", "프로젝트명"))
		return;
	
	var stdSetSn = $("#regPrjctStdSetSnHide").val();
	var dbmsSn = $("#regPrjctDbmsSn").val();
	var pmode = $("#regPrjctPmodeHide").val();
	var chgYnPwd = $("#regChangeYnPassword").val();
	/* if (stdSetSn == "" || dbmsSn =="") {
		alert("표준세트 및 DBMS 정보를 입력하지 않으면 메타시스템 기능이 제한될 수 있습니다.");
	} */


	
	var prjctInfo ={
			stdSetSn : stdSetSn
			, prjctNm : $("#regPrjctNm").val()
			, prjctSn : $("#regPrjctSnHide").val()
			, prjctCn : $("#regPrjctCn").val()
			, chkUserId : $("#regPrjctUserIdHide").val()
	};

	var dbmsInfo = {dbmsSn : dbmsSn , dbmsCnncSn : $("#regPrjctDbmsCnncSnHide").val()};
	
	if (dbmsSn != "") {
		var dbmsNm = $("#regPrjctDbmsSn :selected").data("extval");
		var dbmsDetailInfo = {};
		
		
		if(dbmsNm == "CSV"){
			if(pmode != "M"){
				
				var csvFilePathHideValue = $("#csvFilePathHideValue").val();
				if(csvFilePathHideValue == "" ){
					alert("업로드할 파일을 선택해주세요.");
					return;
				}
				var checkCsv = $("#regCheckCsv").val();
				
				if(checkCsv =="Y"){
					dbmsDetailInfo.fileName = $("#csvFileNameHideValue").val();
					dbmsDetailInfo.culLineCnt = $("#culLineCnt").val();
					dbmsDetailInfo.delimiter = $("#delimiter").val();
					dbmsDetailInfo.attFilePath = csvFilePathHideValue;
					dbmsDetailInfo.escapeCharYn = $("#escapeCharYn").val();
					dbmsDetailInfo.osKnd = $("#osKnd").val();
				} else {
					return;
				}
			}
			
			
		} else {
			if(!fnChkPassword(pmode, chgYnPwd)){
				return;
			}
			dbmsDetailInfo.operYn = $("input:radio[name=prjctOperYn]:checked").val();
			dbmsDetailInfo.dbmsIpAddr = $("#regPrjctDbmsIpAddr").val();
			dbmsDetailInfo.dbmsPortNo = $("#regPrjctDbmsPortNo").val();
			dbmsDetailInfo.dbmsId = $("#regPrjctDbmsId").val();
			dbmsDetailInfo.dbmsDatabaseNm = $("#regPrjctDbmsDatabaseNm").val();
			dbmsDetailInfo.dbmsSchemaNm = $("#regPrjctDbmsSchemaNm").val();
			dbmsDetailInfo.dbmsSidNm = $("#regPrjctDbmsSidNm").val();
			var password = $("#regPrjctDbmsPassword").val();
			if(pmode=="M"){
				if(chgYnPwd == "Y"){
					dbmsDetailInfo.dbmsPassword = fnGenerateToken({"dbmsPassword": password});
				}
				dbmsDetailInfo.chgYnPwd = chgYnPwd;
			} else {
				dbmsDetailInfo.dbmsPassword = fnGenerateToken({"dbmsPassword": password});
			}
			
		}
		dbmsDetailInfo.dbmsNm = dbmsNm;

		$.extend(dbmsInfo, dbmsDetailInfo); 
	}	

	var pagingNo ="";
	$("#dv_paging .on a").each(function(){
		pagingNo = $(this).text();
	});
	
	
	if(!confirm("저장 하시겠습니까?")) 
		return;
		
	$.ajax({
		url : "/json/project/saveProjectInfo"
		, method : "POST"
 		, contentType : 'application/json'
		, data : JSON.stringify({
			prjctInfo : prjctInfo
			, dbmsInfo : dbmsInfo
			, pmode : pmode
		})
		, success: function(data){
			if(data.resultCd == "OK") {
				alert("저장이 완료 되었습니다.");
				if(pmode == "M"){
					
					var myPrjctSn = parent.$("#topgv_prjctSn").val();

					if(myPrjctSn == prjctInfo.prjctSn){
						fnLogout();
					}
					
				}
				fnCloseModal('prjctreginfo_modal');
				fnPrjctSearch(pagingNo);
				
			} else{
				alert("실패하셨습니다.");
			}
		}
		
	});
	
}

//프로젝트사용자 추가 버튼
function fnUserAddBtn(){
	chkUserInfo();
	if($("#dv_stdsetlist_div").css("display") != "none"){
		fnRegCloseSelectStdSetListBtn();
	}

	$("#tr_prjctcn").hide();
	$("#tr_stdsetnm").hide();
	$("#dbmsInfoTable").hide();
	$("#dv_userlist_div").show();
}

// 프로젝트사용자 닫기 버튼
function fnRegCloseCheckUserListBtn() {
	// fnChangeSelectVal("regAuthrtCdSearch");
	$("#regAuthrtCdSearch").find("option[value='']").prop("selected", true);
	
	$("#regUserNmSearch").val("");
	prjctUserListFilter();
	$("#tr_prjctcn").show();
	$("#tr_stdsetnm").show();
	$("#dbmsInfoTable").show();
	$("#dv_userlist_div").hide();
}

//프로젝트표준세트 검색 버튼
function fnSearchStdSetNmBtn(){
	if($("#dbmsInfoTable").css("display") != "none"){
		fnRegPrjctStdSetListSearchBtn();
	}
	$("#dbmsInfoTable").hide();
	$("#dv_stdsetlist_div").show();
}

// 프로젝트표준세트 검색 닫기 버튼
function fnRegCloseSelectStdSetListBtn(){
	$("#regStdSetNmSearch").val("");
	$("#dbmsInfoTable").show();
	$("#dv_stdsetlist_div").hide();
	fnRegCloseAddStdSet();
}

// 표준세트 선택 초기화
function fnRegInitSelectStdSetBtn(){
	$("#regPrjctStdSetSnHide").val("");
	$("#regPrjctStdSetNm").val("");
}

// 프로젝트표준세트 조회
function fnRegPrjctStdSetListSearchBtn(){
	$.ajax({
		url : "/json/stdSet/getPrjctStdSetList"
		, method : "POST"
		, contentType : 'application/json'
		, data : JSON.stringify({
			searchText : fnUnderbarChgVar($("#regStdSetNmSearch").val())
		})
		, success: function(data){
			var list = data.list;
			
			fnBindTableValue("tb_stdsetlist_table", list);
		}
	});
}

// 프로젝트표준세트 선택
function fnRegSelectStdSetNmBtn(obj){
	var stdSetSn = $(obj).data("stdsetsn");
	var stdSetNm = $(obj).data("stdsetnm");
	$("#regPrjctStdSetSnHide").val(stdSetSn);
	$("#regPrjctStdSetNm").val(stdSetNm);
	fnRegCloseSelectStdSetListBtn();
	
}

// 프로젝트표준세트 추가
function fnRegAddStdSet(){
	if ($("#tr_addstdset").length == 0) {
		var html = ""
			html += '<tr class="fwk_add_row" id="tr_addstdset">'
			html += '<td>-</td>'
			html += '<td><input type="text" class="in_w98" id="stdSetNm" name="stdSetNm" maxlength="100" placeholder="100자 이내로 입력해주세요" /></td>'
			html += '<td><button class="btn sm" onclick="fnRegSaveStdSetBtn();" >저장</button></td>'
			html += '</tr>';
			$("#tb_stdsetlist_table tbody").prepend(html);
			
			$("#stdSetNm").focus();
	}

}

// 프로젝트표준세트 신규 저장 버튼
function fnRegSaveStdSetBtn(){
	
	var stdSetNm = $("#stdSetNm").val();
		
	if (!fnCheckValid("#stdSetNm", "표준세트명"))
		return;

	if(!confirm("저장 하시겠습니까?")) 
		return;
	
	$.ajax({
		url: "/json/stdSet/saveDataStdSetInfo"
		, method : "POST"
		, contentType : 'application/json'
		, data: JSON.stringify({
			pmode : "R"
			, stdSetNm : stdSetNm
		})
		, success: function(data){
			alert("저장되었습니다.");
			$("#regStdSetNmSearch").val("");
			fnRegCloseAddStdSet();
			fnRegPrjctStdSetListSearchBtn();
		}
	}); 
}

// 표준세트 추가 닫기
function fnRegCloseAddStdSet(){
	$("#tr_addstdset").remove();
}

// DBMS별 DBMS정보 작성란 변경 (SCHEMA, SID) 
function fnChangeDbmsInfoTr(dbmsNm, pmode){
	if(dbmsNm !="" && dbmsNm != null && dbmsNm != undefined){
		dbmsNm = dbmsNm.toUpperCase();
	}
	$("#csvFileBackBtn").hide();
	$("#dv_tb_list_table_div").hide();
	$("#regPrjctDbmsSn").attr("disabled", false);
	
	if(dbmsNm == "CSV"){
		
		$("#dbmsInfo").hide();
		$("#csvInfo").show();
		$("#csvFileSaveBtn").show();
		
		$("#chkPassword").hide();
		$("#tr_regsidnm").hide();
		$("#tr_regschemanm").hide();
		$("#tr_regdatabase").hide();
		if(pmode == "M"){
			$("#regCheckCsv").val("Y");
			$("#regPrjctDbmsSn").attr("disabled", true);
			$("#tr_dbsmsdatabasecn").show();
			$("#tr_csvfile").hide();
			$("#csvFileSaveBtn").hide();
		} else {
			$("#regCheckCsv").val("N");
			$("#tr_dbsmsdatabasecn").hide();
			$("#tr_csvfile").show();
			$("#csvFileSaveBtn").show();
		}
		
	} else {
		$("#csvFileNameHideValue").val("");
		$("#csvFilePathHideValue").val("");
		$("#csvfileFullPath").val("")
		$("#csvFileName").val("");
		
		$("#csvInfo").hide();
		$("#csvDtlInfo").hide();
		$("#csvFileSaveBtn").hide();
		
		$("#dbmsInfo").show();
		// SID 추가 Oracle, Tibero
		if (dbmsNm == "ORACLE" || dbmsNm == "TIBERO") {
			$("#tr_regsidnm").show();
		} else {
			$("#tr_regsidnm").hide();
		}
		
		// Schema 추가 PostgreSQLSQL, Altibase, DB2
		if (dbmsNm == "POSTGRESQL" || dbmsNm == "ALTIBASE" || dbmsNm == "DB2"){
			$("#tr_regschemanm").show();
		} else {
			$("#tr_regschemanm").hide();
		}
		
		if (dbmsNm == "VOLTDB"){
			$("#tr_regdatabase").hide();
		} else {
			$("#tr_regdatabase").show();
		}
	}
}

// 연결 테스트
function fnRegCnctDbmsTestBtn() {
	
	var pmode = $("#regPrjctPmodeHide").val();
	
	if($("#regPrjctDbmsSn option:selected").val() == "") {
		alert("DBMS를 선택해주세요");
		$("#regPrjctDbmsSn").focus();
		return;
	}

	var dbmsNm = ($("#regPrjctDbmsSn option:selected").text()).toUpperCase();


	if(!fnCheckValid("#regPrjctDbmsIpAddr", "DB서버IP"))
		return;
	if(!fnCheckValid("#regPrjctDbmsPortNo", "DB서버PORT"))
		return;
	if(!fnCheckValid("#regPrjctDbmsId", "접속계정"))
		return;
	//if(!fnCheckValid("#regPrjctDbmsPassword", "비밀번호"))
	//	return;
		
		
	if(dbmsNm != "VOLTDB") {
		if(!fnCheckValid("#regPrjctDbmsDatabaseNm", "DATABASE명"))
			return;
	}	
	
	if(dbmsNm == "ORACLE" || dbmsNm == "TIBERO") {
		if(!fnCheckValid("#regPrjctDbmsSidNm", "SID명"))
			return;
	}
	
	if(dbmsNm == "DB2"){
		if(!fnCheckValid("#regPrjctDbmsSchemaNm", "SCHEMA명"))
			return;
	}
		
	var chgYnPwd = $("#regChangeYnPassword").val();
	
	var inputPwdYn = "N";
	var testPwd = "";
	
	if(pmode == "M") {
		if(chgYnPwd != "Y") {
			testPwd = prompt('DBMS 접속 비밀 번호을 입력해주세요');
			inputPwdYn = "Y";
		} else {
			testPwd = $("#regPrjctDbmsPassword").val();
		}
	} else {
		// 신규일때
		if(!fnCheckValid("#regPrjctDbmsPassword", "비밀번호"))
			return;
		testPwd = $("#regPrjctDbmsPassword").val();
	}
	 
	
	if(!confirm("연결 테스트 하시겠습니까?"))
		return;
		
		
		
	$.ajax({
		url : "/json/DbmsConn/doConnectionTestDirct",
		method : "POST",
		contentType : 'application/json',
		data : JSON.stringify({
			dbmsNm : dbmsNm
			, dbmsId : $("#regPrjctDbmsId").val()
			, dbmsPassword : testPwd
			, dbmsIpAddr : $("#regPrjctDbmsIpAddr").val()
			, dbmsPortNo : $("#regPrjctDbmsPortNo").val()
			, dbmsSidNm : $("#regPrjctDbmsSidNm").val()
			, dbmsDatabaseNm : $("#regPrjctDbmsDatabaseNm").val()
			, dbmsSchemaNm : $("#regPrjctDbmsSchemaNm").val()
		}),
		success : function(data) {
			if(data.result == true){
				
				alert(data.message);
				
				if(inputPwdYn == "Y") {
					$("#regPrjctDbmsPassword").val(testPwd);
					$("#regChkPrjctDbmsPassword").val(testPwd);
				}
			} else {
				alert(data.message);
			}
		}
	});
	
	
}


</script>
</th:block>