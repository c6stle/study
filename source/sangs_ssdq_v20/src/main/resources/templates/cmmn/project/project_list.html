<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/mainLayout">
<head>
	<th:block th:replace="fragments/head_inc :: head_inc" />
</head>
<body>
	<div id="wrap">
		<div class="container">
			<div id="content">
			
				<div class="page_info_area">
					<div class="left">
						<div class="title_area">
							<p>프로젝트 관리</p>
							<a href="#" class="reload_btn" title="새로고침">새로고침</a>
						</div>
					</div>
					<div class="right">
						<div class="button_area">
							<button class="btn" title="신규등록" onclick="fnPrjctRegBtnModal('R'); return false;">신규등록</button>
							<button class="btn" title="조회" onclick="fnPrjctSearch(); return false;">조회</button> 
						</div>
					</div>
				</div><!-- page_info_area -->
				
				<div class="content_area">
					<div class="division20">
						<div class="search_wrap">
							<table class="search fixed">
								<colgroup>
									<col style="width: 100px;" />
									<col style="width: auto;" />
									<col style="width: 60px;" />
									<col style="width: 100px;" />
									<col style="width: auto;" />
								</colgroup>
								<tbody>
									<tr>
										<th scope="row"><label for="dbmsSn">DBMS구분</label></th>
										<td>
											<div class="selectbox">
												<select id="dbmsSn" name="dbmsSn">
													<option value="">전체</option>
												</select>
											</div>
										</td>
										<td></td>
										<th scope="row"><label for="stdSetSn">표준세트구분</label></th>
										<td>
											<div class="selectbox">
												<select id="stdSetSn" name="stdSetSn">
													<option value="">전체</option>
												</select>
											</div>
										</td>
									</tr>
									<tr>
										<th scope="row"><label for="">검색 조건</label></th>
										<td>
											<div style="display: flex; align-items: center;">
												<div class="selectbox" style="margin-right: 5px;">
													<select id="selectSearch" name="selectSearch" style="width: 140px;">
														<option value="">선택</option>
														<option value="prjctNm">프로젝트명</option>
														<option value="dbmsIpAddr">DB서버IP</option>
														<option value="dbmsPortNo">DB서버PORT</option>
														<option value="dbmsId">DB접속계정</option>
														<option value="dbmsDatabaseNm">DB명</option>
													</select>
												</div>
												<input type="text" class="in_w75" id="searchText" name="searchText" placeholder="검색어를 입력하세요." />
											</div>
										</td>
										<td></td>
										<th scope="row"><label for="operYn">운영DB여부</label></th>
										<td>
											<div class="selectbox">
												<select id="operYn" name="operYn">
													<option value="">전체</option>
													<option value="Y">Y</option>
													<option value="N">N</option>
												</select>
											</div> 
										</td>
									</tr>
								</tbody>
							</table>
						</div><!-- search_wrap -->
					</div><!-- division20 -->
					
					<div class="division20">
						<div class="row marginb25">
							<div class="left" data-width="0">
								<div class="card">
									<table class="list fixed" id="tb_prjctlist_table">
										<colgroup>
											<col style="width:5%;"/>
											<col style="width:20%;"/>
											<col style="width:10%" />
											<col style="width:10%" />
											<col style="width:10%" />
											<col style="width:10%" />
											<col style="width:10%" />
											<col style="width:5%" />
											<col style="width:20%"/>
										</colgroup>
										<thead>
											<tr>
												<th>No</th>
												<th>프로젝트명</th>
												<th>DBMS</th>
												<th>DB서버IP</th>
												<th>PORT</th>
												<th>DB접속계정</th>
												<th>DB명</th>
												<th>운영DB</th>
												<th>표준세트</th>
											</tr>
										</thead>
										<tbody>
											<tr class="fwk_templete_row">
												<td>#{FWK_TR_NO}
													<input type="hidden" name="prjctSn" value="#{prjctSn}" />
													<input type="hidden" name="dbmsCnncSn" value="#{dbmsCnncSn}" />
													<input type="hidden" name="stdSetSn" value="#{stdSetSn}" /> 
												</td>
												<td class="alignl">#{prjctNm}</td>
												<td>#{dbmsNm}</td>
												<td>#{dbmsIpAddr}</td>
												<td>#{dbmsPortNo}</td>
												<td>#{dbmsId}</td>
												<td>#{dbmsDatabaseNm}</td>
												<td>#{operYn}</td>
												<td class="alignl">#{stdSetNm}</td>
											</tr>
										</tbody>
									</table>
									<div id="dv_paging" class="pagination_area">
									</div><!-- pagination_area -->
								</div><!-- card -->
							</div><!-- left -->
							
							<div class="right" data-width="420">
								<div class="view_wrap" id="dv_rightPanel">
								
									<div class="tbl_top">
										<p class="tit v2">
											<span> 프로젝트 정보</span>
										</p>
										<div class="btn_area">
											<button class="btn sm" id="prjctCnctDbmsTest" onclick="fnPrjctCnctDbmsTest();">연결테스트</button>
											<button class="btn sm" id="prjctModifyBtn" onclick="fnPrjctRegBtnModal('M'); return false;" style="width:60px !important">수정</button>
											<button class="btn sm" id="prjctDeleteBtn" onclick="fnPrjctDeleteBtn('D');" style="width:60px !important">삭제</button>
										</div>
									</div><!-- tbl_top -->
									
									<table class="view">
										<colgroup>
											<col width="40%" />
											<col width="60%" />
										</colgroup>
										<tbody>
											<tr>
												<th>프로젝트 순번</th><td id="dtlview_prjctsn"></td>
											</tr>
											<tr>
												<th>프로젝트 명</th><td id="dtlview_prjctnm"></td>
											</tr>
											<tr>
												<th>프로젝트 사용자</th>	<td id="dtlview_usernm"></td>
											</tr>
											<tr>
												<th>프로젝트 설명</th><td id="dtlview_prjctcn"></td>
											</tr>
											<tr>
												<th>표준세트</th><td id="dtlview_stdsetnm"></td>
											</tr>
										</tbody>
									</table>
									
									<div class="tbl_top margint20">
										<p class="tit v2">
											<span> DBMS 정보</span>
										</p>
										<div>
											<label>&nbsp;</label>
										</div>
									</div>
									
									<table class="view">
										<colgroup>
											<col width="40%" />
											<col width="60%" />
										</colgroup>
										<tbody>
											<tr>
												<th>DBMS</th><td id="dtlview_dbmsnm"></td>
											</tr>
											<tr  id="tr_database_cn" style="display: none;">
												<th>진단데이터베이스명</th><td id="dtlview_dbmsdatabasecn"></td>
											</tr>
											<tbody id="dbmsIfo">
												<tr>
													<th>운영DB</th><td id="dtlview_operyn"></td>
												</tr>
												<tr>
													<th>DB 서버 IP</th><td id="dtlview_dbmsipaddr"></td>
												</tr>
												<tr>
													<th>DB 서버 PORT</th>	<td id="dtlview_dbmsportno"></td>
												</tr>
												<tr>
													<th>접속계정</th><td id="dtlview_dbmsid"></td>
												</tr>
												<tr>
													<th>비밀번호</th><td id="dtlview_dbmspassword"></td>
												</tr>
												<tr id="tr_database">
													<th>DATABASE명</th><td id="dtlview_dbmsdatabasenm"></td>
												</tr>
												<tr id="tr_schemanm" style="display: none;">
													<th>SCHEMA명</th><td id="dtlview_dbmsschemanm"></td>
												</tr>
												<tr id="tr_sid" style="display: none;">
													<th>SID</th><td id="dtlview_dbmssidnm"></td>
												</tr>
											</tbody>
										</tbody>
									</table>
									
								</div><!-- view_wrap -->
							</div><!-- right -->
						</div><!-- row -->
						
					</div><!-- division20 -->
				</div><!-- content_area -->
			</div><!-- content -->
		</div><!-- container -->
	</div><!-- wrap -->

<!-- 신규등록 및 수정  -->
<div class="popup layer" id="prjctreginfo_modal" style="width:1200px;">
	<th:block th:replace="cmmn/project/project_list_reg_inc :: project_list_reg_inc" />
</div>

<script type="text/javascript">

$(document).ready(function() {

	try {
		// 왼쪽 메뉴 선택 처리 (링크로 해당 페이지 들어온경우 오른쪽 메뉴를 선택 처리 한다. )
		parent.fnSelectLeftMenu(location.pathname);
	} catch(e) {}
	
	
	
	$("#searchText").on("keyup", function(event) {
		if (event.keyCode == 13){
			if($("#selectSearch").val() !=""){
				fnPrjctSearch();
			} else{
				alert("검색 조건을 선택해주세요.");
			}
		}
	});

	//수정버튼 hidden
	$("#prjctModifyBtn").hide();
	$("#prjctDeleteBtn").hide();
	fnPrjctInit();

});

function fnPrjctInit() {

	//DBMS구분, 표준세트구분
	new CodeBinder()
		.setSqlCode("cmmn_project.selectDbmsList", "dbmsSn", "select")
		.setSqlCode("meta_stdset.selectStdSetList:stdSetTyCd=NONE", "stdSetSn", "select")
		.setLoadCallbackFunc("fnPrjctSearch()")
		.load();

}

//검색 조건
var getPrjctSearchParamObj = function(){
	var paramObj = {
			dbmsSn : $("#dbmsSn").val()
			, stdSetSn : $("#stdSetSn").val()
			, operYn : $("#operYn").val()
			, selectSearch: $("#selectSearch").val()
			, searchText : fnUnderbarChgVar($("#searchText").val())
	};
	return paramObj;
};

//조회
function fnPrjctSearch(pageNum) {
	if (!pageNum)
		pageNum = 1;

	var searchParamObj = getPrjctSearchParamObj();
	searchParamObj["pageNum"]= pageNum;
	
	$.ajax({
		url : "/json/project/getProjectList"
		, method : "POST"
		, contentType : 'application/json'
		, data : JSON.stringify(searchParamObj)
		, success : function(data) {

			fnBindTableValue("tb_prjctlist_table", data.list, data.pagingInfo);

			fnSetPaging("dv_paging", data.pagingInfo, "fnPrjctSearch");

			fnSelectTrEvent("#tb_prjctlist_table tbody tr", function(rtnObj) {
				var prjctSn =$(rtnObj).find("input[name=prjctSn]").val();
				var stdSetSn =$(rtnObj).find("input[name=stdSetSn]").val();
				
				fnViewDetail(prjctSn, stdSetSn);
			});
			fnPrjctInitDtlView();
		}
	});

}

//프로젝트 상세정보, DBMS 상세정보
function fnViewDetail(prjctSn, stdSetSn) {

	$.ajax({
		url : "/json/project/getProjectInfo",
		method : "POST",
		contentType : 'application/json',
		data : JSON.stringify({
			prjctSn : prjctSn
			, stdSetSn : stdSetSn
		}),
		success : function(data) {

			var prjctInfo = data.prjctInfo;
			var userList = data.userList;
			
			$("#dtlview_prjctsn").text(prjctInfo.prjctSn);
			$("#dtlview_prjctnm").text(prjctInfo.prjctNm);
			
			var userNm = "";
			for(var i = 0; i<userList.length; i++){
				userNm+=userList[i].userNm+", "
			}
			userNm = userNm.substr(0, userNm.length-2);
			$("#dtlview_usernm").text(userNm);
			$("#dtlview_prjctcn").text(prjctInfo.prjctCn);
			$("#dtlview_stdsetnm").text(prjctInfo.stdSetNm);

			$("#dtlview_operyn").text(prjctInfo.operYn);
			$("#dtlview_dbmsnm").text(prjctInfo.dbmsNm);

			
			var dbmsNm = prjctInfo.dbmsNm;
			if(dbmsNm !="" && dbmsNm != null && dbmsNm != undefined){
				dbmsNm = dbmsNm.toUpperCase();
			}
			
			if (dbmsNm == "CSV"){
				$("#dbmsIfo").hide();
				$("#tr_database_cn").show();
				$("#dtlview_dbmsdatabasecn").text(prjctInfo.dbmsDatabaseCn);
			} else {
				$("#dbmsIfo").show();
				$("#tr_database_cn").hide();
				if (dbmsNm == "ORACLE" || dbmsNm == "TIBERO") {
					$("#tr_sid").show();
				} else {
					$("#tr_sid").hide();
				}
				
				if (dbmsNm == "POSTGRESQL" || dbmsNm == "ALTIBASE" || dbmsNm == "DB2"){
					$("#tr_schemanm").show();
				} else {
					$("#tr_schemanm").hide();
				}
				
				if (dbmsNm == "VOLTDB"){
					$("#tr_database").hide();
				} else {
					$("#tr_database").show();
				}
				
			}
			$("#dtlview_dbmsipaddr").text(prjctInfo.dbmsIpAddr);
			$("#dtlview_dbmsportno").text(prjctInfo.dbmsPortNo);
			$("#dtlview_dbmsid").text(prjctInfo.dbmsId);
			$("#dtlview_dbmspassword").text(prjctInfo.dbmsPassword);
			$("#dtlview_dbmssidnm").text(prjctInfo.dbmsSidNm);
			$("#dtlview_dbmsdatabasenm").text(prjctInfo.dbmsDatabaseNm);
			$("#dtlview_dbmsschemanm").text(prjctInfo.dbmsSchemaNm);
			
			
			//수정버튼 활성화
			$("#prjctCnctDbmsTest").show();
			$("#prjctModifyBtn").show();
			$("#prjctDeleteBtn").show();
		}
	});
}

//프로젝트 삭제
function fnPrjctDeleteBtn(pmode){
	
	var prjctSn = fnSelectTrHiddenValue("tb_prjctlist_table", "prjctSn");
	var dbmsCnncSn = fnSelectTrHiddenValue("tb_prjctlist_table", "dbmsCnncSn");

	var myPrjctSn = parent.$("#topgv_prjctSn").val();
	var isMyPrjctSn = false;
	
	if(prjctSn == myPrjctSn){
		if(!confirm("현재 접속중인 프로젝트입니다. 삭제 하시겠습니까?")){
			return;
		}
		isMyPrjctSn = true;
	} else {
		if(!confirm("삭제 하시겠습니까?")){
			return;
		} 
	}
	
	$.ajax({
		url : "/json/project/saveProjectInfo",
		method : "POST",
		contentType : 'application/json',
		data : JSON.stringify({
			prjctSn : prjctSn
			, dbmsCnncSn : dbmsCnncSn
			, pmode : pmode
		}),
		success : function(data){
			if(data.resultCd == "OK") {
				alert("삭제 되었습니다.");
				if(isMyPrjctSn){
					fnLogout();
				} else {
					location.reload();
				}
			}
		}
	});
}

function fnPrjctRegBtnModal(pmode) {
	if (pmode == "R") {
		$("#regCheckCsv").val("N");
		$("#chkPassword").show();
		fnPrjctInitDtlView();
		
	} else {
		$("#chkPassword").hide();
	}
	$("#prjctreginfo_modal").css("height", "750");
	fnShowModal("prjctreginfo_modal");
	
	var prjctSn = fnSelectTrHiddenValue("tb_prjctlist_table", "prjctSn");
	var stdSetSn = fnSelectTrHiddenValue("tb_prjctlist_table", "stdSetSn");
	
	$("#regPrjctSnHide").val(prjctSn);
	$("#regPrjctStdSetSnHide").val(stdSetSn);
	$("#regPrjctPmodeHide").val(pmode);
	
	$("#csvFileNameHideValue").val("");
	$("#csvFilePathHideValue").val("");
	$("#csvfileFullPath").val("")
	$("#csvFileName").val("");
	
	$("#csvInfo").hide();
	$("#csvDtlInfo").hide();
	$("#csvFileSaveBtn").hide();
	$("#csvFileBackBtn1").hide();
	$("#csvFileBackBtn2").hide();
	$("#csvFileNextBtn").hide();
	$("#csvFileUploadBtn").hide();
	$("#csvFileNameLabel").show();
	$("#dv_tb_list_table_div").hide();
	$("#csvFileInitBtn").hide();
	$("#dv_tb_resultlist_table_div").hide();
	
	
	fnRegPrjctSearch();
}

// 연결 테스트
function fnPrjctCnctDbmsTest(){

	var dbmsNm = $("#dtlview_dbmsnm").text();
	
	
	if(dbmsNm != "CSV"){
		
		if($("#dtlview_dbmsnm").text()==""){
			alert("DBMS정보가 없습니다. 연결 테스트 할 수 없습니다.")
			return;
		}
		
		if($("#dtlview_dbmsipaddr").text()==""){
			alert("ip주소 확인해주세요. 연결 테스트 할 수 없습니다.")
			return;
		}
		
		
		if($("#dtlview_dbmsportno").text()==""){
			alert("prot번호 확인해주세요. 연결 테스트 할 수 없습니다.")
			return;
		}
		
		
		if($("#dtlview_dbmsid").text()==""){
			alert("접속계정 정보가 없습니다. 연결 테스트 할 수 없습니다.")
			return;
		}
		
		
		if($("#dtlview_dbmspassword").text()==""){
			alert("비밀번호 정보가 없습니다. 연결 테스트 할 수 없습니다.")
			return;
		}
	
	}
	
	if(dbmsNm != "VoltDB" && dbmsNm != "CSV"){
		if($("#dtlview_dbmsdatabasenm").text()==""){
			alert("DATABASE 정보가 없습니다. 연결 테스트 할 수 없습니다.")
			return;
		} 
	}
	
	
	if(!confirm("연결 테스트 하시겠습니까?"))
		return;


	var	stdSetSn = fnSelectTrHiddenValue("tb_prjctlist_table","stdSetSn");
	var	prjctSn = fnSelectTrHiddenValue("tb_prjctlist_table","prjctSn");
		 
	$.ajax({
		url : "/json/DbmsConn/doConnectionTest",
		method : "POST",
		contentType : 'application/json',
		data : JSON.stringify({
			stdSetSn : stdSetSn
			, prjctSn : prjctSn
		}),
		success : function(data) {
			if(data.result == true){
				alert(data.message);

			}else{
				alert(data.message);
			}
		}
	});
}

// 정보 초기화
function fnPrjctInitDtlView() {
	fnClearSelectTrEvent("#tb_prjctlist_table tbody tr");
	$("#dtlview_prjctsn").empty();
	$("#dtlview_prjctnm").empty();
	$("#dtlview_usernm").empty();
	$("#dtlview_prjctcn").empty();
	$("#dtlview_stdsetnm").empty();
	$("#dtlview_operyn").empty();
	$("#dtlview_dbmsnm").empty();
	$("#dtlview_dbmsipaddr").empty();
	$("#dtlview_dbmsportno").empty();
	$("#dtlview_dbmsid").empty();
	$("#dtlview_dbmspassword").empty();
	$("#dtlview_dbmssidnm").empty();
	$("#dtlview_dbmsdatabasenm").empty();
	$("#dtlview_dbmsschemanm").empty();
	$("#dtlview_dbmsdatabasecn").empty();
	
	
	$("#prjctCnctDbmsTest").hide();
	$("#prjctModifyBtn").hide();
	$("#prjctDeleteBtn").hide();
}

</script>
</body>
</html>
					 