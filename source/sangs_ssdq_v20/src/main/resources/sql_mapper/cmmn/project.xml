<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cmmn_project">

	<!-- 공통 DBMS 목록 조회 -->
 	<select id="selectDbmsList" resultType="sangsMap" parameterType="sangsMap">
 		select 
 			dbms_sn as code
 			, dbms_nm as code_nm 
 			, dbms_nm as extval
 		from CMMN_PRJCT_DBMS 
 		where use_yn ='Y'
	</select>
	
	<!-- 프로젝트 권한 그룹 목록 조회 -->
	<select id="selectAuthorList" resultType="sangsMap" parameterType="sangsMap">
		select
			authrt_cd as code
			, authrt_nm as code_nm
		from CMMN_MNGR_AUTHOR
	</select>
	
	
	<!-- 프로젝트 목록 조회 -->
	<sql id="where_selectProjectList">
		<if test="dbmsSn != '' and dbmsSn != null ">
		 	and t2.dbms_sn = #{dbmsSn}
		</if>
		<if test="operYn != '' and operYn != null ">
		 	and t2.oper_yn = #{operYn}
		</if>
		<if test="stdSetSn != '' and stdSetSn != null ">
		 	and t3.std_set_sn = #{stdSetSn}
		</if>
		<if test="selectSearch == 'prjctNm'">
		 	and t1.prjct_nm like CONCAT('%',#{searchText},'%')
		</if>
		<if test="selectSearch == 'dbmsIpAddr'">
		 	and t2.dbms_ip_addr like CONCAT('%',#{searchText},'%')
		</if>
		<if test="selectSearch == 'dbmsPortNo'">
		 	and t2.dbms_port_no like CONCAT('%',#{searchText},'%')
		</if>
		<if test="selectSearch == 'dbmsId'">
		 	and t2.dbms_id like CONCAT('%',#{searchText},'%')
		</if>
		<if test="selectSearch == 'dbmsDatabaseNm'">
		 	and t2.dbms_database_nm like CONCAT('%',#{searchText},'%')
		</if>		
	</sql>
	<select id="selectProjectList" resultType="sangsMap" parameterType="map">
		select
			t1.prjct_sn
			, t1.dbms_cnnc_sn
			, t1.prjct_nm
			, t2.oper_yn
			, t2.dbms_ip_addr
			, t2.dbms_port_no
			, t2.dbms_id
			, t2.dbms_schema_nm
			, t2.dbms_database_nm 		
			, t2.dbms_nm
			, t3.std_set_sn
			, t3.std_set_nm
		from
			CMMN_PRJCT t1 
			left join (
				select
					t1.dbms_sn
					, t1.dbms_cnnc_sn
					, t1.dbms_ip_addr
					, t1.dbms_port_no
					, t1.dbms_id
					, t1.oper_yn
					, t1.dbms_schema_nm
					, t1.dbms_database_nm
					, t1.dbms_sid_nm
					, t1.dbms_password
					, t2.dbms_nm
				from CMMN_PRJCT_DBMS_CNNC_INFO t1
					, CMMN_PRJCT_DBMS t2
				where t1.dbms_sn = t2.dbms_sn
			) t2 on t1.dbms_cnnc_sn = t2.dbms_cnnc_sn
			left join (
				select t1.prjct_sn	
					, t2.std_set_sn
					, t2.std_set_nm
				from META_PRJCT_STD_SET t1
					, META_STD_SET t2
				where t1.std_set_sn = t2.std_set_sn
			) t3 on t1.prjct_sn = t3.prjct_sn
		where 1 = 1
		and t1.del_yn = 'N'
		<include refid="where_selectProjectList" />
		order by t1.prjct_sn desc
		limit #{pageSize} offset #{offset}
	</select> 
	
	
	
	<!-- 프로젝트 목록 count 조회 -->
	<select id="selectProjectListCnt" resultType="Integer" parameterType="map">
		select
			count(*) as cnt
		from
			CMMN_PRJCT t1 
			left join (
				select
					t1.dbms_sn
					, t1.dbms_cnnc_sn
					, t1.dbms_ip_addr
					, t1.dbms_port_no
					, t1.dbms_id
					, t1.oper_yn
					, t1.dbms_schema_nm
					, t1.dbms_database_nm
					, t1.dbms_sid_nm
					, t1.dbms_password
					, t2.dbms_nm
				from CMMN_PRJCT_DBMS_CNNC_INFO t1
					, CMMN_PRJCT_DBMS t2
				where t1.dbms_sn = t2.dbms_sn
			) t2 on t1.dbms_cnnc_sn = t2.dbms_cnnc_sn
			left join (
				select t1.prjct_sn	
					, t2.std_set_sn
					, t2.std_set_nm
				from META_PRJCT_STD_SET t1
					, META_STD_SET t2
				where t1.std_set_sn = t2.std_set_sn
			) t3 on t1.prjct_sn = t3.prjct_sn
		where 1 = 1
		and t1.del_yn = 'N'
		<include refid="where_selectProjectList" />
	</select>
	
	
	
	<!-- 프로젝트 목록 상세조회 -->
	<select id="selectProjectInfo" resultType="sangsMap" parameterType="map">
		select
			t1.prjct_sn
			, t1.dbms_cnnc_sn
			, t1.prjct_nm
			, t1.prjct_cn
			, t2.oper_yn
			, t2.dbms_ip_addr 
			, t2.dbms_port_no
			, t2.dbms_id
			, t2.dbms_schema_nm
			, t2.dbms_database_nm 		
			, t2.dbms_nm
			, t2.dbms_sn
			, t2.dbms_password
			, t2.dbms_database_cn
			, t2.dbms_sid_nm
			, t3.std_set_nm
			, t3.std_set_sn
		from
			CMMN_PRJCT t1 
			left join (
				select
					t1.dbms_sn
					, t1.dbms_cnnc_sn
					, t1.dbms_ip_addr
					, t1.dbms_port_no
					, t1.dbms_id
					, t1.oper_yn
					, t1.dbms_schema_nm
					, t1.dbms_database_nm
					, t1.dbms_sid_nm
					, t1.dbms_password
					, t1.dbms_database_cn
					, t2.dbms_nm
				from 
					CMMN_PRJCT_DBMS_CNNC_INFO t1
					join CMMN_PRJCT_DBMS t2 on t1.dbms_sn = t2.dbms_sn
			) t2 on t1.dbms_cnnc_sn = t2.dbms_cnnc_sn
			left join (
				select t1.prjct_sn	
					, t2.std_set_sn
					, t2.std_set_nm
				from META_PRJCT_STD_SET t1
					, META_STD_SET t2
				where t2.std_set_ty_cd ='NONE'
				and t2.del_yn = 'N'
				and t1.std_set_sn = #{stdSetSn}
				and t1.std_set_sn = t2.std_set_sn
			) t3 on t1.prjct_sn = t3.prjct_sn
		where 1 = 1
		and t1.del_yn = 'N'
		and t1.prjct_sn = #{prjctSn}
	</select>
	
	
	<!-- 프로젝트 사용자 조회 -->
	<sql id="where_selectProjectUserListSearch">
		<if test="userNm != '' and userNm != null ">
			and t1.user_nm like CONCAT('%',#{userNm},'%')
	 	</if>
		<if test="authrtCd != '' and authrtCd != null ">
		 	and t2.authrt_cd = #{authrtCd}
		</if>
	</sql>
	<select id="selectProjectUserListSearch" resultType="sangsMap" parameterType="map">
		select t1.user_id
			, t1.user_nm
			, t2.authrt_cd
			, t2.authrt_nm
		from CMMN_MNGR t1
			join (
				select t1.authrt_cd
					, t1.authrt_nm 
					, t2.user_id
				from CMMN_MNGR_AUTHOR t1
					, CMMN_MNGR_AUTHOR_DTL t2
				where t1.authrt_cd = t2.authrt_cd
			) t2 on t1.user_id = t2.user_id
		where 1 = 1
		<include refid="where_selectProjectUserListSearch" />
	</select>
	
	<!-- 프로젝트관리 사용자 조회 -->
	<select id="selectProjectUserList" resultType="sangsMap" parameterType="map">
		select t1.user_id
			, t2.user_nm 
		from CMMN_PRJCT_USER t1
			join(
				select t1.user_id
					, t1.user_nm
					, t2.authrt_cd
				from CMMN_MNGR t1
					, CMMN_MNGR_AUTHOR_DTL t2
				where t1.user_id = t2.user_id
			) t2 on t1.user_id = t2.user_id
		where 1 = 1 
		and t1.prjct_sn = #{prjctSn}
	</select>

 
	<!-- 프로젝트 순번 채번 -->
	<select id="selectNextProjectSn" resultType="Integer" parameterType="map">
		select 
			ifnull(max(prjct_sn), 0) + 1
		from CMMN_PRJCT
	</select>
	<!-- 프로젝트 정보 등록 -->
	<insert id="insertProjectInfo" parameterType="map">
		insert into CMMN_PRJCT(
			prjct_sn
			, dbms_cnnc_sn
			, prjct_nm
			, prjct_cn
			, use_yn
			, del_yn
			, reg_user_id
			, reg_dt
		)values(
			#{prjctSn} 
			, #{dbmsCnncSn}
			, #{prjctNm}
			, #{prjctCn}
			, #{useYn}
			, #{delYn}
			, #{regUserId}
			, now()
		)
	</insert>
	
	<!-- 프로젝트 표준 세트 -->
	<insert id="insertMetaPrjctStdSetInfo" parameterType="map">
		insert into META_PRJCT_STD_SET(prjct_sn, std_set_sn)
		values(#{prjctSn}, #{stdSetSn})
	</insert>
	
	<!-- 프로젝트 표준 세트 수정-->
	<update id="updateMetaPrjctStdSetInfo" parameterType="map">
		update META_PRJCT_STD_SET set
			std_set_sn = #{stdSetSn}
		where prjct_sn = #{prjctSn}
	</update>
	
	<!-- 프로젝트 DBMS 연결 순번 채번 -->
	<select id="selectNextProjectDbmsCnncSn" resultType="Integer" parameterType="map">
		select 
			ifnull(max(dbms_cnnc_sn), 0) + 1
		from CMMN_PRJCT_DBMS_CNNC_INFO
	</select>
	<!-- 프로젝트 DBMS 연결 정보 등록 -->
	<insert id="insertProjectDbmsCnncInfo" parameterType="map">
		insert into CMMN_PRJCT_DBMS_CNNC_INFO(
			dbms_cnnc_sn
			, dbms_sn
			, dbms_ip_addr
			, dbms_port_no
			, dbms_schema_nm
			, dbms_sid_nm
			, dbms_database_nm
			, dbms_paramtr_value
			, dbms_id
			, dbms_password
			, oper_yn
			, reg_user_id
			, reg_dt
			, dbms_database_cn
		)values(
			#{dbmsCnncSn}
			, #{dbmsSn}
			, #{dbmsIpAddr}
			, #{dbmsPortNo}
			, #{dbmsSchemaNm}
			, #{dbmsSidNm}
			, #{dbmsDatabaseNm}
			, #{dbmsParamtrValue}
			, #{dbmsId}
			, #{dbmsPassword}
			, #{operYn}
			, #{regUserId}
			, now()
			, #{dbmsDatabaseCn}
		)
	</insert>
	

	<!-- 프로젝트 정보 수정 -->
	<update id="updateProjectInfo" parameterType="map">
		update CMMN_PRJCT set
			chg_dt = now()
		<if test='"M".equals(pmode)'>
			, prjct_nm = #{prjctNm}
			, prjct_cn = #{prjctCn}
		</if>
		<if test='"D".equals(pmode)'>
			, use_yn = 'N'
			, del_yn = 'Y'
			, chg_user_id = #{chgUserId}
		</if>
		where prjct_sn = #{prjctSn}
	</update>


	<!-- 프로젝트 DBMS 연결 정보 수정 -->
	<update id="updateProjectDbmsCnncInfo" parameterType="map">
		update CMMN_PRJCT_DBMS_CNNC_INFO set
			dbms_sn = #{dbmsSn}
			, dbms_ip_addr = #{dbmsIpAddr}
			, dbms_port_no = case when #{dbmsPortNo} ='' then null else #{dbmsPortNo} end
			, dbms_schema_nm = #{dbmsSchemaNm}
			, dbms_sid_nm = #{dbmsSidNm}
			, dbms_database_nm = #{dbmsDatabaseNm}
			, dbms_id = #{dbmsId}
		<if test='chgYnPwd != null and chgYnPwd != "" and chgYnPwd == "Y" '>
			, dbms_password = #{dbmsPassword}
		</if>
			, oper_yn = #{operYn}
			, chg_user_id = #{chgUserId}
			, chg_dt = now()
		where dbms_cnnc_sn = #{dbmsCnncSn}
	</update>
	<update id="updateProjectDbmsSn" parameterType="map">
		update CMMN_PRJCT_DBMS_CNNC_INFO set
			dbms_sn = #{dbmsSn}
			, chg_user_id = #{chgUserId}
			, chg_dt = now()
		where dbms_cnnc_sn =#{dbmsCnncSn}
	</update>
	
	<!-- 프로젝트 DBMS 연결 정보 조회 -->
	<select id="selectProjectDbmsCnncInfo" resultType="sangsMap" parameterType="map">
		select 
			t1.dbms_sn
			, t1.dbms_cnnc_sn
			, t1.dbms_ip_addr
			, t1.dbms_port_no
			, t1.dbms_id
			, t1.oper_yn
			, t1.dbms_schema_nm
			, t1.dbms_database_nm
			, t1.dbms_sid_nm
			, t1.dbms_password
			, t3.dbms_nm
			, t2.prjct_nm 
		from CMMN_PRJCT_DBMS_CNNC_INFO t1
			, CMMN_PRJCT t2
			, CMMN_PRJCT_DBMS t3
		where t1.dbms_cnnc_sn = t2.dbms_cnnc_sn
			and t1.dbms_sn = t3.dbms_sn
			and t2.prjct_sn = #{prjctSn}
	</select>
	

	<!-- 프로젝트 사용자 정보 등록 -->
	<insert id="insertProjectUserInfo" parameterType="map">
		insert into CMMN_PRJCT_USER(prjct_sn, user_id)
		values(#{prjctSn}, #{userId})
	</insert>
	
	<!-- 프로젝트 사용자 정보 삭제 -->
	<delete id="deleteProjectUserInfo" parameterType="map">
		delete from CMMN_PRJCT_USER
		where prjct_sn = #{prjctSn}
	</delete>

</mapper>  