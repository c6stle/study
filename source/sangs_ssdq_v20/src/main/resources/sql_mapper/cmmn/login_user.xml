<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cmmn_login_user">

	<!-- 사용자 로그인 정보 조회 -->
	<select id="selectLoginUserInfo" resultType="sangsMap" parameterType="sangsMap">
		select 
			t1.USER_ID
			, t1.USER_PASSWORD
			, t2.USER_NM
			, t1.LGN_FAILR_CNT
			, case when CURRENT_TIMESTAMP > t1.PASSWORD_EXPRY_DT then 'Y' else 'N' end as EXPIRE_PWD_DT
			, t3.AUTHRT_CD
			, case when t3.AUTHRT_CD = 'ADMIN' or t3.AUTHRT_CD = 'APPROVER' then 'Y' else 'N' end as IS_APPROVER
		from CMMN_MNGR_LOGIN t1
			, CMMN_MNGR t2
			, CMMN_MNGR_AUTHOR_DTL t3
		where t1.USER_ID = t2.USER_ID	
			and t2.USE_YN = 'Y'
			and t1.USER_ID = t3.USER_ID
			and t1.USER_ID = #{userId}
			<!-- and t1.USER_PASSWORD = #{userPassword} -->
	</select>

	<!-- 로그인 사용자의 프로젝트 정보 조회 -->
	<select id="selectLoginUserProjectInfoList" resultType="sangsMap" parameterType="map">
		select 
			t1.PRJCT_SN
			, t1.PRJCT_NM
			, t1.PRJCT_CN
			, t3.STD_SET_SN
			, t3.STD_SET_NM
			, t3.STD_SET_CN
			, t4.DBMS_IP_ADDR
			, t4.DBMS_PORT_NO
			, t4.DBMS_DATABASE_NM
			, t4.DBMS_SCHEMA_NM
			, t4.DBMS_SID_NM
			, t4.DBMS_SN
			, t4.DBMS_CNNC_SN
			, t4.DBMS_PASSWORD
			, t4.DBMS_ID
			, t4.DBMS_DATABASE_CN
			, (select DBMS_NM FROM CMMN_PRJCT_DBMS t0 where t0.DBMS_SN = t4.DBMS_SN) as DBMS_NM
		from CMMN_PRJCT t1
			join CMMN_PRJCT_USER t2 on t1.PRJCT_SN = t2.PRJCT_SN
			<if test="prjctSn != '' and prjctSn != null ">
				and t2.PRJCT_SN = #{prjctSn}
			</if>
				and t2.USER_ID = #{userId}
				and t1.USE_YN = 'Y'
				and t1.DEL_YN = 'N'
			left outer join (
				select
					t01.STD_SET_SN
					, t01.STD_SET_NM
					, t01.STD_SET_CN
					, t02.PRJCT_SN
				from META_STD_SET t01, META_PRJCT_STD_SET t02 
				where t01.STD_SET_SN = t02.STD_SET_SN 
					and t01.USE_YN = 'Y' 
					and t01.DEL_YN = 'N' 
					and t01.APRV_STTUS_CD = 'APPROVAL'
			) t3 on t2.PRJCT_SN = t3.PRJCT_SN
			left outer join CMMN_PRJCT_DBMS_CNNC_INFO t4 on t1.DBMS_CNNC_SN = t4.DBMS_CNNC_SN
	</select>
	
	<update id="updateLoginFailedCnt" parameterType="map">
		UPDATE CMMN_MNGR_LOGIN SET 
			LGN_FAILR_CNT = LGN_FAILR_CNT + 1
		WHERE 1=1
			AND USER_ID = #{userId}
	</update>
	
	<update id="updatePasswordInfo" parameterType="map">
		UPDATE CMMN_MNGR_LOGIN SET 
			USER_PASSWORD = #{encryptPass}
		WHERE 1=1
			AND USER_ID = #{userId}
	</update>
	
</mapper>  