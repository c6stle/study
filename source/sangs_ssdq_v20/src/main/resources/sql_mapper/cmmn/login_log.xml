<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cmmn_login_log">

	<!-- dbms별 공통 insert query -->
	<sql id="common_insert_register_query">
		<choose>
			<when test = "APP_DBMS_TYPE == 'MARIADB' or APP_DBMS_TYPE == 'MYSQL' or APP_DBMS_TYPE == 'CUBRID'">
				, #{regUserId}
				, NOW()
			</when>
			<otherwise>
				, #{regUserId}
				, SYSDATE
			</otherwise>
		</choose>	
	</sql>
	
	<!-- dbms별 공통 insert query -->
	<sql id="common_insert_registerDt_query">
		<choose>
			<when test = "APP_DBMS_TYPE == 'MARIADB' or APP_DBMS_TYPE == 'MYSQL' or APP_DBMS_TYPE == 'CUBRID'">
				, NOW()
			</when>
			<otherwise>
				, SYSDATE
			</otherwise>
		</choose>	
	</sql>
	
	<!-- 로그인 로그 등록 -->
	<insert id="insertLoginLog" parameterType="map">
		INSERT INTO EGOV_COMTNLOGINLOG(
			LOG_ID
			, SYS_SE_CD
			, CNTN_ID
			, CNTN_IP
			, CNTN_MTHD
			, ERR_OCRN_YN
			, ERR_CD
			, REG_DT
		) VALUES (
			CONCAT('LOGIN', LPAD(NEXTVAL(SEQ_EGOV_COMTNLOGINLOG),'15','0'))
			, #{sysSeCd}
			, #{cntnId}
			, #{cntnIp}
			, #{cntnMthd}
			, #{errOcrnYn}
			, #{errCd}
			<include refid="common_insert_registerDt_query"/>
		);
	</insert>
	
	<sql id="where_LoginLog_selectLoginLogList">
		<if test="loginMthd != '' and loginMthd != null ">
			AND a.CNTN_MTHD = #{loginMthd}
		</if>
		<if test="searchSysSeCd != '' and searchSysSeCd != null ">
			AND a.SYS_SE_CD = #{searchSysSeCd}
		</if>
		<if test="loginId != '' and loginId != null ">
			AND a.CNTN_ID LIKE CONCAT('%',#{loginId},'%')
		</if>
		<if test="searchBgnDe != null and searchBgnDe != ''">
			<choose>		 
				<when test = "APP_DBMS_TYPE == 'MARIADB' or APP_DBMS_TYPE == 'MYSQL'">
					AND DATE(a.REG_DT) BETWEEN STR_TO_DATE(#{searchBgnDe}, '%Y-%m-%d') AND STR_TO_DATE(#{searchEndDe}, '%Y-%m-%d')
				</when>
				<otherwise>
					AND a.REG_DT BETWEEN TO_DATE(#{searchBgnDe}, 'YYYY-MM-DD') AND (TO_DATE(#{searchEndDe}, 'YYYY-MM-DD') + 0.99999)
				</otherwise>
			</choose>
		</if>
	</sql>
	
	<!-- 로그인로그 리스트 조회 -->
	<select id="selectLoginLogList" parameterType="map" resultType="sangsMap">
		SELECT
			a.LOG_ID
			, a.SYS_SE_CD
			, a.CNTN_ID
			, a.CNTN_IP
			, a.CNTN_MTHD
			, DATE_FORMAT(ERR_OCRN_YN, '%Y-%m-%d %T') AS ERR_OCRN_YN
			, a.ERR_CD
			, DATE_FORMAT(REG_DT, '%Y-%m-%d %T') AS REG_DT
		FROM 
			EGOV_COMTNLOGINLOG a
		WHERE 1 = 1
			<include refid="where_LoginLog_selectLoginLogList" />
		ORDER BY a.REG_DT DESC
		LIMIT #{pageSize} OFFSET #{offset}
	</select> 
	
	<!-- 로그인 로그 카운트 조회 -->
	<select id="selectLoginLogListCnt" parameterType="map" resultType="Integer">
		SELECT 
			COUNT(a.LOG_ID) AS CNT
		FROM 
			EGOV_COMTNLOGINLOG a
		WHERE 1 = 1
			<include refid="where_LoginLog_selectLoginLogList" />
	</select>
</mapper>