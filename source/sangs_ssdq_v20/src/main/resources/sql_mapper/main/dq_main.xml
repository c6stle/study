<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dq_main">

	<select id="selectMainPrjctItemCount" resultType="sangsMap" parameterType="sangsMap">
		select 
			(
				select count(*) as CNT
				from CMMN_PRJCT t1
					, CMMN_PRJCT_DBMS_CNNC_INFO t2
				where t1.DBMS_CNNC_SN = t2.DBMS_CNNC_SN
					and t1.USE_YN = 'Y'
					and t1.DEL_YN = 'N'
					and t2.DBMS_IP_ADDR is not null
					and t2.DBMS_DATABASE_NM is not null
					and t2.DBMS_ID is not null
					and t2.DBMS_PASSWORD is not null
			) as PRJ_CNT
			, 
			( 
				select count(*) as CNT
				from DQ_ANLS_RULE_INFO
				where DBMS_SN in (0, #{dbmsSn})
					and USE_YN = 'Y'
			) as RULE_CNT
			, (
				select count(distinct t2.RULE_SN)
				from DQ_DGNSS_PROFL t1
					, DQ_DGNSS_TRGT_COL_RULE t2
				where t1.PROFL_SN = t2.PROFL_SN
					and t1.PRJCT_SN = #{prjctSn}
					and t1.USE_YN = 'Y'
					and t1.DEL_YN = 'N'
			) as DGNSS_RULE_CNT
			, (
				select count(*) as CNT
				from DQ_DGNSS_PROFL
				where PRJCT_SN = #{prjctSn} 
					and USE_YN = 'Y'
					and DEL_YN = 'N'
			) as PROFL_CNT
			, (
				select count(distinct t2.TBL_NM)
				from DQ_DGNSS_PROFL t1
					, DQ_DGNSS_TRGT_TBL t2
				where t1.PROFL_SN = t2.PROFL_SN
					and t1.PRJCT_SN = #{prjctSn}
					and t1.USE_YN = 'Y'
					and t1.DEL_YN = 'N'
					and t2.DEL_YN = 'N'
			) as PROFL_TBL_CNT
	</select>
	 
	 
	 
	 <select id="selectDgnssCountByDay" resultType="sangsMap" parameterType="sangsMap">
	 	select 
			date_format(t1.REG_DT, '%Y-%m-%d') as REG_DT
			, count(*) as CNT
		from DQ_DGNSS_PROFL t0
			, DQ_DGNSS_EXC t1
		where t0.PROFL_SN = t1.PROFL_SN
			and t0.PRJCT_SN = #{prjctSn}
			and t1.REG_DT between date_add(now(), interval - 1 month) and now()
		group by date_format(t1.reg_dt, '%Y%m%d')
		order by date_format(t1.reg_dt, '%Y%m%d')
	 </select>
	 
	 
	 <select id="selectDisMatchAvgPercByDay" resultType="sangsMap" parameterType="sangsMap">
		 select 
			date_format(t1.REG_DT, '%Y-%m-%d') as REG_DT
			, avg(case when ifnull(t2.MTCH_CNT, 0) + ifnull(t2.DIS_MTCH_CNT, 0) = 0 then 0
				else truncate( ifnull(t2.DIS_MTCH_CNT, 0) * 100.0 / ( ifnull(t2.MTCH_CNT, 0) + ifnull(t2.DIS_MTCH_CNT, 0)), 2) end
			) as DIS_MTCH_PERC
		from DQ_DGNSS_PROFL t0
			, DQ_DGNSS_EXC t1
			, DQ_DGNSS_RESULT_COL_RULE t2
		where t0.PROFL_SN = t1.PROFL_SN
			and t1.EXC_SN = t2.EXC_SN
			and t0.PRJCT_SN = #{prjctSn}
			and t1.REG_DT between date_add(now(), interval - 1 month) and now()
			and t2.RULE_SN not in (
				select RULE_SN from DQ_ANLS_RULE_INFO
				where RULE_SE_CD in ('AG000100', 'AG000200')
			)
		group by date_format(t1.reg_dt, '%Y%m%d')
		order by date_format(t1.reg_dt, '%Y%m%d')
	</select>
	 

	<select id="selectDgnssResultListGrpByRule" resultType="sangsMap" parameterType="sangsMap">
		select 
			RULE_SN
			, RULE_NM
			, EXC_CNT
			, TOT_DATA_CNT
			, TOT_MTCH_CNT
			, TOT_DIS_MTCH_CNT
			, case when ifnull(TOT_DATA_CNT, 0) = 0 then 0
				else truncate( ifnull(TOT_MTCH_CNT, 0) * 100.0 / ( ifnull(TOT_DATA_CNT, 0)), 2) end
			as MTCH_PERC
		from (
			select 
				t3.RULE_SN
				, t3.RULE_NM
				, count(*) as EXC_CNT
				, sum((t2.MTCH_CNT + t2.DIS_MTCH_CNT)) as TOT_DATA_CNT
				, sum((t2.MTCH_CNT)) as TOT_MTCH_CNT
				, sum((t2.DIS_MTCH_CNT)) as TOT_DIS_MTCH_CNT
			from 
				DQ_DGNSS_PROFL t0
				, DQ_DGNSS_EXC t1
				, DQ_DGNSS_RESULT_COL_RULE t2
				, DQ_ANLS_RULE_INFO t3
			where t0.PROFL_SN = t1.PROFL_SN
				and t1.EXC_SN = t2.EXC_SN
				and t2.RULE_SN = t3.RULE_SN
				and t0.PRJCT_SN = #{prjctSn}
				and t1.REG_DT between date_add(now(), interval - 1 month) and now()
				and t2.RULE_SN not in (select RULE_SN from DQ_ANLS_RULE_INFO where RULE_SE_CD in ('AG000100', 'AG000200'))  
			group by t3.RULE_SN, t3.RULE_NM
		) t00
		order by TOT_DIS_MTCH_CNT desc
		limit 10
	</select>
	 
	<select id="selectTopDisMatchProflColList" resultType="sangsMap" parameterType="sangsMap">
		select 
			PROFL_NM
			, PROFL_SN
			, EXC_SN
			, date_format(EXC_BGNG_DT, '%Y-%m-%d %H:%i') as EXC_BGNG_DT
			, TBL_NM
			, COL_NM
			, TOT_DATA_CNT
			, TOT_DIS_MTCH_CNT
			, DIS_MTCH_PERC
		from (
			select 
				t10.* 
				, case when ifnull(TOT_DATA_CNT, 0) = 0 then 0
					else truncate( ifnull(TOT_DIS_MTCH_CNT, 0) * 100.0 / ( ifnull(TOT_DATA_CNT, 0)), 2) end DIS_MTCH_PERC
			from (
				select 
					t0.PROFL_NM
					, t1.EXC_BGNG_DT
					, t0.PROFL_SN
					, t1.EXC_SN
					, t2.TBL_NM
					, t3.COL_NM
					, sum(t4.MTCH_CNT + t4.DIS_MTCH_CNT) as TOT_DATA_CNT
					, sum(t4.DIS_MTCH_CNT) as TOT_DIS_MTCH_CNT
				from 
					DQ_DGNSS_PROFL t0
					, DQ_DGNSS_EXC t1
					, DQ_DGNSS_RESULT_TBL t2
					, DQ_DGNSS_RESULT_COL t3
					, DQ_DGNSS_RESULT_COL_RULE t4
				where t0.PROFL_SN = t1.PROFL_SN
					and t1.EXC_SN = t2.EXC_SN
					and t2.EXC_SN = t3.EXC_SN
					and t2.TBL_SN = t3.TBL_SN
					and t3.EXC_SN = t4.EXC_SN
					and t3.TBL_SN = t4.TBL_SN
					and t4.COL_SN = t4.COL_SN
					and t0.PRJCT_SN = #{prjctSn}
					and t1.REG_DT between date_add(now(), interval - 1 month) and now()
					and t4.RULE_SN not in (select RULE_SN from DQ_ANLS_RULE_INFO where RULE_SE_CD in ('AG000100', 'AG000200'))
				group by t0.PROFL_SN, t1.EXC_SN, t4.TBL_SN
			) t10
		) t100 
		order by DIS_MTCH_PERC desc, TOT_DIS_MTCH_CNT desc 
		limit 10
	
	</select>
	<select id="selectTopDisMatchProflRuleList" resultType="sangsMap" parameterType="sangsMap">
		select 
			PROFL_NM
			, PROFL_SN
			, RULE_SN
			, RULE_NM
			, EXC_CNT
			, TOT_DATA_CNT
			, TOT_MTCH_CNT
			, TOT_DIS_MTCH_CNT
			, DIS_MTCH_PERC
		from (
			 select 
				t00.*
				, case when ifnull(TOT_DATA_CNT, 0) = 0 then 0
					else truncate( ifnull(TOT_DIS_MTCH_CNT, 0) * 100.0 / ( ifnull(TOT_DATA_CNT, 0)), 2) end
				as DIS_MTCH_PERC
			from (
				select 
					t0.PROFL_NM
					, t0.PROFL_SN
					, t3.RULE_SN
					, t3.RULE_NM
					, count(*) as EXC_CNT
					, sum((t2.MTCH_CNT + t2.DIS_MTCH_CNT)) as TOT_DATA_CNT
					, sum((t2.MTCH_CNT)) as TOT_MTCH_CNT
					, sum((t2.DIS_MTCH_CNT)) as TOT_DIS_MTCH_CNT
				from 
					DQ_DGNSS_PROFL t0
					, DQ_DGNSS_EXC t1
					, DQ_DGNSS_RESULT_COL_RULE t2
					, DQ_ANLS_RULE_INFO t3
				where t0.PROFL_SN = t1.PROFL_SN
					and t1.EXC_SN = t2.EXC_SN
					and t2.RULE_SN = t3.RULE_SN
					and t0.PRJCT_SN = #{prjctSn}
					and t1.REG_DT between date_add(now(), interval - 1 month) and now()
					and t2.RULE_SN not in (select RULE_SN from DQ_ANLS_RULE_INFO where RULE_SE_CD in ('AG000100', 'AG000200'))  
				group by t0.PROFL_SN, t3.RULE_SN, t3.RULE_NM
			) t00
		) t000
		order by DIS_MTCH_PERC desc
		limit 10
	</select>
	 
	 
</mapper>  