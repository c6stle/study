<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/mainLayout">

<head>
	<th:block th:replace="fragments/head_inc :: head_inc" />
</head>

<body id="body">
	<div id="wrap">
		<div class="container">
			<div id="content">
				<div class="page_info_area">
					<div class="left">
                        <div class="location_area">
                            <a href="#" class="bookmark active" title="즐겨찾기"></a>
                            <ul>
                                <li>홈</li>
                                <li>학습관리</li>
								<li>학습정보관리</li>
                            </ul>
                        </div>
                        <div class="title_area">
                            <p>학습정보관리</p>
                            <a href="#" class="reload_btn" title="새로고침">새로고침</a>
                            <a href="#" class="help_btn" title="도움말">도움말</a>
                        </div>
                    </div>
                </div>
                
                <div class="content_area">
	                <div class="division">
	                	<div class="row">
	                		<div class="left" data-width="500">
		                		<div class="view_wrap">
		                			<div class="tbl_top" style="flex: 0 0 0;">
										<p class="tit v2">
											<span>학습그룹 목록</span>
										</p>
										<div class="button_wrap">
											<button class="btn sm" onclick="fnLrnGrpAdd(); return false;">신규</button>
											<button class="btn sm" onclick="fnLrnGrpSave(); return false;">저장</button>
										</div>
									</div>
									
									<div class="table_area marginb25">
										<input type="hidden" id="nextLrnGroupSn" name="nextLrnGroupSn" />
										<table class="list fixed" id="grp_data_table">
											<colgroup>
												<col width="60px;">
												<col width="auto;">
												<col width="80px;">
											</colgroup>
											<thead>
												<tr>
													<th>순번</th>
													<th>학습 그룹명</th>
													<th></th>
												</tr>
											</thead>
											<tbody>
												<tr class="fwk_templete_row">
													<td>
														#{FWK_TR_NO}
														<input type="hidden" name="grp_lrnGroupSn" value="#{code}"/>
														<input type="hidden" name="lrnGroupIuId" value="update" />
													</td>
													<td><input type="text" class="in_w100" name='lrnGroupNm' value="#{codeNm}" /></td>
													<td><button class="btn sm" onclick="fnLrnGrpDelete(#{code});">삭제</button></td>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
	                		</div>
	                		
	                		<div class="right" data-width="auto;">
	                			<div class="view_wrap">
		                			<div class="tbl_top" style="flex: 0 0 0;">
										<p class="tit v2">
											<span>학습 목록</span>
										</p>
										<div class="button_wrap">
											<button class="btn sm" onclick="fnLrnMngAdd(); return false;">신규</button>
											<button class="btn sm" onclick="fnLrnMngSave(); return false;">저장</button>
										</div>
									</div>
				                	<div class="table_area marginb25">
				                		<input type="hidden" id="nextLrnSn" name="nextLrnSn" />
										<table class="list fixed marginb20" id="lrn_data_table">
											<colgroup>
												<col width="60px;">
												<col width="auto;">
												<col width="auto;">
												<col width="auto;">
												<col width="80px;">
											</colgroup>
											<thead>
												<tr>
													<th>순번</th>
													<th>학습 그룹명</th>
													<th>학습 명</th>
													<th>학습 설명</th>
													<th></th>
												</tr>
											</thead>
											<tbody>
												<tr class="fwk_templete_row">
													<td>
														#{FWK_TR_NO}
														<input type="hidden" name="lrnSn" value="#{lrnSn}" />
														<input type="hidden" name="lrnMngIuId" value="update" />
													</td>
													<td>
														<div class="selectbox">
															#fn{fnBindCodeListObj('LEARNING_GROUP_CODE', 'select', #{lrnGroupSn}, 'lrnGroupSn')}
														</div>
														<input type="hidden" name="lrnGroupSn" value="#{lrnGroupSn}">
													</td>
													<td><input type="text" class="in_w100" name="lrnNm" value="#{lrnNm}" /></td>
													<td><input type="text" class="in_w100" name="lrnDc" value="#{lrnDc}" /></td>
													<td><button class="btn sm" onclick="fnLrnMngDelete('#{lrnSn}'); return false;">삭제</button></td>
												</tr>
											</tbody>
										</table>
	                				</div>
	                			</div>
							</div>
	                	</div>
	                </div>
				</div>
				
				
				
			</div>
		</div>
	</div>






<script type="text/javascript">

$(document).ready(function() {
	fnInit();
	fnSearchLrnGrp();
});


function fnSearchLrnGrp() {
	$.ajax({
		url: "/json/learning/getLearningGroupList"
		, contentType: "application/json"
		, success: function(data){
			fnBindTableValue("grp_data_table", data.lrnGroupList);
			$("#nextLrnGroupSn").val(data.nextLrnGroupSn);
		}
	});
}

function fnSearchLrnMng() {
	$.ajax({
		url: "/json/learning/getLearningList"
		, contentType: "application/json"
		, success: function(data){
			fnBindTableValue("lrn_data_table", data.lrnMngList);
			$("#nextLrnSn").val(data.nextLrnSn);
			fnApplySelectLabel();
		}
	});
}


function fnInit() {
	
	new CodeBinder()
	.setSqlCode("LEARNING_GROUP_CODE", "lrnGroupSn", "select")
	.addFirstOption("LEARNING_GROUP_CODE", "", "선택")
	.setLoadCallbackFunc("fnSearchLrnMng()")
	.load();
	
}





//학습 그룹 관리
function fnLrnGrpAdd() {
	
	var tblRowCnt = $("#nextLrnGroupSn").val()
	
	var table = "<tr>";
	table += "	<td>";
	table += "		<input type='hidden' class='in_w100' name='grp_lrnGroupSn' value='" + tblRowCnt + "' />";
	table += "		<input type='hidden' class='in_w100' name='lrnGroupIuId' value='insert' />";
	table += "	</td>";
	table += "	<td>";
	table += "		<input type='text' class='in_w100' name='lrnGroupNm' value='' />";
	table += "	</td>";
	table += "	<td>";
	table += "		<button class='btn sm' onclick='fnLrnGrpDelete(" + tblRowCnt + ");'>삭제</button>"
	table += "	</td>";
	table += "</tr>";
	
	$("#grp_data_table tbody tr").first().before(table);
	$("#nextLrnGroupSn").val(Number($("#nextLrnGroupSn").val()) + 1);
}



function fnLrnGrpSave() {
	
	var returnNow = true;
	
	$("#grp_data_table tbody tr").each(function (){
		var tr = $(this).closest("tr");
		if ($.isNumeric(tr.find("input[name=grp_lrnGroupSn]"))) {
			if (!tr.find("input[name=lrnGroupNm]").val() || tr.find("input[name=lrnGroupNm]").val() == "") {
				alert("학습 그룹명은 필수 입력 항목입니다.");
				tr.find("input[name=lrnGroupNm]").focus();
				returnNow = false;
				return false;
			}
		}
	});
	
	if (returnNow) {
		var flag = confirm("저장하시겠습니까?");
		if (flag == true) {
		
			var lrnGroupList = new Array();
			
			$("#grp_data_table tbody tr").each(function (){
				
				var tr = $(this);
				//if (tr.find("input[name=lrnGroupNm]").val() == "#{lrnGroupNm}") return;
				var lrnGroupObject = new Object();
				lrnGroupObject.lrnGroupSn = tr.find("input[name=grp_lrnGroupSn]").val();
				lrnGroupObject.lrnGroupNm = tr.find("input[name=lrnGroupNm]").val();
				lrnGroupObject.iuId = tr.find("input[name=lrnGroupIuId]").val();
				
				if ($.isNumeric(lrnGroupObject.lrnGroupSn)) {
					lrnGroupList[lrnGroupList.length] = lrnGroupObject;					
				}
			});
			
			$.ajax({
				url: "/json/learning/saveLearningGroupInfo"
				, method : "POST"
				, contentType: 'application/json'
				, data: JSON.stringify({		
					lrnGroupList: lrnGroupList
				})
				, success: function(data){
					if (data.resultCd == "OK") {
						alert("저장되었습니다.");
						location.reload();
					}
				}
				, error: function(data) {
					console.log(data);
				}
			});
		}
	}
}



function fnLrnGrpDelete(lrnGroupSn) {
	
	var flag = confirm("삭제하시겠습니까?");
	if (flag == true) {
		
		$("input[name='grp_lrnGroupSn']:input[value=" + lrnGroupSn + "]").closest('tr').remove();
		$("select[name=lrnGroupSn]").each(function() {
			if ($(this).val() == lrnGroupSn) {
				//$(this).children("option:selected").val("");
				$(this).val("");
				fnApplySelectLabel();
			};
			$(this).children("option[value=" + lrnGroupSn + "]").remove();
		});
			
		
		$.ajax({
			url: "/json/learning/rmvLearningGroupInfo"
			, method : "POST"
			, contentType: 'application/json'
			, data: JSON.stringify({lrnGroupSn: lrnGroupSn})
			, success: function(data){
				if (data.resultCd == "OK") {
					alert("삭제되었습니다.");
				}
				
			}
			, error: function(data) {
				console.log(data);
			}
		});
	}
}



//학습 관리
function fnLrnMngAdd() {
	
	var lrnMngCnt = $("#nextLrnSn").val();

	var table = "<tr>";
	table += "	<td>";
	table += "		<input type='hidden' name='lrnSn' value='" + lrnMngCnt + "'/>";
	table += "		<input type='hidden' name='lrnMngIuId' value='insert' />";
	table += "	</td>";
	table += "	<td><div class='selectbox'>";
	table += fnBindCodeListObj('LEARNING_GROUP_CODE', 'select', '', 'lrnGroupSn');
	table += "	</div></td>";
	table += "	<td><input type='text' class='in_w100' name='lrnNm' value='' /></td>";
	table += "	<td><input type='text' class='in_w100' name='lrnDc' /></td>";
	table += "	<td>";
	table += "		<button class='btn sm' onclick='fnLrnMngDelete(" + lrnMngCnt + ");'>삭제</button>";
	table += "	</td>";
	table += "</tr>";
	
	$("#lrn_data_table tbody tr").first().before(table);
	$("#nextLrnSn").val(Number($("#nextLrnSn").val()) + 1);
	
	$("#lrn_data_table tbody tr").each(function () {
		if($(this).find("input[name=lrnMngIuId]").val()=='insert'){
			$(this).find("select[name=lrnGroupSn]").prepend("<option value='' selected>선택</option>");
		}
	});	
	
	fnApplySelectLabel();
}


function fnLrnMngSave() {
	var returnNow = true;
	
	$("#lrn_data_table tbody tr").each(function (){
		var tr = $(this);
		if ($.isNumeric(tr.find("input[name=lrnSn]").val())) {
			if (tr.find("select[name=lrnGroupSn] option:selected").val() == '') {
				alert("학습 그룹명은 필수 선택 항목입니다.");
				returnNow = false;
				return false;
			}
			
			if (!(tr.find("input[name=lrnNm]").val()) || tr.find("input[name=lrnNm]").val() == "") {
				alert("학습명은 필수 입력 항목입니다.");
				tr.find("input[name=lrnNm]").focus();
				returnNow = false;
				return false;
			}
		}
	});
	
	if (returnNow) {
		var flag = confirm("저장하시겠습니까?");
		if (flag == true) {
			var lrnMngList = new Array(); 
			
			$("#lrn_data_table tbody tr").each(function (){
				
				var tr = $(this);
				//if (tr.find("input[name=lrnNm]").val() == "#{lrnNm}") return;
				
				var lrnMngObject = new Object();
				lrnMngObject.lrnSn = tr.find("input[name=lrnSn]").val();
				lrnMngObject.lrnGroupSn = tr.find("select[name=lrnGroupSn] option:selected").val();
				lrnMngObject.lrnNm = tr.find("input[name=lrnNm]").val();		
				lrnMngObject.iuId = tr.find("input[name=lrnMngIuId]").val();
				lrnMngObject.lrnDc = tr.find("input[name=lrnDc]").val();
				if ($.isNumeric(lrnMngObject.lrnSn)) {
					lrnMngList[lrnMngList.length] = lrnMngObject;
				}
			});

			$.ajax({
				url: "/json/learning/saveLearningInfo"
				, method : "POST"
				, contentType: 'application/json'
				, data: JSON.stringify({		
					lrnMngList: lrnMngList
				})
				, success: function(data){
					if (data.resultCd == "OK") {
						alert("저장되었습니다.");
						location.reload();
					}
				}
				, error: function(data) {
					console.log(data);
				}
			});
		}
	}
}


function fnLrnMngDelete(lrnSn) {
	
	var flag = confirm("삭제하시겠습니까?");
	if (flag == true) {
		
		$("input[value=" + lrnSn + "]").closest('tr').remove();
		
		$.ajax({
			url: "/json/learning/rmvLearningInfo"
			, method : "POST"
			, contentType: 'application/json'
			, data: JSON.stringify({lrnSn: lrnSn})
			, success: function(data){
				if (data.resultCd == "OK") {
					alert("삭제되었습니다.");
				}
			}
			, error: function(data) {
				console.log(data);
			}
		});
	}
}



</script>
</body>
</html>