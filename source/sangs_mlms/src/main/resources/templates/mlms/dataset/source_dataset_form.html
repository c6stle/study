<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/mainLayout">
<head>
	<!-- head inclue -->
	<th:block th:replace="fragments/head_inc :: head_inc" />
		
</head>
<body>
    <!-- wrap -->
    <div id="wrap">
        <!-- container -->
		<div class="container">
            <!-- content -->
			<div id="content">

                <div class="page_info_area">
                    <div class="left">
                        <div class="location_area">
                            <a href="#" class="bookmark active" title="즐겨찾기"></a>
                            <ul>
                                <li>홈</li>
                                <li>데이터관리</li>
								<li>원천데이터셋 관리</li>
								<li>원천데이터셋 상세(등록/수정)</li>
                            </ul>
                        </div>
                        <div class="title_area">
                            <p>원천데이터셋 상세</p>
                            <a href="#" class="reload_btn" title="새로고침">새로고침</a>
                            <a href="#" class="help_btn" title="도움말">도움말</a>
                        </div>
                    </div>
                    <div class="right">
                        <div class="button_area">
                            <button class="btn" title="다운로드" id="dataDownBtn" onclick="fnCommFileDown('DATASET', $('#datasetSn').val());">다운로드</button>
                            <button class="btn" title="저장" onclick="fnSaveSrcDataInfo(); return false;">저장</button>
                            <button class="btn" title="삭제" id="deleteBtn" onclick="fnDelSrcData(); return false;">삭제</button>
                        </div>
                    </div>
                </div>
				
				<form name="masterForm">
				<input type="hidden" th:value="${datasetInfo.datasetSn}" id="datasetSn" />
				<input type="hidden" th:value="${datasetInfo.pmode}" id="pmode" />
				<div class="content_area">
                    <div class="division20">
                        <div class="search_wrap" id="top_menu">
                            <table class="search fixed">
                                <colgroup>
                                    <col style="width: 110px;" />
                                    <col style="width: auto;" />
                                    <col style="width: 60px;" />
                                    <col style="width: 110px" />
                                    <col style="width: auto;" />
                                    <col style="width: 60px;" />
                                    <col style="width: 110px" />
                                    <col style="width: auto;" />
                                </colgroup>
                                <tbody>
                                    <tr>
                                        <th scope="row"><label for="datasetNm">*원천데이터셋명</label></th>
                                        <td><input type="text" class="in_w100" id="datasetNm" name="datasetNm" th:value="${datasetInfo.datasetNm}"></td>
                                        <td></td>
 										<th scope="row"><label for="dataKbSize">데이터크기</label></th>
                                        <td>
                                        	<input type="text" class="in_w100" id="dataKbSize_view" name="dataKbSize_view" th:value="${datasetInfo.dataKbSize} + 'KB'" readonly/>
                                        	<input type="hidden" class="in_w100" id="dataKbSize" name="dataKbSize" th:value="${datasetInfo.dataKbSize}"/>
                                        </td>
                                        <td></td>
                                        <th scope="row"><label for="datasetLayout">데이터셋 Layout</label></th>
                                    	<td>
                                    		<input type="text" class="in_w100" id="datasetLayout" name="datasetLayout" th:value="${datasetInfo.dataRowCnt} + ' rows * ' + ${datasetInfo.dataColCnt} + ' cols'" readonly/>
                                    		<input type="hidden" id="previewSize" name="previewSize" th:value="${previewSize}" />
                                    		<input type="hidden" id="dataRowCnt" name="dataRowCnt" th:value="${datasetInfo.dataRowCnt}" />
                                    		<input type="hidden" id="dataColCnt" name="dataColCnt" th:value="${datasetInfo.dataColCnt}" />
                                    	</td>
                                    </tr>
                                    <tr>
                                    	<th scope="row"><label for="dataOrginlFlpth">파일명</label></th>
                                    	<td>
                                    		<input type="text" class="in_w100" id="dataOrginlFlpth" name="dataOrginlFlpth" th:value="${datasetInfo.dataOrginlFlpth}" readonly />
                                    	</td>
                                    	<td></td>
                                        <th scope="row"><label for="dataFlpth">물리파일경로</label></th>
                                        <td>
                                        	<input type="text" class="in_w100" id="dataFlpth" name="dataFlpth" th:value="${datasetInfo.dataFlpth}" readonly/>
                                        </td>
                                        <td></td>
                                    	<th scope="row"><label for="regDt">등록일시(아이디)</label></th>
                                    	<td><input type="text" class="in_w100" id="regDt" name="regDt" th:value="${datasetInfo.regDt} + ' (' + ${datasetInfo.regUserId} + ')'" readonly/></td>
                                    </tr>
                                    <tr>
                                    	<th><label for="datasetDc">데이터셋설명</label></th>
                                    	<td colspan="7"><input type="text" class="in_w100" id="datasetDc" name="datasetDc" th:value="${datasetInfo.datasetDc}" /></td>
                                    	
                                    </tr>
                                    <tr>
                                    	<th><label for="dataOriginDc">데이터출처설명</label></th>
                                    	<td colspan="7"><input type="text" class="in_w100" id="dataOriginDc" name="dataOriginDc" th:value="${datasetInfo.dataOriginDc}" /></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    
					
					<div class="tbl_top" style="width:100%;">
                    	<p class="tit v2" id="tb_data_table_title"></p>
                    </div>
					
                    <div class="search_wrap" id="filter_menu">
                        <table class="search fixed">
                        	<colgroup>
                        		<col style="width: 110px;" />
                                <col style="width: 350px;" />
                                <col style="width: auto;" />
                        	</colgroup>
							<tbody>
								<tr>
									<th><label for="selectFilter">데이터 필터</label></th>
                            		<td width="35%">
                            			<div class="selectbox">
	                            			<select id="selectFilter" name="selectFilter">
			                					<option value="">필터 없음</option>
			                					<option th:each="headerVal, index : ${headerList}" th:value="'col_' + ${index.index}" th:text="${headerVal}"></option>
			                				</select>
			                				<label>필터 없음</label>
		                				 </div>
                            		</td>
                            		<td width="30px"></td>
                            		<td>
                            			<input type="text" class="in_w100" id="searchFilter" name="searchFilter" onchange="onChangeFilter()" readonly />
                            		</td>
								</tr>
							</tbody>
						</table>
					</div>
					
                     
                                       
                    <div class="division margint8">
	                    <div style="overflow:auto; width:100%; min-height:200px;" class="table_area" id="tb_data_table_div">
	                    	
	                    	<div class="popup layer" id="modal_preview" style="width:250px; border:2px solid #324266; border-radius:5px">

								<div class="pop_content" id="previewContent" style="text-align:center;">
									<br><br>
								</div>
								<div class="pop_footer">
									<button class="btn sm bg_navy txt_white" onclick="fnExit('modal_preview'); return false;">확인</button>
								</div>		
							</div>
	                    	
	                        <table style="word-break:keep-all; width:calc(100% - 1px);" class="list" id="tb_data_table" >
				                <thead>
									<tr>
										<th style="min-width:120px;" scope="row" th:each="headerVal, index : ${headerList}" th:text="${headerVal}" th:name="'col_' + ${index.index}"></th>
									</tr>
								</thead>
								<tbody>
									<th:block th:each="bodyRow, index : ${bodyList}">
									<tr>
										<td th:each="headerVal : ${headerList}" th:text="${bodyRow.get(headerVal)}"></td>
									</tr>
									</th:block>
								</tbody>
	                        </table>
	                    </div>
	                </div>
				</div>
				</form>
            </div>
            <!--// content -->
        </div>
        <!--// container -->
    </div>
    <!--// wrap -->
    
    
<script type="text/javascript">

$(document).ready(function() {
	
	$("#selectFilter").change(function() {
		if ($("select[name=selectFilter] option:selected").val() == "") {
			
			$("#searchFilter").val("");
			$("#searchFilter").attr("readonly", true);
			
			var value = "";
			$("#tb_data_table tbody tr").filter(function() {
				$(this).toggle($(this).find().text().toLowerCase().indexOf(value) > -1);
			});
			
			
		} else {
			
			$("#searchFilter").attr("readonly", false);
			
			var searchCol = $("select[name=selectFilter] option:selected").val();
			var searchColIdx = $("#tb_data_table thead tr th[name=" + searchCol + "]").index();
			
			$("#searchFilter").on("keyup", function() {
				if(event.keyCode == 13) {
					var value = $(this).val().toLowerCase();
					$("#tb_data_table tbody tr").filter(function() {
						$(this).toggle($(this).find("td:eq(" + searchColIdx + ")").text().toLowerCase().indexOf(value) > -1);
					});
				}
			});
			
		}
		
	});
	
	
	if ($("#pmode").val() == "R") {
		$("#dataDownBtn").hide();
	}
	
	
	setTableHeight();
	$(parent.window).on("resize", function() {
		setTableHeight();
	});
	
	
	if ($("#dataRowCnt").val() > 1000) {
		$("#modal_preview").addClass('on');
		$("#modal_preview").css({
			"position":"absolute",
			"top":Math.max(0, (($(parent.window).height() - $("#modal_preview").outerHeight()) / 2)) + 100 + "px",
			"left":Math.max(0, (($(window).width() - $("#modal_preview").outerWidth()) / 2)) + "px"
		});
		var text = "미리보기 데이터 " + $("#previewSize").val() + "건 입니다.";
		$("#previewContent").append(text);
	}
	
});



function fnExit(modalId) {
	fnCloseModal(modalId);
} 



function setTableHeight() {
	var frame = parent.getMainClientHeight();
	var pageInfo = $(".page_info_area").height();
	var topMenu = $("#top_menu").height();
	var filter = $("#filter_menu").height();
	//console.log(frame-pageInfo-topMenu-filter-103);
	$("#tb_data_table_div").css("height", frame-pageInfo-topMenu-filter-201 + "px");
	parent.setFrameHeight();
}


function onChangeFilter() {
	var searchCol = $("select[name=selectFilter] option:selected").val();
	var searchColIdx = $("#tb_data_table thead tr th[name=" + searchCol + "]").index();
	var value = $("#searchFilter").val().toLowerCase();
	$("#tb_data_table tbody tr").filter(function() {
		$(this).toggle($(this).find("td:eq(" + searchColIdx + ")").text().toLowerCase().indexOf(value) > -1);
	});
}



function fnSaveSrcDataInfo() {
	
	if(!fnCheckValid("#datasetNm", "데이터셋 명")) return;
	
	var flag = confirm("저장하시겠습니까?");
	if (flag == true) {
		$.ajax({
			url: "/json/dataset/saveSourceDatasetInfo"
			, method : "POST"
			, contentType: 'application/json'
			, data: JSON.stringify({
				datasetSn: $("#datasetSn").val()
				, datasetNm: $("#datasetNm").val()
				, dataKbSize: $("#dataKbSize").val()
				, dataColCnt: $("#dataColCnt").val()
				, dataRowCnt: $("#dataRowCnt").val()
				, dataFlpth: $("#dataFlpth").val()
				, dataOrginlFlpth: $("#dataOrginlFlpth").val()
				, datasetDc: $("#datasetDc").val()
				, dataOriginDc: $("#dataOriginDc").val()
				, pmode: $("#pmode").val()
			})
			, success: function(data){
				if (data.resultCd == "OK") {
					alert("저장되었습니다.");
					location.href = '/open/mlms/dataset/source_dataset_list';
				}
			}
			, error: function(data) {
				console.log(data);
			}
		});
	}
}



function fnDelSrcData() {
	
	// 신규등록 화면에서 삭제버튼 클릭시 취소하고 목록으로 되돌아감
	if ($("#pmode").val() == "R") {
		var flag = confirm("삭제하시겠습니까?");
		if (flag == true) {			
			location.href = '/open/mlms/dataset/source_dataset_list';
		}
		return;
	}
	
	// 원천데이터 상세화면에서 삭제버튼 클릭시
	$("#pmode").val("D");
	
	var flag = confirm("삭제하시겠습니까?");
	if (flag == true) {
		$.ajax({
			url: "/json/dataset/saveSourceDatasetInfo"
			, method : "POST"
			, contentType: 'application/json'
			, data: JSON.stringify({
				datasetSn: $("#datasetSn").val()
				, datasetNm: $("#datasetNm").val()
				, dataKbSize: $("#dataKbSize").val()
				, dataColCnt: $("#dataColCnt").val()
				, dataRowCnt: $("#dataRowCnt").val()
				, dataFlpth: $("#dataFlpth").val()
				, dataOrginlFlpth: $("#dataOrginlFlpth").val()
				, datasetDc: $("#datasetDc").val()
				, dataOriginDc: $("#dataOriginDc").val()
				, pmode: $("#pmode").val()
			})
			, success: function(data){
				if (data.resultCd == "OK") {
					alert("삭제되었습니다.");
					location.href = '/open/mlms/dataset/source_dataset_list';
				}
			}
			, error: function(data) {
				console.log(data);
			}
		});
	}
	
}
	
</script>
</body>
</html>

