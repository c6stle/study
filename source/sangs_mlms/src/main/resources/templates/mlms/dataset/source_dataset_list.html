<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout/mainLayout">

<head>
	<th:block th:replace="fragments/head_inc :: head_inc" />
</head>

<body id="body">
    <div id="wrap">
		<div class="container">
			<div id="content">
                <div class="page_info_area">
                    <div class="left">
                        <div class="location_area">
                            <a href="#" class="bookmark active" title="즐겨찾기"></a>
                            <ul>
                                <li>홈</li>
                                <li>데이터관리</li>
								<li>원천데이터셋 관리</li>
                            </ul>
                        </div>
                        <div class="title_area">
                            <p>원천데이터셋 관리</p>
                            <a href="#" class="reload_btn" title="새로고침">새로고침</a>
                            <a href="#" class="help_btn" title="도움말">도움말</a>
                        </div>
                    </div>
                    <div class="right">
                        <div class="button_area">
                            <button class="btn" title="조회" onclick="fnSearch(); return false;">조회</button>
                            <button class="btn" title="신규등록" onclick="fnSrcDataRegist(); return false;">신규등록</button>
                        </div>
                    </div>
                </div>
                
				
				<div class="content_area">
                    <div class="division20">
                        <div class="search_wrap">
                            <table class="search fixed">
                                <colgroup>
                                    <col style="width: 100px;" />
                                    <col style="width: auto;" />
                                    <col style="width: 60px;" />
                                    <col style="width: 100px" />
                                    <col style="width: auto;" />
                                    <col style="width: 60px;" />
                                    <col style="width: 100px" />
                                    <col style="width: auto;" />
                                </colgroup>
                                <tbody>
                                    <tr>
                                        <th scope="row"><label for="datasetNm">원천데이터셋명</label></th>
                                        <td>
                                        	<input type="text" class="in_w100" id="datasetNm" name="datasetNm" />
                                        </td>
                                        <td></td>
 										<th scope="row"><label for="dataOrginlFlpth">파일명</label></th>
                                        <td>
											<input type="text" class="in_w100" id="dataOrginlFlpth" name="dataOrginlFlpth" />
                                        </td>
                                        <td></td>
                                        <th scope="row"><label for="regUserId">등록자 아이디</label></th>
                                        <td>
											<input type="text" class="in_w100" id="regUserId" name="regUserId" />
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="division">
		                <div class="table_area marginb25">
		                	<table class="list fixed" id="tb_data_table" >
		                		<colgroup>
		                			<col style="width: 60px;" />
		                			<col style="width: auto;" />
		                			<col style="width: auto;" />
		                			<col style="width: 80px;" />
		                			<col style="width: 80px;" />
		                			<col style="width: 80px" />
		                			<col style="width: 130px;" />
		                			<col style="width: 80px;" />
		                			<col style="width: 110px;" />
		                		</colgroup>
		                		<thead>
		                			<tr>
										<th>순번</th>
										<th>원천데이터셋명</th>
										<th>파일명</th>
										<th>컬럼수</th>
										<th>데이터수</th>
										<th>데이터 크기</th>
										<th>등록일시</th>
										<th>등록자<br>아이디</th>
										<th>상세보기</th>
									</tr>
								</thead>
								<tbody>
									<tr class="fwk_templete_row">
										<td>#{FWK_TR_NO_DESC}</td>
										<td class="alignl"><a href="#" onclick="fnOpenSrcDataDetail('#{datasetSn}'); return false;">#{datasetNm}</a></td>
										<td class="alignl">#{dataOrginlFlpth}</td>
										<td class="alignr">#fn{fnFormatNumber(#{dataColCnt})}</td>
										<td class="alignr">#fn{fnFormatNumber(#{dataRowCnt})}</td>
										<td class="alignr">#fn{fnFormatNumber(#{dataKbSize})}KB</td>
										<td>#fn{replaceAll('#{regDt}',' ', '<br/>')}</td>
										<td>#{regUserId}</td>
										<td>
											<button class="btn sm" onclick="fnViewDatasetPop('S', '#{datasetSn}'); return false;">상세보기</button>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					
						<div class="pagination_area marginb25" id="dv_paging"></div>
                    </div>
				</div>

            </div>
        </div>
    </div>



	<!-- 원천데이터 신규등록 레이어 팝업창 -->
	<div class="popup layer" id="modal_upl" style="width:650px;">
		<div class="pop_header">
			<p class="title">신규등록</p>
			<button class="btn_ic btn_pop_close" onclick="fnExit('modal_upl');">닫기</button>
		</div>

		<div class="pop_content">
			<form id="upl_masterForm" name="upl_masterForm">
				<div class="table_area margint30">
					<table class="view fixed">
						<colgroup>
							<col style="width: 120px;">
							<col style="width: auto;">
						</colgroup>
						<tbody>
							<tr>
								<th class="ta_c">파일</th>
								<td class="ta_l">
									<input type="text" id="upl_filePath" style="width:356px;" value="" readonly/>
									<label class="btn sm" for="upl_file">파일선택</label>
									<input type="file" id="upl_file" name="file" style="display: none;" />
								</td>
							</tr>
							<tr>
								<th class="ta_c">저장폴더</th>
								<td class="ta_l">
									<!-- name 변경 금지 -->
									<input type="hidden" name="basePathId" value="mls.resource.base_path" />
									<input type="hidden" id="subDir" name="subDir"/>
									<input type="text" id="subDirLow" name="subDirLow" style="width: 100%" />
									<input type="hidden" class="in_w100" id="upl_orgFileNm" name="fileNm">
								</td>
							</tr>

						</tbody>
					</table>
				</div>
			</form>
		</div>

		<div class="pop_footer">
			<p class="txt2">
				* 파일은 csv로 저장이 됩니다.<br> * 저장폴더를 입력시 저장폴더 하위로 파일이 관리됩니다.<br> &nbsp;&nbsp; 예) sample/train/
			</p>
			<br></br>
			<br></br>
			<button class="btn bg_navy txt_white" onclick="fnSummit(); return false;">확인</button>
		</div>

	</div>
	

    
<script type="text/javascript">

$(document).ready(function() {
	
	// java Constant 의 값을 가져온다. 
	fnGetMlmsConstantsVal("RESOURCE_DATASET_BASE_PATH", function(data) {
		$("#upl_masterForm").find("input[name=subDir]").val(data.value);
	});
	
	fnSearch();
	
	$("#datasetNm, #dataOrginlFlpth, #regUserId").on("keyup", function(event) {
		if(event.keyCode == 13) 
			fnSearch();
	});
	
	$("#upl_file").on("change", function() {
		if ($(this).val() != "") {
			$("#upl_filePath").val($("#upl_file")[0].files[0].name);
			$("#subDirLow").focus();
			$("#subDirLow")[0].setSelectionRange(0, 0);
		}
	});
	
	/*
	$('ul.tabs li').click(function(){
		var tab_id = $(this).attr('data-tab');

		$('ul.tabs li').removeClass('current'); 
		$('.tab-content').removeClass('current');

		$(this).addClass('current');
		$("#" + tab_id).addClass('current');
	})*/
	
});

function fnSearch(pageNum) {
	if(!pageNum) 
		pageNum = 1;
	
	$.ajax({
		url: "/json/dataset/getSourceDatasetList"
		, method : "POST"
		, contentType: 'application/json'
		, data: JSON.stringify({
			pageNum: pageNum
			, datasetNm: $("#datasetNm").val()
			, dataOrginlFlpth: $("#dataOrginlFlpth").val()
			, regUserId: $("#regUserId").val()
			, apiDataYn : "N"
		})
		, success: function(data){
			
			fnBindTableValue("tb_data_table", data.sourceDataList, data.pagingInfo);
			
			fnSetPaging("dv_paging", data.pagingInfo);
		}
	});
} 


function fnSrcDataRegist() {
	$("#upl_masterForm")[0].reset();
	fnShowModal("modal_upl");
}


// 원천데이터셋 상세(수정)
function fnOpenSrcDataDetail(datasetSn) {
	location.href = '/view/dataset/viewSourceDatasetForm?pmode=M&datasetSn=' + datasetSn;
}


// 원천데이터셋 상세(등록)
function fnSummit() {
	
	if ($("#upl_filePath").val() == "") {
		alert('파일이 선택되지 않았습니다.');
		return;
	}
	
	var subDirLow = $("#subDirLow").val();
	
	// 폴더명 입력 불가 패턴입력 return
	var special_pattern = /[|\\\\?*<\":>\s]/gi;
	var hangle_pattern = /[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/;
	if (special_pattern.test(subDirLow) || hangle_pattern.test(subDirLow)) {
		alert('폴더 명으로 한글, 공백 또는 다음 문자를 사용할 수 없습니다.\n \ / : * ? " < > | ');
		$("#subDirLow").focus();
		return;
	} 
	
	// 문자열 맨앞 '/'가 있는경우
	if (subDirLow.indexOf("/") == 0) {
		var subDirPre = subDirLow.split("/");
		subDirPre.shift();
		$("#subDirLow").val(subDirPre.join("/"));
	}
	// 문자열 맨뒤 '/'가 빠진경우
	subDirLow = $("#subDirLow").val();
	if (subDirLow.lastIndexOf("/") != subDirLow.length - 1) {
		var subDirPost = subDirLow.split("/");
		$("#subDirLow").val(subDirPost.join("/") + "/");
	}
	
	$("#subDir").val($("#subDir").val() + $("#subDirLow").val());
	fnCommSingleFileUpload("upl_masterForm", function(data) {
		location.href = '/view/dataset/viewSourceDatasetForm?pmode=R&basePathId=' + data.basePathId + '&savedFileNm=' + data.savedFileNm + '&subDir=' + data.subDir + '&orgFileNm=' + data.orgFileNm;
		//savedFileNm : 물리파일명
		//subDir : 하위폴더명
		//orgFileNm : 오리지널파일명
	});	
}


function fnExit(modalId) {
	fnCloseModal(modalId);
}

 
</script>
</body>
</html>