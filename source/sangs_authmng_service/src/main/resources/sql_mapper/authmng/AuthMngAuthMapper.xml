<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="authMngAuth">

	<!-- dbms별 공통 insert query -->
	<sql id="common_insert_query">
		<choose>
			<when test = "APP_DBMS_TYPE == 'MARIADB' or APP_DBMS_TYPE == 'MYSQL'">
				, #{regUserId}
				, NOW()
				, #{regUserId}
				, NOW()
			</when>
			<otherwise>
				, #{regUserId}
				, SYSDATE
				, #{regUserId}
				, SYSDATE
			</otherwise>
		</choose>	
	</sql>
	
	<!-- dbms별 공통 insert query -->
	<sql id="common_insert_register_query">
		<choose>
			<when test = "APP_DBMS_TYPE == 'MARIADB' or APP_DBMS_TYPE == 'MYSQL'">
				, #{regUserId}
				, NOW()
			</when>
			<otherwise>
				, #{regUserId}
				, SYSDATE
			</otherwise>
		</choose>	
	</sql>
	
	<!-- dbms별 공통 update query -->
	<sql id="common_update_query">
		<if test="APP_DBMS_TYPE != '' and APP_DBMS_TYPE != null ">
			<choose>
				<when test = "APP_DBMS_TYPE == 'MARIADB' or APP_DBMS_TYPE == 'MYSQL'">
					, CHG_USER_ID = #{regUserId}
					, CHG_DT = NOW()
				</when>
				<otherwise>
					, CHG_USER_ID = #{regUserId}
					, CHG_DT = SYSDATE
				</otherwise>
			</choose>
		</if>
	</sql>
 
	<!-- 전체 권한 목록 -->
	<select id="selectAuthorList" resultType="sangsMap" parameterType="map">
		SELECT 
			AUTHRT_CD, AUTHRT_NM, AUTHRT_CN, USE_YN, REG_USER_ID, REG_DT, CHG_USER_ID, CHG_DT
			, AUTHRT_CD AS CODE
			, AUTHRT_NM AS CODE_NM
		FROM CMMN_MNGR_AUTHOR
		WHERE 1=1
			AND USE_YN = 'Y'
	</select>

	<!-- 권한 별 사용자 목록 -->
	<select id="selectAuthorUserList" resultType="sangsMap" parameterType="map">
		SELECT 
			T1.USER_ID 
			, T1.USER_NM
			, T1.USE_YN 
			, T2.AUTHRT_CD 
			, T3.AUTHRT_NM 
			, T3.AUTHRT_CN 
		FROM 
			CMMN_MNGR T1 
			LEFT OUTER JOIN CMMN_MNGR_AUTHOR_DTL T2 ON T1.USER_ID = T2.USER_ID 
			LEFT OUTER JOIN CMMN_MNGR_AUTHOR T3 ON T2.AUTHRT_CD = T3.AUTHRT_CD 
		WHERE 1=1
			AND T1.USE_YN = 'Y'
			AND T3.USE_YN = 'Y'
			<if test="userNm != '' and userNm != null ">
				AND T1.USER_NM LIKE CONCAT('%', #{userNm}, '%')
			</if>
			<if test="authrtCd != '' and authrtCd != null ">
				AND T2.AUTHRT_CD = #{authrtCd}
			</if>
			ORDER BY T1.REG_DT DESC
	</select>

	<!-- 권한 항목 코드 목록 조회 -->
	<select id="selectAuthorIemCodeList" resultType="com.sangs.lib.support.domain.SangsMap" parameterType="map">
		SELECT 
			MENU_AUTHRT_CD AS CODE
			, MENU_AUTHRT_NM AS CODE_NM
		FROM CMMN_MENU_AUTHOR_IEM
		WHERE 1=1
			AND DEL_YN = 'N'
		ORDER BY SORT_SN
	</select>
	
	<!-- 권한별  메뉴 항목 목록 삭제 -->
	<delete id="deleteMenuAuthorDetailList" parameterType="map">
		DELETE FROM CMMN_MENU_AUTHOR_DTL
		WHERE AUTHRT_CD = #{authrtCd}
	</delete>
	
	<!-- 권한별 사용자 추가 권한 목록 삭제 -->
	<delete id="deleteMenuUserAditAuthorList" parameterType="map">
		DELETE FROM CMMN_MENU_AUTHOR_DTL_USER
		WHERE AUTHRT_CD = #{authrtCd}
			AND USER_ID = #{userId}
	</delete>
	
	<!-- 권한별  메뉴 항목 저장 -->
	<insert id="insertMenuAuthorDetailInfo" parameterType="map">
		INSERT INTO CMMN_MENU_AUTHOR_DTL (
			AUTHRT_CD
			, MENU_SN
			, MENU_AUTHRT_CD
			, REG_USER_ID
			, REG_DT
		) VALUES (
			#{authrtCd}
			, #{menuSn}
			, #{menuAuthrtCd}
			<include refid="common_insert_register_query" />
		)
	</insert>
	
	<!-- 권한별  메뉴 항목 저장 -->
	<insert id="insertMenuUserAditAuthorInfo" parameterType="map">
		INSERT INTO CMMN_MENU_AUTHOR_DTL_USER (
			AUTHRT_CD
			, MENU_SN
			, MENU_AUTHRT_CD
			, USER_ID
			, REG_USER_ID
			, REG_DT
		) VALUES (
			#{authrtCd}
			, #{menuSn}
			, #{menuAuthrtCd}
			, #{userId}
			<include refid="common_insert_register_query" />
		)
	</insert>
	
	<!-- 관리자 권한 정보 저장 -->
	<insert id="insertMngrAuthorInfo" parameterType="map">
		INSERT INTO CMMN_MNGR_AUTHOR_DTL (
			AUTHRT_CD
			, USER_ID
			, REG_USER_ID
			, REG_DT
			, CHG_USER_ID
			, CHG_DT
		) VALUES (
			#{authrtCd}
			, #{userId}
			<include refid="common_insert_query" />
		)
	</insert>
	
	<!-- 사용자 권한 정보 저장 -->
	<insert id="insertUserAuthorInfo" parameterType="map">
		INSERT INTO CMMN_USER_AUTHOR (
			AUTHRT_CD
			, USER_ID
			, REG_USER_ID
			, REG_DT
			, CHG_USER_ID
			, CHG_DT
		) VALUES (
			#{authrtCd}
			, #{userId}
			<include refid="common_insert_query" />
		)
	</insert>
	
 
  
 
	
</mapper>  